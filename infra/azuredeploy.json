{
  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "metadata": {
    "_generator": {
      "name": "bicep",
      "version": "0.39.26.7824",
      "templateHash": "16499477310314493515"
    }
  },
  "parameters": {
    "appName": {
      "type": "string",
      "minLength": 3,
      "maxLength": 20,
      "metadata": {
        "description": "Base name for all resources. Must be unique."
      }
    },
    "location": {
      "type": "string",
      "defaultValue": "[resourceGroup().location]",
      "metadata": {
        "description": "Azure region for all resources."
      }
    },
    "adminEmail": {
      "type": "string",
      "metadata": {
        "description": "Email of the first admin user."
      }
    },
    "functionAppSku": {
      "type": "string",
      "defaultValue": "FC1",
      "allowedValues": [
        "FC1",
        "Y1",
        "EP1",
        "EP2",
        "EP3"
      ],
      "metadata": {
        "description": "SKU for the Function Apps hosting plan.\n\nAvailable options:\n- FC1: Flex Consumption (RECOMMENDED) - Serverless, VNet integration, fast cold starts, ~$0-10/month\n- Y1:  Consumption (Legacy) - Serverless, NO VNet support, EOL September 2028, ~$0-5/month\n- EP1: Premium - Reserved instances, VNet support, no cold starts, ~$150/month\n- EP2: Premium - Higher performance, VNet support, ~$300/month\n- EP3: Premium - Maximum performance, VNet support, ~$600/month\n\nIMPORTANT: If you need to connect to databases in Azure Virtual Networks (Private Endpoints),\nyou MUST use FC1 (Flex Consumption) or EP1/EP2/EP3 (Premium). Y1 does NOT support VNet integration.\n"
      }
    },
    "enableAppInsights": {
      "type": "bool",
      "defaultValue": true,
      "metadata": {
        "description": "Enable Application Insights."
      }
    },
    "appVersion": {
      "type": "string",
      "defaultValue": "latest",
      "metadata": {
        "description": "Version to deploy (\"latest\" for most recent release, or specific tag like \"v1.0.0\")"
      }
    },
    "skipAppRegistration": {
      "type": "bool",
      "defaultValue": false,
      "metadata": {
        "description": "Skip App Registration creation (for manual setup)"
      }
    },
    "azureAdClientId": {
      "type": "string",
      "defaultValue": "",
      "metadata": {
        "description": "Existing Azure AD Client ID (if provided, skips App Registration creation)"
      }
    }
  },
  "variables": {
    "uniqueSuffix": "[uniqueString(resourceGroup().id, parameters('appName'))]",
    "shortSuffix": "[take(variables('uniqueSuffix'), 6)]",
    "storageAccountName": "[toLower(format('{0}st{1}', take(parameters('appName'), 10), variables('uniqueSuffix')))]",
    "keyVaultName": "[format('{0}-kv-{1}', parameters('appName'), take(variables('uniqueSuffix'), 8))]",
    "functionAppApiName": "[format('{0}-{1}-api', parameters('appName'), variables('shortSuffix'))]",
    "functionAppSchedulerName": "[format('{0}-{1}-scheduler', parameters('appName'), variables('shortSuffix'))]",
    "functionAppProcessorName": "[format('{0}-{1}-processor', parameters('appName'), variables('shortSuffix'))]",
    "appInsightsName": "[format('{0}-insights', parameters('appName'))]",
    "appServicePlanName": "[format('{0}-plan', parameters('appName'))]",
    "deploymentIdentityName": "[format('{0}-deploy-identity', parameters('appName'))]",
    "installationId": "[variables('uniqueSuffix')]",
    "tenantId": "[subscription().tenantId]",
    "isFlexConsumption": "[equals(parameters('functionAppSku'), 'FC1')]",
    "tags": {
      "Application": "Dilux Database Backup",
      "Environment": "Production",
      "ManagedBy": "Bicep",
      "Version": "[parameters('appVersion')]"
    },
    "readerRoleId": "acdd72a7-3385-48ef-bd42-f606fba81ae7",
    "gitHubRepo": "pablodiloreto/dilux-azure-databases-backup-alpha",
    "gitHubReleaseUrl": "[format('https://github.com/{0}/releases/download/{1}', variables('gitHubRepo'), parameters('appVersion'))]"
  },
  "resources": [
    {
      "type": "Microsoft.Authorization/roleAssignments",
      "apiVersion": "2022-04-01",
      "name": "[guid(resourceGroup().id, variables('functionAppApiName'), variables('readerRoleId'), 'vnet-status')]",
      "properties": {
        "roleDefinitionId": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', variables('readerRoleId'))]",
        "principalId": "[reference(resourceId('Microsoft.Resources/deployments', 'functionapp-api-deployment'), '2025-04-01').outputs.principalId.value]",
        "principalType": "ServicePrincipal"
      },
      "dependsOn": [
        "[resourceId('Microsoft.Resources/deployments', 'functionapp-api-deployment')]"
      ]
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "storage-deployment",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "storageAccountName": {
            "value": "[variables('storageAccountName')]"
          },
          "location": {
            "value": "[parameters('location')]"
          },
          "tags": {
            "value": "[variables('tags')]"
          },
          "isFlexConsumption": {
            "value": "[variables('isFlexConsumption')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.39.26.7824",
              "templateHash": "3604417202173189035"
            }
          },
          "parameters": {
            "storageAccountName": {
              "type": "string",
              "metadata": {
                "description": "Name of the storage account"
              }
            },
            "location": {
              "type": "string",
              "metadata": {
                "description": "Azure region"
              }
            },
            "tags": {
              "type": "object",
              "metadata": {
                "description": "Tags to apply"
              }
            },
            "isFlexConsumption": {
              "type": "bool",
              "defaultValue": false,
              "metadata": {
                "description": "Is Flex Consumption plan (requires deployment containers)"
              }
            }
          },
          "resources": [
            {
              "type": "Microsoft.Storage/storageAccounts",
              "apiVersion": "2023-01-01",
              "name": "[parameters('storageAccountName')]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]",
              "sku": {
                "name": "Standard_LRS"
              },
              "kind": "StorageV2",
              "properties": {
                "accessTier": "Hot",
                "supportsHttpsTrafficOnly": true,
                "minimumTlsVersion": "TLS1_2",
                "allowBlobPublicAccess": true,
                "networkAcls": {
                  "defaultAction": "Allow",
                  "bypass": "AzureServices"
                }
              }
            },
            {
              "type": "Microsoft.Storage/storageAccounts/blobServices",
              "apiVersion": "2023-01-01",
              "name": "[format('{0}/{1}', parameters('storageAccountName'), 'default')]",
              "properties": {
                "deleteRetentionPolicy": {
                  "enabled": true,
                  "days": 7
                }
              },
              "dependsOn": [
                "[resourceId('Microsoft.Storage/storageAccounts', parameters('storageAccountName'))]"
              ]
            },
            {
              "type": "Microsoft.Storage/storageAccounts/blobServices/containers",
              "apiVersion": "2023-01-01",
              "name": "[format('{0}/{1}/{2}', parameters('storageAccountName'), 'default', 'backups')]",
              "properties": {
                "publicAccess": "None"
              },
              "dependsOn": [
                "[resourceId('Microsoft.Storage/storageAccounts/blobServices', parameters('storageAccountName'), 'default')]"
              ]
            },
            {
              "condition": "[parameters('isFlexConsumption')]",
              "type": "Microsoft.Storage/storageAccounts/blobServices/containers",
              "apiVersion": "2023-01-01",
              "name": "[format('{0}/{1}/{2}', parameters('storageAccountName'), 'default', 'deployments-api')]",
              "properties": {
                "publicAccess": "None"
              },
              "dependsOn": [
                "[resourceId('Microsoft.Storage/storageAccounts/blobServices', parameters('storageAccountName'), 'default')]"
              ]
            },
            {
              "condition": "[parameters('isFlexConsumption')]",
              "type": "Microsoft.Storage/storageAccounts/blobServices/containers",
              "apiVersion": "2023-01-01",
              "name": "[format('{0}/{1}/{2}', parameters('storageAccountName'), 'default', 'deployments-scheduler')]",
              "properties": {
                "publicAccess": "None"
              },
              "dependsOn": [
                "[resourceId('Microsoft.Storage/storageAccounts/blobServices', parameters('storageAccountName'), 'default')]"
              ]
            },
            {
              "condition": "[parameters('isFlexConsumption')]",
              "type": "Microsoft.Storage/storageAccounts/blobServices/containers",
              "apiVersion": "2023-01-01",
              "name": "[format('{0}/{1}/{2}', parameters('storageAccountName'), 'default', 'deployments-processor')]",
              "properties": {
                "publicAccess": "None"
              },
              "dependsOn": [
                "[resourceId('Microsoft.Storage/storageAccounts/blobServices', parameters('storageAccountName'), 'default')]"
              ]
            },
            {
              "condition": "[parameters('isFlexConsumption')]",
              "type": "Microsoft.Storage/storageAccounts/blobServices/containers",
              "apiVersion": "2023-01-01",
              "name": "[format('{0}/{1}/{2}', parameters('storageAccountName'), 'default', 'function-packages')]",
              "properties": {
                "publicAccess": "None"
              },
              "dependsOn": [
                "[resourceId('Microsoft.Storage/storageAccounts/blobServices', parameters('storageAccountName'), 'default')]"
              ]
            },
            {
              "type": "Microsoft.Storage/storageAccounts/queueServices",
              "apiVersion": "2023-01-01",
              "name": "[format('{0}/{1}', parameters('storageAccountName'), 'default')]",
              "dependsOn": [
                "[resourceId('Microsoft.Storage/storageAccounts', parameters('storageAccountName'))]"
              ]
            },
            {
              "type": "Microsoft.Storage/storageAccounts/queueServices/queues",
              "apiVersion": "2023-01-01",
              "name": "[format('{0}/{1}/{2}', parameters('storageAccountName'), 'default', 'backup-jobs')]",
              "dependsOn": [
                "[resourceId('Microsoft.Storage/storageAccounts/queueServices', parameters('storageAccountName'), 'default')]"
              ]
            },
            {
              "type": "Microsoft.Storage/storageAccounts/tableServices",
              "apiVersion": "2023-01-01",
              "name": "[format('{0}/{1}', parameters('storageAccountName'), 'default')]",
              "dependsOn": [
                "[resourceId('Microsoft.Storage/storageAccounts', parameters('storageAccountName'))]"
              ]
            },
            {
              "type": "Microsoft.Storage/storageAccounts/tableServices/tables",
              "apiVersion": "2023-01-01",
              "name": "[format('{0}/{1}/{2}', parameters('storageAccountName'), 'default', 'databaseconfigs')]",
              "dependsOn": [
                "[resourceId('Microsoft.Storage/storageAccounts/tableServices', parameters('storageAccountName'), 'default')]"
              ]
            },
            {
              "type": "Microsoft.Storage/storageAccounts/tableServices/tables",
              "apiVersion": "2023-01-01",
              "name": "[format('{0}/{1}/{2}', parameters('storageAccountName'), 'default', 'backuphistory')]",
              "dependsOn": [
                "[resourceId('Microsoft.Storage/storageAccounts/tableServices', parameters('storageAccountName'), 'default')]"
              ]
            },
            {
              "type": "Microsoft.Storage/storageAccounts/tableServices/tables",
              "apiVersion": "2023-01-01",
              "name": "[format('{0}/{1}/{2}', parameters('storageAccountName'), 'default', 'auditlogs')]",
              "dependsOn": [
                "[resourceId('Microsoft.Storage/storageAccounts/tableServices', parameters('storageAccountName'), 'default')]"
              ]
            },
            {
              "type": "Microsoft.Storage/storageAccounts/tableServices/tables",
              "apiVersion": "2023-01-01",
              "name": "[format('{0}/{1}/{2}', parameters('storageAccountName'), 'default', 'users')]",
              "dependsOn": [
                "[resourceId('Microsoft.Storage/storageAccounts/tableServices', parameters('storageAccountName'), 'default')]"
              ]
            },
            {
              "type": "Microsoft.Storage/storageAccounts/tableServices/tables",
              "apiVersion": "2023-01-01",
              "name": "[format('{0}/{1}/{2}', parameters('storageAccountName'), 'default', 'settings')]",
              "dependsOn": [
                "[resourceId('Microsoft.Storage/storageAccounts/tableServices', parameters('storageAccountName'), 'default')]"
              ]
            },
            {
              "type": "Microsoft.Storage/storageAccounts/tableServices/tables",
              "apiVersion": "2023-01-01",
              "name": "[format('{0}/{1}/{2}', parameters('storageAccountName'), 'default', 'accessrequests')]",
              "dependsOn": [
                "[resourceId('Microsoft.Storage/storageAccounts/tableServices', parameters('storageAccountName'), 'default')]"
              ]
            },
            {
              "type": "Microsoft.Storage/storageAccounts/tableServices/tables",
              "apiVersion": "2023-01-01",
              "name": "[format('{0}/{1}/{2}', parameters('storageAccountName'), 'default', 'backuppolicies')]",
              "dependsOn": [
                "[resourceId('Microsoft.Storage/storageAccounts/tableServices', parameters('storageAccountName'), 'default')]"
              ]
            }
          ],
          "outputs": {
            "storageAccountName": {
              "type": "string",
              "metadata": {
                "description": "Storage account name"
              },
              "value": "[parameters('storageAccountName')]"
            },
            "storageAccountId": {
              "type": "string",
              "metadata": {
                "description": "Storage account resource ID"
              },
              "value": "[resourceId('Microsoft.Storage/storageAccounts', parameters('storageAccountName'))]"
            },
            "storageAccountKey": {
              "type": "string",
              "metadata": {
                "description": "Storage account primary key"
              },
              "value": "[listKeys(resourceId('Microsoft.Storage/storageAccounts', parameters('storageAccountName')), '2023-01-01').keys[0].value]"
            },
            "connectionString": {
              "type": "string",
              "metadata": {
                "description": "Storage account connection string"
              },
              "value": "[format('DefaultEndpointsProtocol=https;AccountName={0};AccountKey={1};EndpointSuffix={2}', parameters('storageAccountName'), listKeys(resourceId('Microsoft.Storage/storageAccounts', parameters('storageAccountName')), '2023-01-01').keys[0].value, environment().suffixes.storage)]"
            },
            "blobEndpoint": {
              "type": "string",
              "metadata": {
                "description": "Blob endpoint"
              },
              "value": "[reference(resourceId('Microsoft.Storage/storageAccounts', parameters('storageAccountName')), '2023-01-01').primaryEndpoints.blob]"
            },
            "queueEndpoint": {
              "type": "string",
              "metadata": {
                "description": "Queue endpoint"
              },
              "value": "[reference(resourceId('Microsoft.Storage/storageAccounts', parameters('storageAccountName')), '2023-01-01').primaryEndpoints.queue]"
            },
            "tableEndpoint": {
              "type": "string",
              "metadata": {
                "description": "Table endpoint"
              },
              "value": "[reference(resourceId('Microsoft.Storage/storageAccounts', parameters('storageAccountName')), '2023-01-01').primaryEndpoints.table]"
            }
          }
        }
      }
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "keyvault-deployment",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "keyVaultName": {
            "value": "[variables('keyVaultName')]"
          },
          "location": {
            "value": "[parameters('location')]"
          },
          "tags": {
            "value": "[variables('tags')]"
          },
          "tenantId": {
            "value": "[variables('tenantId')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.39.26.7824",
              "templateHash": "4101464948759302784"
            }
          },
          "parameters": {
            "keyVaultName": {
              "type": "string",
              "metadata": {
                "description": "Name of the Key Vault"
              }
            },
            "location": {
              "type": "string",
              "metadata": {
                "description": "Azure region"
              }
            },
            "tags": {
              "type": "object",
              "metadata": {
                "description": "Tags to apply"
              }
            },
            "tenantId": {
              "type": "string",
              "metadata": {
                "description": "Azure AD Tenant ID"
              }
            }
          },
          "resources": [
            {
              "type": "Microsoft.KeyVault/vaults",
              "apiVersion": "2023-07-01",
              "name": "[parameters('keyVaultName')]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]",
              "properties": {
                "tenantId": "[parameters('tenantId')]",
                "sku": {
                  "family": "A",
                  "name": "standard"
                },
                "enableRbacAuthorization": true,
                "enableSoftDelete": true,
                "softDeleteRetentionInDays": 7,
                "networkAcls": {
                  "defaultAction": "Allow",
                  "bypass": "AzureServices"
                }
              }
            }
          ],
          "outputs": {
            "keyVaultName": {
              "type": "string",
              "metadata": {
                "description": "Key Vault name"
              },
              "value": "[parameters('keyVaultName')]"
            },
            "keyVaultUri": {
              "type": "string",
              "metadata": {
                "description": "Key Vault URI"
              },
              "value": "[reference(resourceId('Microsoft.KeyVault/vaults', parameters('keyVaultName')), '2023-07-01').vaultUri]"
            },
            "keyVaultId": {
              "type": "string",
              "metadata": {
                "description": "Key Vault resource ID"
              },
              "value": "[resourceId('Microsoft.KeyVault/vaults', parameters('keyVaultName'))]"
            }
          }
        }
      }
    },
    {
      "condition": "[parameters('enableAppInsights')]",
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "appinsights-deployment",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "appInsightsName": {
            "value": "[variables('appInsightsName')]"
          },
          "location": {
            "value": "[parameters('location')]"
          },
          "tags": {
            "value": "[variables('tags')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.39.26.7824",
              "templateHash": "5630221161256163117"
            }
          },
          "parameters": {
            "appInsightsName": {
              "type": "string",
              "metadata": {
                "description": "Name of the Application Insights resource"
              }
            },
            "location": {
              "type": "string",
              "metadata": {
                "description": "Azure region"
              }
            },
            "tags": {
              "type": "object",
              "metadata": {
                "description": "Tags to apply"
              }
            }
          },
          "resources": [
            {
              "type": "Microsoft.OperationalInsights/workspaces",
              "apiVersion": "2022-10-01",
              "name": "[format('{0}-logs', parameters('appInsightsName'))]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]",
              "properties": {
                "sku": {
                  "name": "PerGB2018"
                },
                "retentionInDays": 30
              }
            },
            {
              "type": "Microsoft.Insights/components",
              "apiVersion": "2020-02-02",
              "name": "[parameters('appInsightsName')]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]",
              "kind": "web",
              "properties": {
                "Application_Type": "web",
                "WorkspaceResourceId": "[resourceId('Microsoft.OperationalInsights/workspaces', format('{0}-logs', parameters('appInsightsName')))]",
                "IngestionMode": "LogAnalytics",
                "publicNetworkAccessForIngestion": "Enabled",
                "publicNetworkAccessForQuery": "Enabled"
              },
              "dependsOn": [
                "[resourceId('Microsoft.OperationalInsights/workspaces', format('{0}-logs', parameters('appInsightsName')))]"
              ]
            }
          ],
          "outputs": {
            "appInsightsName": {
              "type": "string",
              "metadata": {
                "description": "Application Insights name"
              },
              "value": "[parameters('appInsightsName')]"
            },
            "instrumentationKey": {
              "type": "string",
              "metadata": {
                "description": "Application Insights instrumentation key"
              },
              "value": "[reference(resourceId('Microsoft.Insights/components', parameters('appInsightsName')), '2020-02-02').InstrumentationKey]"
            },
            "connectionString": {
              "type": "string",
              "metadata": {
                "description": "Application Insights connection string"
              },
              "value": "[reference(resourceId('Microsoft.Insights/components', parameters('appInsightsName')), '2020-02-02').ConnectionString]"
            },
            "logAnalyticsWorkspaceId": {
              "type": "string",
              "metadata": {
                "description": "Log Analytics Workspace ID"
              },
              "value": "[resourceId('Microsoft.OperationalInsights/workspaces', format('{0}-logs', parameters('appInsightsName')))]"
            }
          }
        }
      }
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "appserviceplan-api-deployment",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "planName": "[if(variables('isFlexConsumption'), createObject('value', format('{0}-api', variables('appServicePlanName'))), createObject('value', variables('appServicePlanName')))]",
          "location": {
            "value": "[parameters('location')]"
          },
          "tags": {
            "value": "[variables('tags')]"
          },
          "sku": {
            "value": "[parameters('functionAppSku')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.39.26.7824",
              "templateHash": "12452722508131605079"
            }
          },
          "parameters": {
            "planName": {
              "type": "string",
              "metadata": {
                "description": "Name of the App Service Plan"
              }
            },
            "location": {
              "type": "string",
              "metadata": {
                "description": "Azure region"
              }
            },
            "tags": {
              "type": "object",
              "metadata": {
                "description": "Tags to apply"
              }
            },
            "sku": {
              "type": "string",
              "defaultValue": "FC1",
              "allowedValues": [
                "FC1",
                "Y1",
                "EP1",
                "EP2",
                "EP3"
              ],
              "metadata": {
                "description": "SKU for the plan"
              }
            }
          },
          "variables": {
            "skuConfig": {
              "FC1": {
                "name": "FC1",
                "tier": "FlexConsumption"
              },
              "Y1": {
                "name": "Y1",
                "tier": "Dynamic"
              },
              "EP1": {
                "name": "EP1",
                "tier": "ElasticPremium"
              },
              "EP2": {
                "name": "EP2",
                "tier": "ElasticPremium"
              },
              "EP3": {
                "name": "EP3",
                "tier": "ElasticPremium"
              }
            },
            "isFlexConsumption": "[equals(parameters('sku'), 'FC1')]"
          },
          "resources": [
            {
              "type": "Microsoft.Web/serverfarms",
              "apiVersion": "2023-01-01",
              "name": "[parameters('planName')]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]",
              "sku": {
                "name": "[variables('skuConfig')[parameters('sku')].name]",
                "tier": "[variables('skuConfig')[parameters('sku')].tier]"
              },
              "properties": {
                "reserved": true
              }
            }
          ],
          "outputs": {
            "planId": {
              "type": "string",
              "metadata": {
                "description": "App Service Plan resource ID"
              },
              "value": "[resourceId('Microsoft.Web/serverfarms', parameters('planName'))]"
            },
            "planName": {
              "type": "string",
              "metadata": {
                "description": "App Service Plan name"
              },
              "value": "[parameters('planName')]"
            },
            "isFlexConsumption": {
              "type": "bool",
              "metadata": {
                "description": "Is Flex Consumption plan"
              },
              "value": "[variables('isFlexConsumption')]"
            },
            "skuTier": {
              "type": "string",
              "metadata": {
                "description": "SKU tier"
              },
              "value": "[variables('skuConfig')[parameters('sku')].tier]"
            }
          }
        }
      }
    },
    {
      "condition": "[variables('isFlexConsumption')]",
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "appserviceplan-scheduler-deployment",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "planName": {
            "value": "[format('{0}-scheduler', variables('appServicePlanName'))]"
          },
          "location": {
            "value": "[parameters('location')]"
          },
          "tags": {
            "value": "[variables('tags')]"
          },
          "sku": {
            "value": "[parameters('functionAppSku')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.39.26.7824",
              "templateHash": "12452722508131605079"
            }
          },
          "parameters": {
            "planName": {
              "type": "string",
              "metadata": {
                "description": "Name of the App Service Plan"
              }
            },
            "location": {
              "type": "string",
              "metadata": {
                "description": "Azure region"
              }
            },
            "tags": {
              "type": "object",
              "metadata": {
                "description": "Tags to apply"
              }
            },
            "sku": {
              "type": "string",
              "defaultValue": "FC1",
              "allowedValues": [
                "FC1",
                "Y1",
                "EP1",
                "EP2",
                "EP3"
              ],
              "metadata": {
                "description": "SKU for the plan"
              }
            }
          },
          "variables": {
            "skuConfig": {
              "FC1": {
                "name": "FC1",
                "tier": "FlexConsumption"
              },
              "Y1": {
                "name": "Y1",
                "tier": "Dynamic"
              },
              "EP1": {
                "name": "EP1",
                "tier": "ElasticPremium"
              },
              "EP2": {
                "name": "EP2",
                "tier": "ElasticPremium"
              },
              "EP3": {
                "name": "EP3",
                "tier": "ElasticPremium"
              }
            },
            "isFlexConsumption": "[equals(parameters('sku'), 'FC1')]"
          },
          "resources": [
            {
              "type": "Microsoft.Web/serverfarms",
              "apiVersion": "2023-01-01",
              "name": "[parameters('planName')]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]",
              "sku": {
                "name": "[variables('skuConfig')[parameters('sku')].name]",
                "tier": "[variables('skuConfig')[parameters('sku')].tier]"
              },
              "properties": {
                "reserved": true
              }
            }
          ],
          "outputs": {
            "planId": {
              "type": "string",
              "metadata": {
                "description": "App Service Plan resource ID"
              },
              "value": "[resourceId('Microsoft.Web/serverfarms', parameters('planName'))]"
            },
            "planName": {
              "type": "string",
              "metadata": {
                "description": "App Service Plan name"
              },
              "value": "[parameters('planName')]"
            },
            "isFlexConsumption": {
              "type": "bool",
              "metadata": {
                "description": "Is Flex Consumption plan"
              },
              "value": "[variables('isFlexConsumption')]"
            },
            "skuTier": {
              "type": "string",
              "metadata": {
                "description": "SKU tier"
              },
              "value": "[variables('skuConfig')[parameters('sku')].tier]"
            }
          }
        }
      }
    },
    {
      "condition": "[variables('isFlexConsumption')]",
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "appserviceplan-processor-deployment",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "planName": {
            "value": "[format('{0}-processor', variables('appServicePlanName'))]"
          },
          "location": {
            "value": "[parameters('location')]"
          },
          "tags": {
            "value": "[variables('tags')]"
          },
          "sku": {
            "value": "[parameters('functionAppSku')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.39.26.7824",
              "templateHash": "12452722508131605079"
            }
          },
          "parameters": {
            "planName": {
              "type": "string",
              "metadata": {
                "description": "Name of the App Service Plan"
              }
            },
            "location": {
              "type": "string",
              "metadata": {
                "description": "Azure region"
              }
            },
            "tags": {
              "type": "object",
              "metadata": {
                "description": "Tags to apply"
              }
            },
            "sku": {
              "type": "string",
              "defaultValue": "FC1",
              "allowedValues": [
                "FC1",
                "Y1",
                "EP1",
                "EP2",
                "EP3"
              ],
              "metadata": {
                "description": "SKU for the plan"
              }
            }
          },
          "variables": {
            "skuConfig": {
              "FC1": {
                "name": "FC1",
                "tier": "FlexConsumption"
              },
              "Y1": {
                "name": "Y1",
                "tier": "Dynamic"
              },
              "EP1": {
                "name": "EP1",
                "tier": "ElasticPremium"
              },
              "EP2": {
                "name": "EP2",
                "tier": "ElasticPremium"
              },
              "EP3": {
                "name": "EP3",
                "tier": "ElasticPremium"
              }
            },
            "isFlexConsumption": "[equals(parameters('sku'), 'FC1')]"
          },
          "resources": [
            {
              "type": "Microsoft.Web/serverfarms",
              "apiVersion": "2023-01-01",
              "name": "[parameters('planName')]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]",
              "sku": {
                "name": "[variables('skuConfig')[parameters('sku')].name]",
                "tier": "[variables('skuConfig')[parameters('sku')].tier]"
              },
              "properties": {
                "reserved": true
              }
            }
          ],
          "outputs": {
            "planId": {
              "type": "string",
              "metadata": {
                "description": "App Service Plan resource ID"
              },
              "value": "[resourceId('Microsoft.Web/serverfarms', parameters('planName'))]"
            },
            "planName": {
              "type": "string",
              "metadata": {
                "description": "App Service Plan name"
              },
              "value": "[parameters('planName')]"
            },
            "isFlexConsumption": {
              "type": "bool",
              "metadata": {
                "description": "Is Flex Consumption plan"
              },
              "value": "[variables('isFlexConsumption')]"
            },
            "skuTier": {
              "type": "string",
              "metadata": {
                "description": "SKU tier"
              },
              "value": "[variables('skuConfig')[parameters('sku')].tier]"
            }
          }
        }
      }
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "deployment-identity",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "identityName": {
            "value": "[variables('deploymentIdentityName')]"
          },
          "location": {
            "value": "[parameters('location')]"
          },
          "tags": {
            "value": "[variables('tags')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.39.26.7824",
              "templateHash": "18425978129405451201"
            }
          },
          "parameters": {
            "identityName": {
              "type": "string",
              "metadata": {
                "description": "Name of the managed identity"
              }
            },
            "location": {
              "type": "string",
              "metadata": {
                "description": "Azure region"
              }
            },
            "tags": {
              "type": "object",
              "metadata": {
                "description": "Tags to apply"
              }
            }
          },
          "resources": [
            {
              "type": "Microsoft.ManagedIdentity/userAssignedIdentities",
              "apiVersion": "2023-01-31",
              "name": "[parameters('identityName')]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]"
            }
          ],
          "outputs": {
            "identityId": {
              "type": "string",
              "metadata": {
                "description": "Managed Identity resource ID"
              },
              "value": "[resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', parameters('identityName'))]"
            },
            "principalId": {
              "type": "string",
              "metadata": {
                "description": "Managed Identity principal ID"
              },
              "value": "[reference(resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', parameters('identityName')), '2023-01-31').principalId]"
            },
            "clientId": {
              "type": "string",
              "metadata": {
                "description": "Managed Identity client ID"
              },
              "value": "[reference(resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', parameters('identityName')), '2023-01-31').clientId]"
            }
          }
        }
      }
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "rbac-deployment-contributor",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "principalId": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', 'deployment-identity'), '2025-04-01').outputs.principalId.value]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.39.26.7824",
              "templateHash": "14210500320083670913"
            }
          },
          "parameters": {
            "principalId": {
              "type": "string",
              "metadata": {
                "description": "Principal ID to assign the role to"
              }
            },
            "principalType": {
              "type": "string",
              "defaultValue": "ServicePrincipal",
              "metadata": {
                "description": "Principal type (ServicePrincipal, User, Group)"
              }
            }
          },
          "variables": {
            "contributorRoleId": "b24988ac-6180-42a0-ab88-20f7382dd24c"
          },
          "resources": [
            {
              "type": "Microsoft.Authorization/roleAssignments",
              "apiVersion": "2022-04-01",
              "name": "[guid(resourceGroup().id, parameters('principalId'), variables('contributorRoleId'))]",
              "properties": {
                "roleDefinitionId": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', variables('contributorRoleId'))]",
                "principalId": "[parameters('principalId')]",
                "principalType": "[parameters('principalType')]"
              }
            }
          ],
          "outputs": {
            "roleAssignmentId": {
              "type": "string",
              "metadata": {
                "description": "Role assignment ID"
              },
              "value": "[resourceId('Microsoft.Authorization/roleAssignments', guid(resourceGroup().id, parameters('principalId'), variables('contributorRoleId')))]"
            }
          }
        }
      },
      "dependsOn": [
        "[resourceId('Microsoft.Resources/deployments', 'deployment-identity')]"
      ]
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "rbac-deployment-keyvault",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "keyVaultName": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', 'keyvault-deployment'), '2025-04-01').outputs.keyVaultName.value]"
          },
          "principalId": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', 'deployment-identity'), '2025-04-01').outputs.principalId.value]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.39.26.7824",
              "templateHash": "15993742515363455244"
            }
          },
          "parameters": {
            "keyVaultName": {
              "type": "string",
              "metadata": {
                "description": "Name of the Key Vault"
              }
            },
            "principalId": {
              "type": "string",
              "metadata": {
                "description": "Principal ID to grant access to"
              }
            }
          },
          "variables": {
            "keyVaultSecretsOfficerRoleId": "b86a8fe4-44ce-4948-aee5-eccb2c155cd7"
          },
          "resources": [
            {
              "type": "Microsoft.Authorization/roleAssignments",
              "apiVersion": "2022-04-01",
              "scope": "[format('Microsoft.KeyVault/vaults/{0}', parameters('keyVaultName'))]",
              "name": "[guid(resourceId('Microsoft.KeyVault/vaults', parameters('keyVaultName')), parameters('principalId'), variables('keyVaultSecretsOfficerRoleId'))]",
              "properties": {
                "roleDefinitionId": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', variables('keyVaultSecretsOfficerRoleId'))]",
                "principalId": "[parameters('principalId')]",
                "principalType": "ServicePrincipal"
              }
            }
          ],
          "outputs": {
            "roleAssignmentId": {
              "type": "string",
              "metadata": {
                "description": "Role assignment ID"
              },
              "value": "[extensionResourceId(resourceId('Microsoft.KeyVault/vaults', parameters('keyVaultName')), 'Microsoft.Authorization/roleAssignments', guid(resourceId('Microsoft.KeyVault/vaults', parameters('keyVaultName')), parameters('principalId'), variables('keyVaultSecretsOfficerRoleId')))]"
            }
          }
        }
      },
      "dependsOn": [
        "[resourceId('Microsoft.Resources/deployments', 'deployment-identity')]",
        "[resourceId('Microsoft.Resources/deployments', 'keyvault-deployment')]"
      ]
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "rbac-deployment-storage",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "storageAccountName": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', 'storage-deployment'), '2025-04-01').outputs.storageAccountName.value]"
          },
          "principalId": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', 'deployment-identity'), '2025-04-01').outputs.principalId.value]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.39.26.7824",
              "templateHash": "2424278750732879277"
            }
          },
          "parameters": {
            "storageAccountName": {
              "type": "string",
              "metadata": {
                "description": "Name of the Storage Account"
              }
            },
            "principalId": {
              "type": "string",
              "metadata": {
                "description": "Principal ID to grant access to"
              }
            }
          },
          "variables": {
            "storageBlobDataContributorRoleId": "ba92f5b4-2d11-453d-a403-e96b0029c9fe",
            "storageQueueDataContributorRoleId": "974c5e8b-45b9-4653-ba55-5f855dd0fb88",
            "storageTableDataContributorRoleId": "0a9a7e1f-b9d0-4cc4-a60d-0319b160aaa3"
          },
          "resources": [
            {
              "type": "Microsoft.Authorization/roleAssignments",
              "apiVersion": "2022-04-01",
              "scope": "[format('Microsoft.Storage/storageAccounts/{0}', parameters('storageAccountName'))]",
              "name": "[guid(resourceId('Microsoft.Storage/storageAccounts', parameters('storageAccountName')), parameters('principalId'), variables('storageBlobDataContributorRoleId'))]",
              "properties": {
                "roleDefinitionId": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', variables('storageBlobDataContributorRoleId'))]",
                "principalId": "[parameters('principalId')]",
                "principalType": "ServicePrincipal"
              }
            },
            {
              "type": "Microsoft.Authorization/roleAssignments",
              "apiVersion": "2022-04-01",
              "scope": "[format('Microsoft.Storage/storageAccounts/{0}', parameters('storageAccountName'))]",
              "name": "[guid(resourceId('Microsoft.Storage/storageAccounts', parameters('storageAccountName')), parameters('principalId'), variables('storageQueueDataContributorRoleId'))]",
              "properties": {
                "roleDefinitionId": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', variables('storageQueueDataContributorRoleId'))]",
                "principalId": "[parameters('principalId')]",
                "principalType": "ServicePrincipal"
              }
            },
            {
              "type": "Microsoft.Authorization/roleAssignments",
              "apiVersion": "2022-04-01",
              "scope": "[format('Microsoft.Storage/storageAccounts/{0}', parameters('storageAccountName'))]",
              "name": "[guid(resourceId('Microsoft.Storage/storageAccounts', parameters('storageAccountName')), parameters('principalId'), variables('storageTableDataContributorRoleId'))]",
              "properties": {
                "roleDefinitionId": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', variables('storageTableDataContributorRoleId'))]",
                "principalId": "[parameters('principalId')]",
                "principalType": "ServicePrincipal"
              }
            }
          ],
          "outputs": {
            "blobRoleAssignmentId": {
              "type": "string",
              "metadata": {
                "description": "Blob role assignment ID"
              },
              "value": "[extensionResourceId(resourceId('Microsoft.Storage/storageAccounts', parameters('storageAccountName')), 'Microsoft.Authorization/roleAssignments', guid(resourceId('Microsoft.Storage/storageAccounts', parameters('storageAccountName')), parameters('principalId'), variables('storageBlobDataContributorRoleId')))]"
            },
            "queueRoleAssignmentId": {
              "type": "string",
              "metadata": {
                "description": "Queue role assignment ID"
              },
              "value": "[extensionResourceId(resourceId('Microsoft.Storage/storageAccounts', parameters('storageAccountName')), 'Microsoft.Authorization/roleAssignments', guid(resourceId('Microsoft.Storage/storageAccounts', parameters('storageAccountName')), parameters('principalId'), variables('storageQueueDataContributorRoleId')))]"
            },
            "tableRoleAssignmentId": {
              "type": "string",
              "metadata": {
                "description": "Table role assignment ID"
              },
              "value": "[extensionResourceId(resourceId('Microsoft.Storage/storageAccounts', parameters('storageAccountName')), 'Microsoft.Authorization/roleAssignments', guid(resourceId('Microsoft.Storage/storageAccounts', parameters('storageAccountName')), parameters('principalId'), variables('storageTableDataContributorRoleId')))]"
            }
          }
        }
      },
      "dependsOn": [
        "[resourceId('Microsoft.Resources/deployments', 'deployment-identity')]",
        "[resourceId('Microsoft.Resources/deployments', 'storage-deployment')]"
      ]
    },
    {
      "condition": "[not(parameters('skipAppRegistration'))]",
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "appregistration-deployment",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "appName": {
            "value": "[parameters('appName')]"
          },
          "location": {
            "value": "[parameters('location')]"
          },
          "tags": {
            "value": "[variables('tags')]"
          },
          "storageAccountName": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', 'storage-deployment'), '2025-04-01').outputs.storageAccountName.value]"
          },
          "apiFunctionAppHostname": {
            "value": "[format('{0}.azurewebsites.net', variables('functionAppApiName'))]"
          },
          "keyVaultName": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', 'keyvault-deployment'), '2025-04-01').outputs.keyVaultName.value]"
          },
          "managedIdentityId": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', 'deployment-identity'), '2025-04-01').outputs.identityId.value]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.39.26.7824",
              "templateHash": "4477853477234701121"
            }
          },
          "parameters": {
            "appName": {
              "type": "string",
              "metadata": {
                "description": "Base name for the application"
              }
            },
            "location": {
              "type": "string",
              "metadata": {
                "description": "Azure region"
              }
            },
            "tags": {
              "type": "object",
              "metadata": {
                "description": "Tags to apply"
              }
            },
            "storageAccountName": {
              "type": "string",
              "metadata": {
                "description": "Storage Account name (for redirect URI - uses Static Website)"
              }
            },
            "apiFunctionAppHostname": {
              "type": "string",
              "metadata": {
                "description": "API Function App hostname (for API permissions)"
              }
            },
            "keyVaultName": {
              "type": "string",
              "metadata": {
                "description": "Key Vault name to store the client secret"
              }
            },
            "managedIdentityId": {
              "type": "string",
              "metadata": {
                "description": "Managed Identity ID for the deployment script"
              }
            }
          },
          "resources": [
            {
              "type": "Microsoft.Resources/deploymentScripts",
              "apiVersion": "2023-08-01",
              "name": "[format('{0}-create-app-registration', parameters('appName'))]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]",
              "kind": "AzureCLI",
              "identity": {
                "type": "UserAssigned",
                "userAssignedIdentities": {
                  "[format('{0}', parameters('managedIdentityId'))]": {}
                }
              },
              "properties": {
                "azCliVersion": "2.50.0",
                "timeout": "PT10M",
                "retentionInterval": "PT1H",
                "cleanupPreference": "OnSuccess",
                "environmentVariables": [
                  {
                    "name": "APP_NAME",
                    "value": "[parameters('appName')]"
                  },
                  {
                    "name": "STORAGE_ACCOUNT_NAME",
                    "value": "[parameters('storageAccountName')]"
                  },
                  {
                    "name": "API_HOSTNAME",
                    "value": "[parameters('apiFunctionAppHostname')]"
                  },
                  {
                    "name": "KEY_VAULT_NAME",
                    "value": "[parameters('keyVaultName')]"
                  }
                ],
                "scriptContent": "      #!/bin/bash\n      set -e\n\n      echo \"==========================================\"\n      echo \"Creating Azure AD App Registration (SPA)\"\n      echo \"==========================================\"\n\n      # Get the Storage Static Website URL\n      # Note: Static website might not be enabled yet, so we'll use a predictable URL pattern\n      # The actual URL will be available after code-deployment enables static website\n      STORAGE_WEB_URL=$(az storage account show \\\n        --name \"$STORAGE_ACCOUNT_NAME\" \\\n        --query \"primaryEndpoints.web\" -o tsv 2>/dev/null | sed 's:/*$::' || echo \"\")\n\n      if [ -z \"$STORAGE_WEB_URL\" ]; then\n        # If static website isn't enabled yet, we can't get the URL\n        # The App Registration will need to be updated manually later\n        echo \"WARNING: Storage static website not yet enabled\"\n        echo \"App Registration redirect URIs will need to be updated after deployment\"\n        STORAGE_WEB_URL=\"https://localhost\"\n      fi\n\n      echo \"Storage Website URL: $STORAGE_WEB_URL\"\n\n      APP_DISPLAY_NAME=\"Dilux Database Backup - ${APP_NAME}\"\n      REDIRECT_URI_1=\"${STORAGE_WEB_URL}\"\n      REDIRECT_URI_2=\"${STORAGE_WEB_URL}/\"\n      REDIRECT_URI_3=\"http://localhost:3000\"\n      REDIRECT_URI_4=\"http://localhost:5173\"\n\n      # Check if app already exists using Graph API\n      echo \"Checking if App Registration already exists...\"\n      EXISTING_APP=$(az rest --method GET \\\n        --uri \"https://graph.microsoft.com/v1.0/applications?\\$filter=displayName eq '${APP_DISPLAY_NAME}'\" \\\n        --query \"value[0].appId\" -o tsv 2>/dev/null || echo \"\")\n\n      if [ -n \"$EXISTING_APP\" ] && [ \"$EXISTING_APP\" != \"None\" ] && [ \"$EXISTING_APP\" != \"null\" ]; then\n        echo \"App Registration already exists: $EXISTING_APP\"\n        CLIENT_ID=$EXISTING_APP\n\n        # Get Object ID for updates\n        OBJECT_ID=$(az rest --method GET \\\n          --uri \"https://graph.microsoft.com/v1.0/applications?\\$filter=displayName eq '${APP_DISPLAY_NAME}'\" \\\n          --query \"value[0].id\" -o tsv 2>/dev/null || echo \"\")\n\n        # Update SPA redirect URIs if needed\n        echo \"Updating SPA redirect URIs...\"\n        az rest --method PATCH \\\n          --uri \"https://graph.microsoft.com/v1.0/applications/${OBJECT_ID}\" \\\n          --headers \"Content-Type=application/json\" \\\n          --body \"{\\\"spa\\\":{\\\"redirectUris\\\":[\\\"${REDIRECT_URI_1}\\\",\\\"${REDIRECT_URI_2}\\\",\\\"${REDIRECT_URI_3}\\\",\\\"${REDIRECT_URI_4}\\\"]}}\" \\\n          2>/dev/null || echo \"Warning: Could not update redirect URIs\"\n      else\n        echo \"Creating new App Registration with SPA redirect URIs...\"\n\n        # Create app using Graph API with SPA redirect URIs\n        CREATE_RESULT=$(az rest --method POST \\\n          --uri \"https://graph.microsoft.com/v1.0/applications\" \\\n          --headers \"Content-Type=application/json\" \\\n          --body \"{\n            \\\"displayName\\\": \\\"${APP_DISPLAY_NAME}\\\",\n            \\\"signInAudience\\\": \\\"AzureADMyOrg\\\",\n            \\\"spa\\\": {\n              \\\"redirectUris\\\": [\\\"${REDIRECT_URI_1}\\\", \\\"${REDIRECT_URI_2}\\\", \\\"${REDIRECT_URI_3}\\\", \\\"${REDIRECT_URI_4}\\\"]\n            },\n            \\\"requiredResourceAccess\\\": [\n              {\n                \\\"resourceAppId\\\": \\\"00000003-0000-0000-c000-000000000000\\\",\n                \\\"resourceAccess\\\": [\n                  {\n                    \\\"id\\\": \\\"e1fe6dd8-ba31-4d61-89e7-88639da4683d\\\",\n                    \\\"type\\\": \\\"Scope\\\"\n                  }\n                ]\n              }\n            ]\n          }\" 2>&1) || {\n            echo \"============================================================\"\n            echo \"  APP REGISTRATION NO CONFIGURADO\"\n            echo \"============================================================\"\n            echo \"\"\n            echo \"El deployment continuar pero la autenticacin quedar en\"\n            echo \"modo MOCK (sin Azure AD real).\"\n            echo \"\"\n            echo \"Para habilitar Azure AD authentication, ejecuta:\"\n            echo \"\"\n            echo \"  curl -sL https://raw.githubusercontent.com/pablodiloreto/dilux-azure-databases-backup-alpha/main/scripts/configure-auth.sh | bash\"\n            echo \"\"\n            echo \"El script te guiar para:\"\n            echo \"  1. Crear el App Registration en Azure AD\"\n            echo \"  2. Configurar las Function Apps\"\n            echo \"  3. Actualizar el frontend\"\n            echo \"\"\n            echo \"============================================================\"\n\n            # Output empty values so the deployment doesn't fail completely\n            echo \"{\\\"clientId\\\": \\\"\\\", \\\"success\\\": false, \\\"message\\\": \\\"Manual setup required\\\"}\" > $AZ_SCRIPTS_OUTPUT_PATH\n            exit 0\n          }\n\n        CLIENT_ID=$(echo \"$CREATE_RESULT\" | jq -r '.appId')\n        OBJECT_ID=$(echo \"$CREATE_RESULT\" | jq -r '.id')\n\n        if [ -z \"$CLIENT_ID\" ] || [ \"$CLIENT_ID\" == \"null\" ]; then\n          echo \"ERROR: Failed to extract Client ID from response\"\n          echo \"Response: $CREATE_RESULT\"\n          echo \"{\\\"clientId\\\": \\\"\\\", \\\"success\\\": false, \\\"message\\\": \\\"Failed to create app\\\"}\" > $AZ_SCRIPTS_OUTPUT_PATH\n          exit 0\n        fi\n\n        echo \"App Registration created successfully!\"\n        echo \"Client ID: $CLIENT_ID\"\n        echo \"Object ID: $OBJECT_ID\"\n      fi\n\n      # Store the client ID in Key Vault\n      echo \"Storing client ID in Key Vault...\"\n      az keyvault secret set \\\n        --vault-name \"$KEY_VAULT_NAME\" \\\n        --name \"azure-ad-client-id\" \\\n        --value \"$CLIENT_ID\" \\\n        --only-show-errors 2>/dev/null || echo \"Warning: Could not store client ID in Key Vault\"\n\n      # Get tenant ID\n      TENANT_ID=$(az account show --query tenantId -o tsv)\n\n      echo \"==========================================\"\n      echo \"App Registration configured successfully!\"\n      echo \"==========================================\"\n      echo \"Client ID: $CLIENT_ID\"\n      echo \"Tenant ID: $TENANT_ID\"\n      echo \"Redirect URIs (SPA):\"\n      echo \"  - ${REDIRECT_URI_1}\"\n      echo \"  - ${REDIRECT_URI_2}\"\n      echo \"  - ${REDIRECT_URI_3}\"\n      echo \"  - ${REDIRECT_URI_4}\"\n      echo \"==========================================\"\n\n      # Output the results\n      echo \"{\\\"clientId\\\": \\\"$CLIENT_ID\\\", \\\"tenantId\\\": \\\"$TENANT_ID\\\", \\\"success\\\": true}\" > $AZ_SCRIPTS_OUTPUT_PATH\n    "
              }
            }
          ],
          "outputs": {
            "clientId": {
              "type": "string",
              "metadata": {
                "description": "The Client ID of the App Registration (empty if manual setup required)"
              },
              "value": "[reference(resourceId('Microsoft.Resources/deploymentScripts', format('{0}-create-app-registration', parameters('appName'))), '2023-08-01').outputs.clientId]"
            },
            "tenantId": {
              "type": "string",
              "metadata": {
                "description": "The Tenant ID"
              },
              "value": "[coalesce(tryGet(reference(resourceId('Microsoft.Resources/deploymentScripts', format('{0}-create-app-registration', parameters('appName'))), '2023-08-01').outputs, 'tenantId'), subscription().tenantId)]"
            },
            "success": {
              "type": "bool",
              "metadata": {
                "description": "Whether the App Registration was created successfully"
              },
              "value": "[coalesce(tryGet(reference(resourceId('Microsoft.Resources/deploymentScripts', format('{0}-create-app-registration', parameters('appName'))), '2023-08-01').outputs, 'success'), false())]"
            }
          }
        }
      },
      "dependsOn": [
        "[resourceId('Microsoft.Resources/deployments', 'deployment-identity')]",
        "[resourceId('Microsoft.Resources/deployments', 'keyvault-deployment')]",
        "[resourceId('Microsoft.Resources/deployments', 'rbac-deployment-contributor')]",
        "[resourceId('Microsoft.Resources/deployments', 'rbac-deployment-keyvault')]",
        "[resourceId('Microsoft.Resources/deployments', 'rbac-deployment-storage')]",
        "[resourceId('Microsoft.Resources/deployments', 'storage-deployment')]"
      ]
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "functionapp-api-deployment",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "functionAppName": {
            "value": "[variables('functionAppApiName')]"
          },
          "functionAppType": {
            "value": "api"
          },
          "location": {
            "value": "[parameters('location')]"
          },
          "tags": {
            "value": "[variables('tags')]"
          },
          "appServicePlanId": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', 'appserviceplan-api-deployment'), '2025-04-01').outputs.planId.value]"
          },
          "sku": {
            "value": "[parameters('functionAppSku')]"
          },
          "isFlexConsumption": {
            "value": "[variables('isFlexConsumption')]"
          },
          "storageAccountName": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', 'storage-deployment'), '2025-04-01').outputs.storageAccountName.value]"
          },
          "storageConnectionString": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', 'storage-deployment'), '2025-04-01').outputs.connectionString.value]"
          },
          "storageBlobEndpoint": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', 'storage-deployment'), '2025-04-01').outputs.blobEndpoint.value]"
          },
          "storageQueueEndpoint": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', 'storage-deployment'), '2025-04-01').outputs.queueEndpoint.value]"
          },
          "storageTableEndpoint": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', 'storage-deployment'), '2025-04-01').outputs.tableEndpoint.value]"
          },
          "appInsightsConnectionString": "[if(parameters('enableAppInsights'), createObject('value', reference(resourceId('Microsoft.Resources/deployments', 'appinsights-deployment'), '2025-04-01').outputs.connectionString.value), createObject('value', ''))]",
          "appInsightsInstrumentationKey": "[if(parameters('enableAppInsights'), createObject('value', reference(resourceId('Microsoft.Resources/deployments', 'appinsights-deployment'), '2025-04-01').outputs.instrumentationKey.value), createObject('value', ''))]",
          "keyVaultName": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', 'keyvault-deployment'), '2025-04-01').outputs.keyVaultName.value]"
          },
          "additionalAppSettings": {
            "value": {
              "FUNCTION_APP_TYPE": "api",
              "ADMIN_EMAIL": "[parameters('adminEmail')]",
              "APP_VERSION": "[parameters('appVersion')]",
              "INSTALLATION_ID": "[variables('installationId')]",
              "AZURE_AD_TENANT_ID": "[variables('tenantId')]",
              "AZURE_AD_CLIENT_ID": "[if(not(empty(parameters('azureAdClientId'))), parameters('azureAdClientId'), if(parameters('skipAppRegistration'), '', if(reference(resourceId('Microsoft.Resources/deployments', 'appregistration-deployment'), '2025-04-01').outputs.success.value, reference(resourceId('Microsoft.Resources/deployments', 'appregistration-deployment'), '2025-04-01').outputs.clientId.value, '')))]",
              "AUTH_MODE": "[if(empty(if(not(empty(parameters('azureAdClientId'))), parameters('azureAdClientId'), if(parameters('skipAppRegistration'), '', if(reference(resourceId('Microsoft.Resources/deployments', 'appregistration-deployment'), '2025-04-01').outputs.success.value, reference(resourceId('Microsoft.Resources/deployments', 'appregistration-deployment'), '2025-04-01').outputs.clientId.value, '')))), 'mock', 'azure')]",
              "AZURE_SUBSCRIPTION_ID": "[subscription().subscriptionId]",
              "DILUX_RESOURCE_GROUP": "[resourceGroup().name]",
              "DILUX_API_APP_NAME": "[variables('functionAppApiName')]",
              "DILUX_SCHEDULER_APP_NAME": "[variables('functionAppSchedulerName')]",
              "DILUX_PROCESSOR_APP_NAME": "[variables('functionAppProcessorName')]"
            }
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.39.26.7824",
              "templateHash": "7283587711428679460"
            }
          },
          "parameters": {
            "functionAppName": {
              "type": "string",
              "metadata": {
                "description": "Name of the Function App"
              }
            },
            "location": {
              "type": "string",
              "metadata": {
                "description": "Azure region"
              }
            },
            "tags": {
              "type": "object",
              "metadata": {
                "description": "Tags to apply"
              }
            },
            "appServicePlanId": {
              "type": "string",
              "metadata": {
                "description": "App Service Plan resource ID"
              }
            },
            "sku": {
              "type": "string",
              "metadata": {
                "description": "App Service Plan SKU (FC1, Y1, EP1, EP2, EP3)"
              }
            },
            "isFlexConsumption": {
              "type": "bool",
              "defaultValue": false,
              "metadata": {
                "description": "Is Flex Consumption plan"
              }
            },
            "maximumInstanceCount": {
              "type": "int",
              "defaultValue": 100,
              "metadata": {
                "description": "Maximum instance count for Flex Consumption"
              }
            },
            "instanceMemoryMB": {
              "type": "int",
              "defaultValue": 2048,
              "allowedValues": [
                2048,
                4096
              ],
              "metadata": {
                "description": "Instance memory in MB for Flex Consumption (2048 or 4096)"
              }
            },
            "storageAccountName": {
              "type": "string",
              "metadata": {
                "description": "Storage Account name"
              }
            },
            "storageConnectionString": {
              "type": "securestring",
              "metadata": {
                "description": "Storage Account connection string (for Y1/Consumption plan)"
              }
            },
            "storageBlobEndpoint": {
              "type": "string",
              "metadata": {
                "description": "Storage Account blob endpoint"
              }
            },
            "storageQueueEndpoint": {
              "type": "string",
              "metadata": {
                "description": "Storage Account queue endpoint"
              }
            },
            "storageTableEndpoint": {
              "type": "string",
              "metadata": {
                "description": "Storage Account table endpoint"
              }
            },
            "appInsightsConnectionString": {
              "type": "string",
              "defaultValue": "",
              "metadata": {
                "description": "Application Insights connection string"
              }
            },
            "appInsightsInstrumentationKey": {
              "type": "string",
              "defaultValue": "",
              "metadata": {
                "description": "Application Insights instrumentation key"
              }
            },
            "keyVaultName": {
              "type": "string",
              "metadata": {
                "description": "Key Vault name"
              }
            },
            "additionalAppSettings": {
              "type": "object",
              "defaultValue": {},
              "metadata": {
                "description": "Additional app settings"
              }
            },
            "frontendUrl": {
              "type": "string",
              "defaultValue": "",
              "metadata": {
                "description": "Frontend URL for CORS (specific origin required for credentials)"
              }
            },
            "functionAppType": {
              "type": "string",
              "defaultValue": "api",
              "allowedValues": [
                "api",
                "scheduler",
                "processor"
              ],
              "metadata": {
                "description": "Function App type (api, scheduler, processor) - used for unique deployment container"
              }
            }
          },
          "variables": {
            "corsOrigins": "[if(empty(parameters('frontendUrl')), createArray('https://portal.azure.com', 'http://localhost:3000', 'http://localhost:5173'), createArray('https://portal.azure.com', 'http://localhost:3000', 'http://localhost:5173', parameters('frontendUrl')))]",
            "isLegacyConsumptionPlan": "[equals(parameters('sku'), 'Y1')]",
            "consumptionStorageSettings": {
              "AzureWebJobsStorage": "[parameters('storageConnectionString')]",
              "WEBSITE_CONTENTAZUREFILECONNECTIONSTRING": "[parameters('storageConnectionString')]",
              "WEBSITE_CONTENTSHARE": "[toLower(parameters('functionAppName'))]"
            },
            "flexConsumptionStorageSettings": {
              "AzureWebJobsStorage__accountName": "[parameters('storageAccountName')]"
            },
            "premiumStorageSettings": {
              "AzureWebJobsStorage__accountName": "[parameters('storageAccountName')]",
              "AzureWebJobsStorage__blobServiceUri": "[parameters('storageBlobEndpoint')]",
              "AzureWebJobsStorage__queueServiceUri": "[parameters('storageQueueEndpoint')]",
              "AzureWebJobsStorage__tableServiceUri": "[parameters('storageTableEndpoint')]"
            },
            "runtimeStorageSettings": "[if(parameters('isFlexConsumption'), variables('flexConsumptionStorageSettings'), if(variables('isLegacyConsumptionPlan'), variables('consumptionStorageSettings'), variables('premiumStorageSettings')))]",
            "runtimeSettings": "[if(parameters('isFlexConsumption'), createObject(), createObject('FUNCTIONS_EXTENSION_VERSION', '~4', 'FUNCTIONS_WORKER_RUNTIME', 'python'))]",
            "baseAppSettings": {
              "STORAGE_ACCOUNT_NAME": "[parameters('storageAccountName')]",
              "STORAGE_BLOB_ENDPOINT": "[parameters('storageBlobEndpoint')]",
              "STORAGE_QUEUE_ENDPOINT": "[parameters('storageQueueEndpoint')]",
              "STORAGE_TABLE_ENDPOINT": "[parameters('storageTableEndpoint')]",
              "KEY_VAULT_NAME": "[parameters('keyVaultName')]",
              "ENVIRONMENT": "production"
            },
            "appInsightsSettings": "[if(not(empty(parameters('appInsightsConnectionString'))), createObject('APPLICATIONINSIGHTS_CONNECTION_STRING', parameters('appInsightsConnectionString'), 'APPINSIGHTS_INSTRUMENTATIONKEY', parameters('appInsightsInstrumentationKey')), createObject())]",
            "appSettings": "[union(variables('runtimeStorageSettings'), variables('runtimeSettings'), variables('baseAppSettings'), variables('appInsightsSettings'), parameters('additionalAppSettings'))]"
          },
          "resources": [
            {
              "condition": "[not(parameters('isFlexConsumption'))]",
              "type": "Microsoft.Web/sites",
              "apiVersion": "2023-01-01",
              "name": "[parameters('functionAppName')]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]",
              "kind": "functionapp,linux",
              "identity": {
                "type": "SystemAssigned"
              },
              "properties": {
                "serverFarmId": "[parameters('appServicePlanId')]",
                "httpsOnly": true,
                "reserved": true,
                "siteConfig": {
                  "copy": [
                    {
                      "name": "appSettings",
                      "count": "[length(items(variables('appSettings')))]",
                      "input": {
                        "name": "[items(variables('appSettings'))[copyIndex('appSettings')].key]",
                        "value": "[string(items(variables('appSettings'))[copyIndex('appSettings')].value)]"
                      }
                    }
                  ],
                  "linuxFxVersion": "PYTHON|3.10",
                  "ftpsState": "Disabled",
                  "minTlsVersion": "1.2",
                  "cors": {
                    "allowedOrigins": "[variables('corsOrigins')]",
                    "supportCredentials": true
                  }
                }
              }
            },
            {
              "condition": "[parameters('isFlexConsumption')]",
              "type": "Microsoft.Web/sites",
              "apiVersion": "2024-04-01",
              "name": "[parameters('functionAppName')]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]",
              "kind": "functionapp,linux",
              "identity": {
                "type": "SystemAssigned"
              },
              "properties": {
                "serverFarmId": "[parameters('appServicePlanId')]",
                "httpsOnly": true,
                "reserved": true,
                "functionAppConfig": {
                  "deployment": {
                    "storage": {
                      "type": "blobContainer",
                      "value": "[format('{0}deployments-{1}', parameters('storageBlobEndpoint'), parameters('functionAppType'))]",
                      "authentication": {
                        "type": "SystemAssignedIdentity"
                      }
                    }
                  },
                  "scaleAndConcurrency": {
                    "maximumInstanceCount": "[parameters('maximumInstanceCount')]",
                    "instanceMemoryMB": "[parameters('instanceMemoryMB')]"
                  },
                  "runtime": {
                    "name": "python",
                    "version": "3.10"
                  }
                },
                "siteConfig": {
                  "copy": [
                    {
                      "name": "appSettings",
                      "count": "[length(items(variables('appSettings')))]",
                      "input": {
                        "name": "[items(variables('appSettings'))[copyIndex('appSettings')].key]",
                        "value": "[string(items(variables('appSettings'))[copyIndex('appSettings')].value)]"
                      }
                    }
                  ],
                  "ftpsState": "Disabled",
                  "minTlsVersion": "1.2",
                  "cors": {
                    "allowedOrigins": "[variables('corsOrigins')]",
                    "supportCredentials": true
                  }
                }
              }
            }
          ],
          "outputs": {
            "functionAppName": {
              "type": "string",
              "metadata": {
                "description": "Function App name"
              },
              "value": "[if(parameters('isFlexConsumption'), parameters('functionAppName'), parameters('functionAppName'))]"
            },
            "defaultHostname": {
              "type": "string",
              "metadata": {
                "description": "Function App default hostname"
              },
              "value": "[if(parameters('isFlexConsumption'), reference(resourceId('Microsoft.Web/sites', parameters('functionAppName')), '2024-04-01').defaultHostName, reference(resourceId('Microsoft.Web/sites', parameters('functionAppName')), '2023-01-01').defaultHostName)]"
            },
            "principalId": {
              "type": "string",
              "metadata": {
                "description": "Function App principal ID (Managed Identity)"
              },
              "value": "[if(parameters('isFlexConsumption'), reference(resourceId('Microsoft.Web/sites', parameters('functionAppName')), '2024-04-01', 'full').identity.principalId, reference(resourceId('Microsoft.Web/sites', parameters('functionAppName')), '2023-01-01', 'full').identity.principalId)]"
            },
            "resourceId": {
              "type": "string",
              "metadata": {
                "description": "Function App resource ID"
              },
              "value": "[if(parameters('isFlexConsumption'), resourceId('Microsoft.Web/sites', parameters('functionAppName')), resourceId('Microsoft.Web/sites', parameters('functionAppName')))]"
            },
            "isLegacyConsumptionPlan": {
              "type": "bool",
              "metadata": {
                "description": "Is using legacy Consumption plan (Y1)"
              },
              "value": "[variables('isLegacyConsumptionPlan')]"
            },
            "isFlexConsumptionPlan": {
              "type": "bool",
              "metadata": {
                "description": "Is using Flex Consumption plan (FC1)"
              },
              "value": "[parameters('isFlexConsumption')]"
            }
          }
        }
      },
      "dependsOn": [
        "[resourceId('Microsoft.Resources/deployments', 'appinsights-deployment')]",
        "[resourceId('Microsoft.Resources/deployments', 'appregistration-deployment')]",
        "[resourceId('Microsoft.Resources/deployments', 'appserviceplan-api-deployment')]",
        "[resourceId('Microsoft.Resources/deployments', 'keyvault-deployment')]",
        "[resourceId('Microsoft.Resources/deployments', 'storage-deployment')]"
      ]
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "functionapp-scheduler-deployment",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "functionAppName": {
            "value": "[variables('functionAppSchedulerName')]"
          },
          "functionAppType": {
            "value": "scheduler"
          },
          "location": {
            "value": "[parameters('location')]"
          },
          "tags": {
            "value": "[variables('tags')]"
          },
          "appServicePlanId": "[if(variables('isFlexConsumption'), createObject('value', reference(resourceId('Microsoft.Resources/deployments', 'appserviceplan-scheduler-deployment'), '2025-04-01').outputs.planId.value), createObject('value', reference(resourceId('Microsoft.Resources/deployments', 'appserviceplan-api-deployment'), '2025-04-01').outputs.planId.value))]",
          "sku": {
            "value": "[parameters('functionAppSku')]"
          },
          "isFlexConsumption": {
            "value": "[variables('isFlexConsumption')]"
          },
          "storageAccountName": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', 'storage-deployment'), '2025-04-01').outputs.storageAccountName.value]"
          },
          "storageConnectionString": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', 'storage-deployment'), '2025-04-01').outputs.connectionString.value]"
          },
          "storageBlobEndpoint": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', 'storage-deployment'), '2025-04-01').outputs.blobEndpoint.value]"
          },
          "storageQueueEndpoint": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', 'storage-deployment'), '2025-04-01').outputs.queueEndpoint.value]"
          },
          "storageTableEndpoint": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', 'storage-deployment'), '2025-04-01').outputs.tableEndpoint.value]"
          },
          "appInsightsConnectionString": "[if(parameters('enableAppInsights'), createObject('value', reference(resourceId('Microsoft.Resources/deployments', 'appinsights-deployment'), '2025-04-01').outputs.connectionString.value), createObject('value', ''))]",
          "appInsightsInstrumentationKey": "[if(parameters('enableAppInsights'), createObject('value', reference(resourceId('Microsoft.Resources/deployments', 'appinsights-deployment'), '2025-04-01').outputs.instrumentationKey.value), createObject('value', ''))]",
          "keyVaultName": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', 'keyvault-deployment'), '2025-04-01').outputs.keyVaultName.value]"
          },
          "additionalAppSettings": {
            "value": {
              "FUNCTION_APP_TYPE": "scheduler",
              "APP_VERSION": "[parameters('appVersion')]",
              "INSTALLATION_ID": "[variables('installationId')]",
              "AUTH_MODE": "[if(empty(if(not(empty(parameters('azureAdClientId'))), parameters('azureAdClientId'), if(parameters('skipAppRegistration'), '', if(reference(resourceId('Microsoft.Resources/deployments', 'appregistration-deployment'), '2025-04-01').outputs.success.value, reference(resourceId('Microsoft.Resources/deployments', 'appregistration-deployment'), '2025-04-01').outputs.clientId.value, '')))), 'mock', 'azure')]"
            }
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.39.26.7824",
              "templateHash": "7283587711428679460"
            }
          },
          "parameters": {
            "functionAppName": {
              "type": "string",
              "metadata": {
                "description": "Name of the Function App"
              }
            },
            "location": {
              "type": "string",
              "metadata": {
                "description": "Azure region"
              }
            },
            "tags": {
              "type": "object",
              "metadata": {
                "description": "Tags to apply"
              }
            },
            "appServicePlanId": {
              "type": "string",
              "metadata": {
                "description": "App Service Plan resource ID"
              }
            },
            "sku": {
              "type": "string",
              "metadata": {
                "description": "App Service Plan SKU (FC1, Y1, EP1, EP2, EP3)"
              }
            },
            "isFlexConsumption": {
              "type": "bool",
              "defaultValue": false,
              "metadata": {
                "description": "Is Flex Consumption plan"
              }
            },
            "maximumInstanceCount": {
              "type": "int",
              "defaultValue": 100,
              "metadata": {
                "description": "Maximum instance count for Flex Consumption"
              }
            },
            "instanceMemoryMB": {
              "type": "int",
              "defaultValue": 2048,
              "allowedValues": [
                2048,
                4096
              ],
              "metadata": {
                "description": "Instance memory in MB for Flex Consumption (2048 or 4096)"
              }
            },
            "storageAccountName": {
              "type": "string",
              "metadata": {
                "description": "Storage Account name"
              }
            },
            "storageConnectionString": {
              "type": "securestring",
              "metadata": {
                "description": "Storage Account connection string (for Y1/Consumption plan)"
              }
            },
            "storageBlobEndpoint": {
              "type": "string",
              "metadata": {
                "description": "Storage Account blob endpoint"
              }
            },
            "storageQueueEndpoint": {
              "type": "string",
              "metadata": {
                "description": "Storage Account queue endpoint"
              }
            },
            "storageTableEndpoint": {
              "type": "string",
              "metadata": {
                "description": "Storage Account table endpoint"
              }
            },
            "appInsightsConnectionString": {
              "type": "string",
              "defaultValue": "",
              "metadata": {
                "description": "Application Insights connection string"
              }
            },
            "appInsightsInstrumentationKey": {
              "type": "string",
              "defaultValue": "",
              "metadata": {
                "description": "Application Insights instrumentation key"
              }
            },
            "keyVaultName": {
              "type": "string",
              "metadata": {
                "description": "Key Vault name"
              }
            },
            "additionalAppSettings": {
              "type": "object",
              "defaultValue": {},
              "metadata": {
                "description": "Additional app settings"
              }
            },
            "frontendUrl": {
              "type": "string",
              "defaultValue": "",
              "metadata": {
                "description": "Frontend URL for CORS (specific origin required for credentials)"
              }
            },
            "functionAppType": {
              "type": "string",
              "defaultValue": "api",
              "allowedValues": [
                "api",
                "scheduler",
                "processor"
              ],
              "metadata": {
                "description": "Function App type (api, scheduler, processor) - used for unique deployment container"
              }
            }
          },
          "variables": {
            "corsOrigins": "[if(empty(parameters('frontendUrl')), createArray('https://portal.azure.com', 'http://localhost:3000', 'http://localhost:5173'), createArray('https://portal.azure.com', 'http://localhost:3000', 'http://localhost:5173', parameters('frontendUrl')))]",
            "isLegacyConsumptionPlan": "[equals(parameters('sku'), 'Y1')]",
            "consumptionStorageSettings": {
              "AzureWebJobsStorage": "[parameters('storageConnectionString')]",
              "WEBSITE_CONTENTAZUREFILECONNECTIONSTRING": "[parameters('storageConnectionString')]",
              "WEBSITE_CONTENTSHARE": "[toLower(parameters('functionAppName'))]"
            },
            "flexConsumptionStorageSettings": {
              "AzureWebJobsStorage__accountName": "[parameters('storageAccountName')]"
            },
            "premiumStorageSettings": {
              "AzureWebJobsStorage__accountName": "[parameters('storageAccountName')]",
              "AzureWebJobsStorage__blobServiceUri": "[parameters('storageBlobEndpoint')]",
              "AzureWebJobsStorage__queueServiceUri": "[parameters('storageQueueEndpoint')]",
              "AzureWebJobsStorage__tableServiceUri": "[parameters('storageTableEndpoint')]"
            },
            "runtimeStorageSettings": "[if(parameters('isFlexConsumption'), variables('flexConsumptionStorageSettings'), if(variables('isLegacyConsumptionPlan'), variables('consumptionStorageSettings'), variables('premiumStorageSettings')))]",
            "runtimeSettings": "[if(parameters('isFlexConsumption'), createObject(), createObject('FUNCTIONS_EXTENSION_VERSION', '~4', 'FUNCTIONS_WORKER_RUNTIME', 'python'))]",
            "baseAppSettings": {
              "STORAGE_ACCOUNT_NAME": "[parameters('storageAccountName')]",
              "STORAGE_BLOB_ENDPOINT": "[parameters('storageBlobEndpoint')]",
              "STORAGE_QUEUE_ENDPOINT": "[parameters('storageQueueEndpoint')]",
              "STORAGE_TABLE_ENDPOINT": "[parameters('storageTableEndpoint')]",
              "KEY_VAULT_NAME": "[parameters('keyVaultName')]",
              "ENVIRONMENT": "production"
            },
            "appInsightsSettings": "[if(not(empty(parameters('appInsightsConnectionString'))), createObject('APPLICATIONINSIGHTS_CONNECTION_STRING', parameters('appInsightsConnectionString'), 'APPINSIGHTS_INSTRUMENTATIONKEY', parameters('appInsightsInstrumentationKey')), createObject())]",
            "appSettings": "[union(variables('runtimeStorageSettings'), variables('runtimeSettings'), variables('baseAppSettings'), variables('appInsightsSettings'), parameters('additionalAppSettings'))]"
          },
          "resources": [
            {
              "condition": "[not(parameters('isFlexConsumption'))]",
              "type": "Microsoft.Web/sites",
              "apiVersion": "2023-01-01",
              "name": "[parameters('functionAppName')]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]",
              "kind": "functionapp,linux",
              "identity": {
                "type": "SystemAssigned"
              },
              "properties": {
                "serverFarmId": "[parameters('appServicePlanId')]",
                "httpsOnly": true,
                "reserved": true,
                "siteConfig": {
                  "copy": [
                    {
                      "name": "appSettings",
                      "count": "[length(items(variables('appSettings')))]",
                      "input": {
                        "name": "[items(variables('appSettings'))[copyIndex('appSettings')].key]",
                        "value": "[string(items(variables('appSettings'))[copyIndex('appSettings')].value)]"
                      }
                    }
                  ],
                  "linuxFxVersion": "PYTHON|3.10",
                  "ftpsState": "Disabled",
                  "minTlsVersion": "1.2",
                  "cors": {
                    "allowedOrigins": "[variables('corsOrigins')]",
                    "supportCredentials": true
                  }
                }
              }
            },
            {
              "condition": "[parameters('isFlexConsumption')]",
              "type": "Microsoft.Web/sites",
              "apiVersion": "2024-04-01",
              "name": "[parameters('functionAppName')]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]",
              "kind": "functionapp,linux",
              "identity": {
                "type": "SystemAssigned"
              },
              "properties": {
                "serverFarmId": "[parameters('appServicePlanId')]",
                "httpsOnly": true,
                "reserved": true,
                "functionAppConfig": {
                  "deployment": {
                    "storage": {
                      "type": "blobContainer",
                      "value": "[format('{0}deployments-{1}', parameters('storageBlobEndpoint'), parameters('functionAppType'))]",
                      "authentication": {
                        "type": "SystemAssignedIdentity"
                      }
                    }
                  },
                  "scaleAndConcurrency": {
                    "maximumInstanceCount": "[parameters('maximumInstanceCount')]",
                    "instanceMemoryMB": "[parameters('instanceMemoryMB')]"
                  },
                  "runtime": {
                    "name": "python",
                    "version": "3.10"
                  }
                },
                "siteConfig": {
                  "copy": [
                    {
                      "name": "appSettings",
                      "count": "[length(items(variables('appSettings')))]",
                      "input": {
                        "name": "[items(variables('appSettings'))[copyIndex('appSettings')].key]",
                        "value": "[string(items(variables('appSettings'))[copyIndex('appSettings')].value)]"
                      }
                    }
                  ],
                  "ftpsState": "Disabled",
                  "minTlsVersion": "1.2",
                  "cors": {
                    "allowedOrigins": "[variables('corsOrigins')]",
                    "supportCredentials": true
                  }
                }
              }
            }
          ],
          "outputs": {
            "functionAppName": {
              "type": "string",
              "metadata": {
                "description": "Function App name"
              },
              "value": "[if(parameters('isFlexConsumption'), parameters('functionAppName'), parameters('functionAppName'))]"
            },
            "defaultHostname": {
              "type": "string",
              "metadata": {
                "description": "Function App default hostname"
              },
              "value": "[if(parameters('isFlexConsumption'), reference(resourceId('Microsoft.Web/sites', parameters('functionAppName')), '2024-04-01').defaultHostName, reference(resourceId('Microsoft.Web/sites', parameters('functionAppName')), '2023-01-01').defaultHostName)]"
            },
            "principalId": {
              "type": "string",
              "metadata": {
                "description": "Function App principal ID (Managed Identity)"
              },
              "value": "[if(parameters('isFlexConsumption'), reference(resourceId('Microsoft.Web/sites', parameters('functionAppName')), '2024-04-01', 'full').identity.principalId, reference(resourceId('Microsoft.Web/sites', parameters('functionAppName')), '2023-01-01', 'full').identity.principalId)]"
            },
            "resourceId": {
              "type": "string",
              "metadata": {
                "description": "Function App resource ID"
              },
              "value": "[if(parameters('isFlexConsumption'), resourceId('Microsoft.Web/sites', parameters('functionAppName')), resourceId('Microsoft.Web/sites', parameters('functionAppName')))]"
            },
            "isLegacyConsumptionPlan": {
              "type": "bool",
              "metadata": {
                "description": "Is using legacy Consumption plan (Y1)"
              },
              "value": "[variables('isLegacyConsumptionPlan')]"
            },
            "isFlexConsumptionPlan": {
              "type": "bool",
              "metadata": {
                "description": "Is using Flex Consumption plan (FC1)"
              },
              "value": "[parameters('isFlexConsumption')]"
            }
          }
        }
      },
      "dependsOn": [
        "[resourceId('Microsoft.Resources/deployments', 'appinsights-deployment')]",
        "[resourceId('Microsoft.Resources/deployments', 'appregistration-deployment')]",
        "[resourceId('Microsoft.Resources/deployments', 'appserviceplan-api-deployment')]",
        "[resourceId('Microsoft.Resources/deployments', 'appserviceplan-scheduler-deployment')]",
        "[resourceId('Microsoft.Resources/deployments', 'keyvault-deployment')]",
        "[resourceId('Microsoft.Resources/deployments', 'storage-deployment')]"
      ]
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "functionapp-processor-deployment",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "functionAppName": {
            "value": "[variables('functionAppProcessorName')]"
          },
          "functionAppType": {
            "value": "processor"
          },
          "location": {
            "value": "[parameters('location')]"
          },
          "tags": {
            "value": "[variables('tags')]"
          },
          "appServicePlanId": "[if(variables('isFlexConsumption'), createObject('value', reference(resourceId('Microsoft.Resources/deployments', 'appserviceplan-processor-deployment'), '2025-04-01').outputs.planId.value), createObject('value', reference(resourceId('Microsoft.Resources/deployments', 'appserviceplan-api-deployment'), '2025-04-01').outputs.planId.value))]",
          "sku": {
            "value": "[parameters('functionAppSku')]"
          },
          "isFlexConsumption": {
            "value": "[variables('isFlexConsumption')]"
          },
          "storageAccountName": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', 'storage-deployment'), '2025-04-01').outputs.storageAccountName.value]"
          },
          "storageConnectionString": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', 'storage-deployment'), '2025-04-01').outputs.connectionString.value]"
          },
          "storageBlobEndpoint": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', 'storage-deployment'), '2025-04-01').outputs.blobEndpoint.value]"
          },
          "storageQueueEndpoint": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', 'storage-deployment'), '2025-04-01').outputs.queueEndpoint.value]"
          },
          "storageTableEndpoint": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', 'storage-deployment'), '2025-04-01').outputs.tableEndpoint.value]"
          },
          "appInsightsConnectionString": "[if(parameters('enableAppInsights'), createObject('value', reference(resourceId('Microsoft.Resources/deployments', 'appinsights-deployment'), '2025-04-01').outputs.connectionString.value), createObject('value', ''))]",
          "appInsightsInstrumentationKey": "[if(parameters('enableAppInsights'), createObject('value', reference(resourceId('Microsoft.Resources/deployments', 'appinsights-deployment'), '2025-04-01').outputs.instrumentationKey.value), createObject('value', ''))]",
          "keyVaultName": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', 'keyvault-deployment'), '2025-04-01').outputs.keyVaultName.value]"
          },
          "additionalAppSettings": {
            "value": {
              "FUNCTION_APP_TYPE": "processor",
              "APP_VERSION": "[parameters('appVersion')]",
              "INSTALLATION_ID": "[variables('installationId')]",
              "AUTH_MODE": "[if(empty(if(not(empty(parameters('azureAdClientId'))), parameters('azureAdClientId'), if(parameters('skipAppRegistration'), '', if(reference(resourceId('Microsoft.Resources/deployments', 'appregistration-deployment'), '2025-04-01').outputs.success.value, reference(resourceId('Microsoft.Resources/deployments', 'appregistration-deployment'), '2025-04-01').outputs.clientId.value, '')))), 'mock', 'azure')]"
            }
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.39.26.7824",
              "templateHash": "7283587711428679460"
            }
          },
          "parameters": {
            "functionAppName": {
              "type": "string",
              "metadata": {
                "description": "Name of the Function App"
              }
            },
            "location": {
              "type": "string",
              "metadata": {
                "description": "Azure region"
              }
            },
            "tags": {
              "type": "object",
              "metadata": {
                "description": "Tags to apply"
              }
            },
            "appServicePlanId": {
              "type": "string",
              "metadata": {
                "description": "App Service Plan resource ID"
              }
            },
            "sku": {
              "type": "string",
              "metadata": {
                "description": "App Service Plan SKU (FC1, Y1, EP1, EP2, EP3)"
              }
            },
            "isFlexConsumption": {
              "type": "bool",
              "defaultValue": false,
              "metadata": {
                "description": "Is Flex Consumption plan"
              }
            },
            "maximumInstanceCount": {
              "type": "int",
              "defaultValue": 100,
              "metadata": {
                "description": "Maximum instance count for Flex Consumption"
              }
            },
            "instanceMemoryMB": {
              "type": "int",
              "defaultValue": 2048,
              "allowedValues": [
                2048,
                4096
              ],
              "metadata": {
                "description": "Instance memory in MB for Flex Consumption (2048 or 4096)"
              }
            },
            "storageAccountName": {
              "type": "string",
              "metadata": {
                "description": "Storage Account name"
              }
            },
            "storageConnectionString": {
              "type": "securestring",
              "metadata": {
                "description": "Storage Account connection string (for Y1/Consumption plan)"
              }
            },
            "storageBlobEndpoint": {
              "type": "string",
              "metadata": {
                "description": "Storage Account blob endpoint"
              }
            },
            "storageQueueEndpoint": {
              "type": "string",
              "metadata": {
                "description": "Storage Account queue endpoint"
              }
            },
            "storageTableEndpoint": {
              "type": "string",
              "metadata": {
                "description": "Storage Account table endpoint"
              }
            },
            "appInsightsConnectionString": {
              "type": "string",
              "defaultValue": "",
              "metadata": {
                "description": "Application Insights connection string"
              }
            },
            "appInsightsInstrumentationKey": {
              "type": "string",
              "defaultValue": "",
              "metadata": {
                "description": "Application Insights instrumentation key"
              }
            },
            "keyVaultName": {
              "type": "string",
              "metadata": {
                "description": "Key Vault name"
              }
            },
            "additionalAppSettings": {
              "type": "object",
              "defaultValue": {},
              "metadata": {
                "description": "Additional app settings"
              }
            },
            "frontendUrl": {
              "type": "string",
              "defaultValue": "",
              "metadata": {
                "description": "Frontend URL for CORS (specific origin required for credentials)"
              }
            },
            "functionAppType": {
              "type": "string",
              "defaultValue": "api",
              "allowedValues": [
                "api",
                "scheduler",
                "processor"
              ],
              "metadata": {
                "description": "Function App type (api, scheduler, processor) - used for unique deployment container"
              }
            }
          },
          "variables": {
            "corsOrigins": "[if(empty(parameters('frontendUrl')), createArray('https://portal.azure.com', 'http://localhost:3000', 'http://localhost:5173'), createArray('https://portal.azure.com', 'http://localhost:3000', 'http://localhost:5173', parameters('frontendUrl')))]",
            "isLegacyConsumptionPlan": "[equals(parameters('sku'), 'Y1')]",
            "consumptionStorageSettings": {
              "AzureWebJobsStorage": "[parameters('storageConnectionString')]",
              "WEBSITE_CONTENTAZUREFILECONNECTIONSTRING": "[parameters('storageConnectionString')]",
              "WEBSITE_CONTENTSHARE": "[toLower(parameters('functionAppName'))]"
            },
            "flexConsumptionStorageSettings": {
              "AzureWebJobsStorage__accountName": "[parameters('storageAccountName')]"
            },
            "premiumStorageSettings": {
              "AzureWebJobsStorage__accountName": "[parameters('storageAccountName')]",
              "AzureWebJobsStorage__blobServiceUri": "[parameters('storageBlobEndpoint')]",
              "AzureWebJobsStorage__queueServiceUri": "[parameters('storageQueueEndpoint')]",
              "AzureWebJobsStorage__tableServiceUri": "[parameters('storageTableEndpoint')]"
            },
            "runtimeStorageSettings": "[if(parameters('isFlexConsumption'), variables('flexConsumptionStorageSettings'), if(variables('isLegacyConsumptionPlan'), variables('consumptionStorageSettings'), variables('premiumStorageSettings')))]",
            "runtimeSettings": "[if(parameters('isFlexConsumption'), createObject(), createObject('FUNCTIONS_EXTENSION_VERSION', '~4', 'FUNCTIONS_WORKER_RUNTIME', 'python'))]",
            "baseAppSettings": {
              "STORAGE_ACCOUNT_NAME": "[parameters('storageAccountName')]",
              "STORAGE_BLOB_ENDPOINT": "[parameters('storageBlobEndpoint')]",
              "STORAGE_QUEUE_ENDPOINT": "[parameters('storageQueueEndpoint')]",
              "STORAGE_TABLE_ENDPOINT": "[parameters('storageTableEndpoint')]",
              "KEY_VAULT_NAME": "[parameters('keyVaultName')]",
              "ENVIRONMENT": "production"
            },
            "appInsightsSettings": "[if(not(empty(parameters('appInsightsConnectionString'))), createObject('APPLICATIONINSIGHTS_CONNECTION_STRING', parameters('appInsightsConnectionString'), 'APPINSIGHTS_INSTRUMENTATIONKEY', parameters('appInsightsInstrumentationKey')), createObject())]",
            "appSettings": "[union(variables('runtimeStorageSettings'), variables('runtimeSettings'), variables('baseAppSettings'), variables('appInsightsSettings'), parameters('additionalAppSettings'))]"
          },
          "resources": [
            {
              "condition": "[not(parameters('isFlexConsumption'))]",
              "type": "Microsoft.Web/sites",
              "apiVersion": "2023-01-01",
              "name": "[parameters('functionAppName')]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]",
              "kind": "functionapp,linux",
              "identity": {
                "type": "SystemAssigned"
              },
              "properties": {
                "serverFarmId": "[parameters('appServicePlanId')]",
                "httpsOnly": true,
                "reserved": true,
                "siteConfig": {
                  "copy": [
                    {
                      "name": "appSettings",
                      "count": "[length(items(variables('appSettings')))]",
                      "input": {
                        "name": "[items(variables('appSettings'))[copyIndex('appSettings')].key]",
                        "value": "[string(items(variables('appSettings'))[copyIndex('appSettings')].value)]"
                      }
                    }
                  ],
                  "linuxFxVersion": "PYTHON|3.10",
                  "ftpsState": "Disabled",
                  "minTlsVersion": "1.2",
                  "cors": {
                    "allowedOrigins": "[variables('corsOrigins')]",
                    "supportCredentials": true
                  }
                }
              }
            },
            {
              "condition": "[parameters('isFlexConsumption')]",
              "type": "Microsoft.Web/sites",
              "apiVersion": "2024-04-01",
              "name": "[parameters('functionAppName')]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]",
              "kind": "functionapp,linux",
              "identity": {
                "type": "SystemAssigned"
              },
              "properties": {
                "serverFarmId": "[parameters('appServicePlanId')]",
                "httpsOnly": true,
                "reserved": true,
                "functionAppConfig": {
                  "deployment": {
                    "storage": {
                      "type": "blobContainer",
                      "value": "[format('{0}deployments-{1}', parameters('storageBlobEndpoint'), parameters('functionAppType'))]",
                      "authentication": {
                        "type": "SystemAssignedIdentity"
                      }
                    }
                  },
                  "scaleAndConcurrency": {
                    "maximumInstanceCount": "[parameters('maximumInstanceCount')]",
                    "instanceMemoryMB": "[parameters('instanceMemoryMB')]"
                  },
                  "runtime": {
                    "name": "python",
                    "version": "3.10"
                  }
                },
                "siteConfig": {
                  "copy": [
                    {
                      "name": "appSettings",
                      "count": "[length(items(variables('appSettings')))]",
                      "input": {
                        "name": "[items(variables('appSettings'))[copyIndex('appSettings')].key]",
                        "value": "[string(items(variables('appSettings'))[copyIndex('appSettings')].value)]"
                      }
                    }
                  ],
                  "ftpsState": "Disabled",
                  "minTlsVersion": "1.2",
                  "cors": {
                    "allowedOrigins": "[variables('corsOrigins')]",
                    "supportCredentials": true
                  }
                }
              }
            }
          ],
          "outputs": {
            "functionAppName": {
              "type": "string",
              "metadata": {
                "description": "Function App name"
              },
              "value": "[if(parameters('isFlexConsumption'), parameters('functionAppName'), parameters('functionAppName'))]"
            },
            "defaultHostname": {
              "type": "string",
              "metadata": {
                "description": "Function App default hostname"
              },
              "value": "[if(parameters('isFlexConsumption'), reference(resourceId('Microsoft.Web/sites', parameters('functionAppName')), '2024-04-01').defaultHostName, reference(resourceId('Microsoft.Web/sites', parameters('functionAppName')), '2023-01-01').defaultHostName)]"
            },
            "principalId": {
              "type": "string",
              "metadata": {
                "description": "Function App principal ID (Managed Identity)"
              },
              "value": "[if(parameters('isFlexConsumption'), reference(resourceId('Microsoft.Web/sites', parameters('functionAppName')), '2024-04-01', 'full').identity.principalId, reference(resourceId('Microsoft.Web/sites', parameters('functionAppName')), '2023-01-01', 'full').identity.principalId)]"
            },
            "resourceId": {
              "type": "string",
              "metadata": {
                "description": "Function App resource ID"
              },
              "value": "[if(parameters('isFlexConsumption'), resourceId('Microsoft.Web/sites', parameters('functionAppName')), resourceId('Microsoft.Web/sites', parameters('functionAppName')))]"
            },
            "isLegacyConsumptionPlan": {
              "type": "bool",
              "metadata": {
                "description": "Is using legacy Consumption plan (Y1)"
              },
              "value": "[variables('isLegacyConsumptionPlan')]"
            },
            "isFlexConsumptionPlan": {
              "type": "bool",
              "metadata": {
                "description": "Is using Flex Consumption plan (FC1)"
              },
              "value": "[parameters('isFlexConsumption')]"
            }
          }
        }
      },
      "dependsOn": [
        "[resourceId('Microsoft.Resources/deployments', 'appinsights-deployment')]",
        "[resourceId('Microsoft.Resources/deployments', 'appregistration-deployment')]",
        "[resourceId('Microsoft.Resources/deployments', 'appserviceplan-api-deployment')]",
        "[resourceId('Microsoft.Resources/deployments', 'appserviceplan-processor-deployment')]",
        "[resourceId('Microsoft.Resources/deployments', 'keyvault-deployment')]",
        "[resourceId('Microsoft.Resources/deployments', 'storage-deployment')]"
      ]
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "rbac-all-assignments",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "storageAccountId": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', 'storage-deployment'), '2025-04-01').outputs.storageAccountId.value]"
          },
          "keyVaultId": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', 'keyvault-deployment'), '2025-04-01').outputs.keyVaultId.value]"
          },
          "apiPrincipalId": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', 'functionapp-api-deployment'), '2025-04-01').outputs.principalId.value]"
          },
          "schedulerPrincipalId": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', 'functionapp-scheduler-deployment'), '2025-04-01').outputs.principalId.value]"
          },
          "processorPrincipalId": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', 'functionapp-processor-deployment'), '2025-04-01').outputs.principalId.value]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.39.26.7824",
              "templateHash": "1558708535655222763"
            }
          },
          "parameters": {
            "storageAccountId": {
              "type": "string",
              "metadata": {
                "description": "Storage Account ID"
              }
            },
            "keyVaultId": {
              "type": "string",
              "metadata": {
                "description": "Key Vault ID"
              }
            },
            "apiPrincipalId": {
              "type": "string",
              "metadata": {
                "description": "API Function App Principal ID"
              }
            },
            "schedulerPrincipalId": {
              "type": "string",
              "metadata": {
                "description": "Scheduler Function App Principal ID"
              }
            },
            "processorPrincipalId": {
              "type": "string",
              "metadata": {
                "description": "Processor Function App Principal ID"
              }
            }
          },
          "variables": {
            "keyVaultSecretsOfficerRoleId": "b86a8fe4-44ce-4948-aee5-eccb2c155cd7",
            "storageBlobDataContributorRoleId": "ba92f5b4-2d11-453d-a403-e96b0029c9fe",
            "storageQueueDataContributorRoleId": "974c5e8b-45b9-4653-ba55-5f855dd0fb88",
            "storageTableDataContributorRoleId": "0a9a7e1f-b9d0-4cc4-a60d-0319b160aaa3"
          },
          "resources": [
            {
              "type": "Microsoft.Authorization/roleAssignments",
              "apiVersion": "2022-04-01",
              "scope": "[format('Microsoft.KeyVault/vaults/{0}', last(split(parameters('keyVaultId'), '/')))]",
              "name": "[guid(parameters('keyVaultId'), parameters('apiPrincipalId'), variables('keyVaultSecretsOfficerRoleId'))]",
              "properties": {
                "roleDefinitionId": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', variables('keyVaultSecretsOfficerRoleId'))]",
                "principalId": "[parameters('apiPrincipalId')]",
                "principalType": "ServicePrincipal"
              }
            },
            {
              "type": "Microsoft.Authorization/roleAssignments",
              "apiVersion": "2022-04-01",
              "scope": "[format('Microsoft.Storage/storageAccounts/{0}', last(split(parameters('storageAccountId'), '/')))]",
              "name": "[guid(parameters('storageAccountId'), parameters('apiPrincipalId'), variables('storageBlobDataContributorRoleId'))]",
              "properties": {
                "roleDefinitionId": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', variables('storageBlobDataContributorRoleId'))]",
                "principalId": "[parameters('apiPrincipalId')]",
                "principalType": "ServicePrincipal"
              }
            },
            {
              "type": "Microsoft.Authorization/roleAssignments",
              "apiVersion": "2022-04-01",
              "scope": "[format('Microsoft.Storage/storageAccounts/{0}', last(split(parameters('storageAccountId'), '/')))]",
              "name": "[guid(parameters('storageAccountId'), parameters('apiPrincipalId'), variables('storageQueueDataContributorRoleId'))]",
              "properties": {
                "roleDefinitionId": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', variables('storageQueueDataContributorRoleId'))]",
                "principalId": "[parameters('apiPrincipalId')]",
                "principalType": "ServicePrincipal"
              }
            },
            {
              "type": "Microsoft.Authorization/roleAssignments",
              "apiVersion": "2022-04-01",
              "scope": "[format('Microsoft.Storage/storageAccounts/{0}', last(split(parameters('storageAccountId'), '/')))]",
              "name": "[guid(parameters('storageAccountId'), parameters('apiPrincipalId'), variables('storageTableDataContributorRoleId'))]",
              "properties": {
                "roleDefinitionId": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', variables('storageTableDataContributorRoleId'))]",
                "principalId": "[parameters('apiPrincipalId')]",
                "principalType": "ServicePrincipal"
              }
            },
            {
              "type": "Microsoft.Authorization/roleAssignments",
              "apiVersion": "2022-04-01",
              "scope": "[format('Microsoft.KeyVault/vaults/{0}', last(split(parameters('keyVaultId'), '/')))]",
              "name": "[guid(parameters('keyVaultId'), parameters('schedulerPrincipalId'), variables('keyVaultSecretsOfficerRoleId'))]",
              "properties": {
                "roleDefinitionId": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', variables('keyVaultSecretsOfficerRoleId'))]",
                "principalId": "[parameters('schedulerPrincipalId')]",
                "principalType": "ServicePrincipal"
              }
            },
            {
              "type": "Microsoft.Authorization/roleAssignments",
              "apiVersion": "2022-04-01",
              "scope": "[format('Microsoft.Storage/storageAccounts/{0}', last(split(parameters('storageAccountId'), '/')))]",
              "name": "[guid(parameters('storageAccountId'), parameters('schedulerPrincipalId'), variables('storageBlobDataContributorRoleId'))]",
              "properties": {
                "roleDefinitionId": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', variables('storageBlobDataContributorRoleId'))]",
                "principalId": "[parameters('schedulerPrincipalId')]",
                "principalType": "ServicePrincipal"
              }
            },
            {
              "type": "Microsoft.Authorization/roleAssignments",
              "apiVersion": "2022-04-01",
              "scope": "[format('Microsoft.Storage/storageAccounts/{0}', last(split(parameters('storageAccountId'), '/')))]",
              "name": "[guid(parameters('storageAccountId'), parameters('schedulerPrincipalId'), variables('storageQueueDataContributorRoleId'))]",
              "properties": {
                "roleDefinitionId": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', variables('storageQueueDataContributorRoleId'))]",
                "principalId": "[parameters('schedulerPrincipalId')]",
                "principalType": "ServicePrincipal"
              }
            },
            {
              "type": "Microsoft.Authorization/roleAssignments",
              "apiVersion": "2022-04-01",
              "scope": "[format('Microsoft.Storage/storageAccounts/{0}', last(split(parameters('storageAccountId'), '/')))]",
              "name": "[guid(parameters('storageAccountId'), parameters('schedulerPrincipalId'), variables('storageTableDataContributorRoleId'))]",
              "properties": {
                "roleDefinitionId": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', variables('storageTableDataContributorRoleId'))]",
                "principalId": "[parameters('schedulerPrincipalId')]",
                "principalType": "ServicePrincipal"
              }
            },
            {
              "type": "Microsoft.Authorization/roleAssignments",
              "apiVersion": "2022-04-01",
              "scope": "[format('Microsoft.KeyVault/vaults/{0}', last(split(parameters('keyVaultId'), '/')))]",
              "name": "[guid(parameters('keyVaultId'), parameters('processorPrincipalId'), variables('keyVaultSecretsOfficerRoleId'))]",
              "properties": {
                "roleDefinitionId": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', variables('keyVaultSecretsOfficerRoleId'))]",
                "principalId": "[parameters('processorPrincipalId')]",
                "principalType": "ServicePrincipal"
              }
            },
            {
              "type": "Microsoft.Authorization/roleAssignments",
              "apiVersion": "2022-04-01",
              "scope": "[format('Microsoft.Storage/storageAccounts/{0}', last(split(parameters('storageAccountId'), '/')))]",
              "name": "[guid(parameters('storageAccountId'), parameters('processorPrincipalId'), variables('storageBlobDataContributorRoleId'))]",
              "properties": {
                "roleDefinitionId": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', variables('storageBlobDataContributorRoleId'))]",
                "principalId": "[parameters('processorPrincipalId')]",
                "principalType": "ServicePrincipal"
              }
            },
            {
              "type": "Microsoft.Authorization/roleAssignments",
              "apiVersion": "2022-04-01",
              "scope": "[format('Microsoft.Storage/storageAccounts/{0}', last(split(parameters('storageAccountId'), '/')))]",
              "name": "[guid(parameters('storageAccountId'), parameters('processorPrincipalId'), variables('storageQueueDataContributorRoleId'))]",
              "properties": {
                "roleDefinitionId": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', variables('storageQueueDataContributorRoleId'))]",
                "principalId": "[parameters('processorPrincipalId')]",
                "principalType": "ServicePrincipal"
              }
            },
            {
              "type": "Microsoft.Authorization/roleAssignments",
              "apiVersion": "2022-04-01",
              "scope": "[format('Microsoft.Storage/storageAccounts/{0}', last(split(parameters('storageAccountId'), '/')))]",
              "name": "[guid(parameters('storageAccountId'), parameters('processorPrincipalId'), variables('storageTableDataContributorRoleId'))]",
              "properties": {
                "roleDefinitionId": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', variables('storageTableDataContributorRoleId'))]",
                "principalId": "[parameters('processorPrincipalId')]",
                "principalType": "ServicePrincipal"
              }
            }
          ],
          "outputs": {
            "status": {
              "type": "string",
              "value": "Role assignments created"
            }
          }
        }
      },
      "dependsOn": [
        "[resourceId('Microsoft.Resources/deployments', 'functionapp-api-deployment')]",
        "[resourceId('Microsoft.Resources/deployments', 'functionapp-processor-deployment')]",
        "[resourceId('Microsoft.Resources/deployments', 'functionapp-scheduler-deployment')]",
        "[resourceId('Microsoft.Resources/deployments', 'keyvault-deployment')]",
        "[resourceId('Microsoft.Resources/deployments', 'storage-deployment')]"
      ]
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "code-deployment",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "location": {
            "value": "[parameters('location')]"
          },
          "tags": {
            "value": "[variables('tags')]"
          },
          "identityId": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', 'deployment-identity'), '2025-04-01').outputs.identityId.value]"
          },
          "version": {
            "value": "[parameters('appVersion')]"
          },
          "apiFunctionAppName": {
            "value": "[variables('functionAppApiName')]"
          },
          "schedulerFunctionAppName": {
            "value": "[variables('functionAppSchedulerName')]"
          },
          "processorFunctionAppName": {
            "value": "[variables('functionAppProcessorName')]"
          },
          "resourceGroupName": {
            "value": "[resourceGroup().name]"
          },
          "apiBaseUrl": {
            "value": "[format('https://{0}.azurewebsites.net/api', variables('functionAppApiName'))]"
          },
          "azureAdTenantId": {
            "value": "[variables('tenantId')]"
          },
          "azureAdClientId": "[if(not(empty(parameters('azureAdClientId'))), createObject('value', parameters('azureAdClientId')), if(parameters('skipAppRegistration'), createObject('value', ''), if(reference(resourceId('Microsoft.Resources/deployments', 'appregistration-deployment'), '2025-04-01').outputs.success.value, createObject('value', reference(resourceId('Microsoft.Resources/deployments', 'appregistration-deployment'), '2025-04-01').outputs.clientId.value), createObject('value', ''))))]",
          "storageAccountName": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', 'storage-deployment'), '2025-04-01').outputs.storageAccountName.value]"
          },
          "storageBlobEndpoint": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', 'storage-deployment'), '2025-04-01').outputs.blobEndpoint.value]"
          },
          "isFlexConsumption": {
            "value": "[variables('isFlexConsumption')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.39.26.7824",
              "templateHash": "18393453924595370695"
            }
          },
          "parameters": {
            "location": {
              "type": "string",
              "metadata": {
                "description": "Azure region"
              }
            },
            "tags": {
              "type": "object",
              "metadata": {
                "description": "Tags to apply"
              }
            },
            "identityId": {
              "type": "string",
              "metadata": {
                "description": "User-assigned Managed Identity ID for running the script"
              }
            },
            "gitHubRepo": {
              "type": "string",
              "defaultValue": "pablodiloreto/dilux-azure-databases-backup-alpha",
              "metadata": {
                "description": "GitHub repository (owner/repo)"
              }
            },
            "version": {
              "type": "string",
              "metadata": {
                "description": "Version to deploy (GitHub release tag)"
              }
            },
            "apiFunctionAppName": {
              "type": "string",
              "metadata": {
                "description": "API Function App name"
              }
            },
            "schedulerFunctionAppName": {
              "type": "string",
              "metadata": {
                "description": "Scheduler Function App name"
              }
            },
            "processorFunctionAppName": {
              "type": "string",
              "metadata": {
                "description": "Processor Function App name"
              }
            },
            "resourceGroupName": {
              "type": "string",
              "metadata": {
                "description": "Resource group name"
              }
            },
            "apiBaseUrl": {
              "type": "string",
              "metadata": {
                "description": "API base URL for frontend build"
              }
            },
            "azureAdTenantId": {
              "type": "string",
              "defaultValue": "",
              "metadata": {
                "description": "Azure AD Tenant ID for authentication"
              }
            },
            "azureAdClientId": {
              "type": "string",
              "defaultValue": "",
              "metadata": {
                "description": "Azure AD Client ID for authentication"
              }
            },
            "storageAccountName": {
              "type": "string",
              "defaultValue": "",
              "metadata": {
                "description": "Storage Account name for uploading frontend ZIP"
              }
            },
            "storageBlobEndpoint": {
              "type": "string",
              "defaultValue": "",
              "metadata": {
                "description": "Storage Account blob endpoint"
              }
            },
            "isFlexConsumption": {
              "type": "bool",
              "defaultValue": false,
              "metadata": {
                "description": "Is Flex Consumption plan (requires different deployment method)"
              }
            }
          },
          "resources": [
            {
              "type": "Microsoft.Resources/deploymentScripts",
              "apiVersion": "2023-08-01",
              "name": "deploy-application-code",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]",
              "kind": "AzureCLI",
              "identity": {
                "type": "UserAssigned",
                "userAssignedIdentities": {
                  "[format('{0}', parameters('identityId'))]": {}
                }
              },
              "properties": {
                "azCliVersion": "2.50.0",
                "timeout": "PT30M",
                "retentionInterval": "PT1H",
                "cleanupPreference": "OnSuccess",
                "environmentVariables": [
                  {
                    "name": "GITHUB_REPO",
                    "value": "[parameters('gitHubRepo')]"
                  },
                  {
                    "name": "VERSION",
                    "value": "[parameters('version')]"
                  },
                  {
                    "name": "API_FUNCTION_APP_NAME",
                    "value": "[parameters('apiFunctionAppName')]"
                  },
                  {
                    "name": "SCHEDULER_FUNCTION_APP_NAME",
                    "value": "[parameters('schedulerFunctionAppName')]"
                  },
                  {
                    "name": "PROCESSOR_FUNCTION_APP_NAME",
                    "value": "[parameters('processorFunctionAppName')]"
                  },
                  {
                    "name": "RESOURCE_GROUP",
                    "value": "[parameters('resourceGroupName')]"
                  },
                  {
                    "name": "API_BASE_URL",
                    "value": "[parameters('apiBaseUrl')]"
                  },
                  {
                    "name": "AZURE_AD_TENANT_ID",
                    "value": "[parameters('azureAdTenantId')]"
                  },
                  {
                    "name": "AZURE_AD_CLIENT_ID",
                    "value": "[parameters('azureAdClientId')]"
                  },
                  {
                    "name": "STORAGE_ACCOUNT_NAME",
                    "value": "[parameters('storageAccountName')]"
                  },
                  {
                    "name": "STORAGE_BLOB_ENDPOINT",
                    "value": "[parameters('storageBlobEndpoint')]"
                  },
                  {
                    "name": "IS_FLEX_CONSUMPTION",
                    "value": "[string(parameters('isFlexConsumption'))]"
                  }
                ],
                "scriptContent": "#!/bin/bash\nset -e\n\necho \"==========================================\"\necho \"Deploying Dilux Database Backup\"\necho \"==========================================\"\n\n# Function to deploy with remote build (for Y1/EP* plans)\ndeploy_with_remote_build() {\n  local app_name=$1\n  local zip_file=$2\n  local max_attempts=5\n  local attempt=1\n  local wait_time=30\n\n  # Enable remote build settings\n  echo \"    Configuring remote build...\"\n  az functionapp config appsettings set \\\n    --name $app_name \\\n    --resource-group $RESOURCE_GROUP \\\n    --settings \"SCM_DO_BUILD_DURING_DEPLOYMENT=true\" \"ENABLE_ORYX_BUILD=true\" \\\n    -o none 2>&1 || true\n\n  while [ $attempt -le $max_attempts ]; do\n    echo \"    Attempt $attempt of $max_attempts (with remote build)...\"\n\n    # Use --build-remote true to install dependencies on Azure\n    if az functionapp deployment source config-zip \\\n      --resource-group $RESOURCE_GROUP \\\n      --name $app_name \\\n      --src $zip_file \\\n      --build-remote true \\\n      --timeout 600 2>&1; then\n      echo \"    Success! (dependencies installed via remote build)\"\n      return 0\n    fi\n\n    if [ $attempt -lt $max_attempts ]; then\n      echo \"    Failed. Waiting ${wait_time}s for RBAC propagation...\"\n      sleep $wait_time\n      wait_time=$((wait_time + 30))\n    fi\n\n    attempt=$((attempt + 1))\n  done\n\n  echo \"    ERROR: Failed after $max_attempts attempts\"\n  return 1\n}\n\n# Function to deploy Function App (for Y1/EP* plans only)\n# FC1 uses OneDeploy via Bicep, not this function\ndeploy_function_app() {\n  local app_name=$1\n  local zip_file=$2\n\n  deploy_with_remote_build $app_name $zip_file\n}\n\n# Resolve \"latest\" to actual version tag using GitHub API\nif [ \"$VERSION\" == \"latest\" ]; then\n  echo \"Resolving latest release from GitHub...\"\n\n  RELEASE_INFO=$(curl -s \"https://api.github.com/repos/$GITHUB_REPO/releases/latest\")\n  RESOLVED_VERSION=$(echo \"$RELEASE_INFO\" | grep '\"tag_name\"' | head -1 | sed -E 's/.*\"tag_name\": *\"([^\"]+)\".*/\\1/')\n\n  if [ -z \"$RESOLVED_VERSION\" ] || [ \"$RESOLVED_VERSION\" == \"null\" ]; then\n    echo \"ERROR: Could not resolve latest release\"\n    echo \"Make sure the repository has at least one published release.\"\n    echo '{\"status\": \"failed\", \"error\": \"No releases found\"}' > $AZ_SCRIPTS_OUTPUT_PATH\n    exit 1\n  fi\n\n  echo \"Resolved latest to: $RESOLVED_VERSION\"\n  VERSION=$RESOLVED_VERSION\nfi\n\necho \"Version: $VERSION\"\necho \"Repository: $GITHUB_REPO\"\necho \"==========================================\"\n\n# Base URL for release assets\nRELEASE_URL=\"https://github.com/$GITHUB_REPO/releases/download/$VERSION\"\n\necho \"\"\necho \"Downloading pre-built release assets from:\"\necho \"$RELEASE_URL\"\necho \"\"\n\n# Download all ZIPs (frontend + 3 Function Apps)\necho \"[1/4] Downloading frontend.zip...\"\nif ! curl -L -f -s -o frontend.zip \"$RELEASE_URL/frontend.zip\"; then\n  echo \"ERROR: Could not download frontend.zip\"\n  echo \"URL: $RELEASE_URL/frontend.zip\"\n  echo \"\"\n  echo \"Make sure:\"\n  echo \"1. The release $VERSION exists\"\n  echo \"2. The release has frontend.zip, api.zip, scheduler.zip, processor.zip assets\"\n  echo \"3. Run the Build Release Assets GitHub Action first\"\n  echo \"\"\n  echo '{\"status\": \"failed\", \"error\": \"Could not download frontend.zip\"}' > $AZ_SCRIPTS_OUTPUT_PATH\n  exit 1\nfi\necho \"    Downloaded frontend.zip\"\n\necho \"[2/4] Downloading api.zip...\"\nif ! curl -L -f -s -o api.zip \"$RELEASE_URL/api.zip\"; then\n  echo \"ERROR: Could not download api.zip\"\n  echo '{\"status\": \"failed\", \"error\": \"Could not download api.zip\"}' > $AZ_SCRIPTS_OUTPUT_PATH\n  exit 1\nfi\necho \"    Downloaded api.zip\"\n\necho \"[3/4] Downloading scheduler.zip...\"\nif ! curl -L -f -s -o scheduler.zip \"$RELEASE_URL/scheduler.zip\"; then\n  echo \"ERROR: Could not download scheduler.zip\"\n  echo '{\"status\": \"failed\", \"error\": \"Could not download scheduler.zip\"}' > $AZ_SCRIPTS_OUTPUT_PATH\n  exit 1\nfi\necho \"    Downloaded scheduler.zip\"\n\necho \"[4/4] Downloading processor.zip...\"\nif ! curl -L -f -s -o processor.zip \"$RELEASE_URL/processor.zip\"; then\n  echo \"ERROR: Could not download processor.zip\"\n  echo '{\"status\": \"failed\", \"error\": \"Could not download processor.zip\"}' > $AZ_SCRIPTS_OUTPUT_PATH\n  exit 1\nfi\necho \"    Downloaded processor.zip\"\n\necho \"\"\necho \"All assets downloaded successfully:\"\nls -lh *.zip\necho \"\"\n\n# ========================================\n# Wait for RBAC propagation\n# ========================================\necho \"==========================================\"\necho \"Waiting for RBAC permissions to propagate...\"\necho \"==========================================\"\necho \"(Azure AD role assignments can take up to 1 minute to propagate)\"\nsleep 60\necho \"Waited 60 seconds.\"\necho \"Starting deployment...\"\necho \"\"\n\n# ========================================\n# Deploy Frontend to Blob Storage Static Website\n# ========================================\necho \"==========================================\"\necho \"Deploying Frontend to Blob Storage Static Website...\"\necho \"==========================================\"\necho \"\"\n\n# Get storage account\nif [ -n \"$STORAGE_ACCOUNT_NAME\" ]; then\n  STORAGE_ACCOUNT=\"$STORAGE_ACCOUNT_NAME\"\nelse\n  STORAGE_ACCOUNT=$(az storage account list --resource-group $RESOURCE_GROUP --query \"[0].name\" -o tsv 2>/dev/null || echo \"\")\nfi\n\nif [ -z \"$STORAGE_ACCOUNT\" ]; then\n  echo \"ERROR: Could not find storage account\"\n  FRONTEND_DEPLOYED=false\n  FRONTEND_URL=\"\"\nelse\n  echo \"Storage Account: $STORAGE_ACCOUNT\"\n\n  # Get storage account key\n  echo \"Getting storage account key...\"\n  ACCOUNT_KEY=$(az storage account keys list --account-name $STORAGE_ACCOUNT --resource-group $RESOURCE_GROUP --query \"[0].value\" -o tsv 2>/dev/null)\n\n  if [ -z \"$ACCOUNT_KEY\" ]; then\n    echo \"ERROR: Could not get storage account key\"\n    FRONTEND_DEPLOYED=false\n    FRONTEND_URL=\"\"\n  else\n    # Enable static website on storage account\n    echo \"Enabling static website on storage account...\"\n    az storage blob service-properties update \\\n      --account-name $STORAGE_ACCOUNT \\\n      --account-key \"$ACCOUNT_KEY\" \\\n      --static-website \\\n      --index-document index.html \\\n      --404-document index.html \\\n      --only-show-errors\n\n    echo \"    Static website enabled\"\n\n    # Get the static website URL\n    FRONTEND_URL=$(az storage account show \\\n      --name $STORAGE_ACCOUNT \\\n      --resource-group $RESOURCE_GROUP \\\n      --query \"primaryEndpoints.web\" -o tsv 2>/dev/null | sed 's:/*$::')\n\n    echo \"    Static Website URL: $FRONTEND_URL\"\n\n    # Extract frontend.zip\n    echo \"Extracting frontend.zip...\"\n    mkdir -p frontend_dist\n    unzip -q frontend.zip -d frontend_dist\n\n    # Determine auth mode based on client ID availability\n    if [ -n \"$AZURE_AD_CLIENT_ID\" ] && [ \"$AZURE_AD_CLIENT_ID\" != \"\" ]; then\n      AUTH_MODE=\"azure\"\n\n      # Clean up mock users from Table Storage to allow real \"first run\"\n      # This prevents the dev-user from blocking real Azure AD users\n      echo \"    Cleaning up mock users from Table Storage...\"\n\n      # Delete mock dev user if exists (RowKey = dev-user-00000000-0000-0000-0000-000000000000)\n      az storage entity delete \\\n        --account-name $STORAGE_ACCOUNT \\\n        --account-key \"$ACCOUNT_KEY\" \\\n        --table-name users \\\n        --partition-key \"users\" \\\n        --row-key \"dev-user-00000000-0000-0000-0000-000000000000\" \\\n        2>/dev/null || true\n\n      echo \"    Mock users cleaned up (first login will be admin)\"\n    else\n      AUTH_MODE=\"mock\"\n    fi\n\n    # Generate config.json with runtime configuration\n    echo \"Generating config.json for runtime configuration...\"\n    cat > frontend_dist/config.json << CONFIGEOF\n{\n  \"apiUrl\": \"$API_BASE_URL\",\n  \"azureClientId\": \"$AZURE_AD_CLIENT_ID\",\n  \"azureTenantId\": \"$AZURE_AD_TENANT_ID\",\n  \"azureRedirectUri\": \"$FRONTEND_URL\",\n  \"authMode\": \"$AUTH_MODE\"\n}\nCONFIGEOF\n\n    echo \"    config.json created:\"\n    cat frontend_dist/config.json\n    echo \"\"\n\n    # Upload all files to $web container using batch upload\n    echo \"Uploading frontend files to \\$web container...\"\n\n    az storage blob upload-batch \\\n      --account-name $STORAGE_ACCOUNT \\\n      --account-key \"$ACCOUNT_KEY\" \\\n      --destination '$web' \\\n      --source frontend_dist \\\n      --overwrite \\\n      --only-show-errors 2>/dev/null\n\n    echo \"    Frontend files uploaded successfully!\"\n    FRONTEND_DEPLOYED=true\n  fi\nfi\n\necho \"\"\n\n# ========================================\n# Deploy Function Apps\n# ========================================\necho \"==========================================\"\necho \"Deploying Function Apps...\"\necho \"==========================================\"\n\necho \"\"\nIS_FLEX_LOWER=$(echo \"$IS_FLEX_CONSUMPTION\" | tr '[:upper:]' '[:lower:]')\n\n# Get API URL for output (used in both paths)\nAPI_URL=$(az functionapp show \\\n  --name $API_FUNCTION_APP_NAME \\\n  --resource-group $RESOURCE_GROUP \\\n  --query \"defaultHostName\" -o tsv 2>/dev/null || echo \"\")\n\nif [ \"$IS_FLEX_LOWER\" == \"true\" ]; then\n  # ========================================\n  # FC1: OneDeploy fetches directly from GitHub (no upload needed)\n  # ========================================\n  echo \"Deployment mode: Flex Consumption (OneDeploy via Bicep)\"\n  echo \"\"\n  echo \"Function App deployment will be handled by Bicep OneDeploy modules.\"\n  echo \"OneDeploy will fetch packages directly from GitHub release: $VERSION\"\n  echo \"\"\n  echo \"This script only deploys the frontend for FC1.\"\n  FUNCTION_APPS_DEPLOYED=false\nelse\n  # ========================================\n  # Y1/EP*: Deploy directly via config-zip with remote build\n  # ========================================\n  echo \"Deployment mode: Standard (config-zip --build-remote)\"\n  echo \"\"\n\n  echo \"[1/3] Deploying API Function App: $API_FUNCTION_APP_NAME\"\n  if ! deploy_function_app $API_FUNCTION_APP_NAME api.zip; then\n    echo '{\"status\": \"failed\", \"error\": \"Failed to deploy API Function App\"}' > $AZ_SCRIPTS_OUTPUT_PATH\n    exit 1\n  fi\n\n  echo \"\"\n  echo \"[2/3] Deploying Scheduler Function App: $SCHEDULER_FUNCTION_APP_NAME\"\n  if ! deploy_function_app $SCHEDULER_FUNCTION_APP_NAME scheduler.zip; then\n    echo '{\"status\": \"failed\", \"error\": \"Failed to deploy Scheduler Function App\"}' > $AZ_SCRIPTS_OUTPUT_PATH\n    exit 1\n  fi\n\n  echo \"\"\n  echo \"[3/3] Deploying Processor Function App: $PROCESSOR_FUNCTION_APP_NAME\"\n  if ! deploy_function_app $PROCESSOR_FUNCTION_APP_NAME processor.zip; then\n    echo '{\"status\": \"failed\", \"error\": \"Failed to deploy Processor Function App\"}' > $AZ_SCRIPTS_OUTPUT_PATH\n    exit 1\n  fi\n\n  FUNCTION_APPS_DEPLOYED=true\nfi\n\n# ========================================\n# Configure CORS for API Function App\n# ========================================\nif [ -n \"$FRONTEND_URL\" ]; then\n  echo \"\"\n  echo \"==========================================\"\n  echo \"Configuring CORS...\"\n  echo \"==========================================\"\n\n  # Add specific frontend URL to CORS (required for credentials)\n  az functionapp cors add \\\n    --name $API_FUNCTION_APP_NAME \\\n    --resource-group $RESOURCE_GROUP \\\n    --allowed-origins \"$FRONTEND_URL\" \\\n    -o none 2>/dev/null && echo \"    CORS configured for $FRONTEND_URL\" || echo \"    CORS may already be configured\"\nfi\n\necho \"\"\necho \"==========================================\"\necho \"SCRIPT COMPLETE\"\necho \"==========================================\"\necho \"\"\n\nif [ \"$IS_FLEX_LOWER\" == \"true\" ]; then\n  echo \"Frontend deployed successfully!\"\n  echo \"OneDeploy will now deploy the Function Apps via Bicep...\"\n  echo \"(Fetching packages directly from GitHub release: $VERSION)\"\n  echo \"\"\n  echo \"URLs (Function Apps will be available after OneDeploy completes):\"\nelse\n  echo \"All components deployed successfully!\"\n  echo \"\"\n  echo \"URLs:\"\nfi\necho \"  Frontend: $FRONTEND_URL\"\necho \"  API:      https://$API_URL\"\necho \"\"\n\nif [ \"$FRONTEND_DEPLOYED\" != true ]; then\n  echo \"NOTE: Frontend deployment failed.\"\n  echo \"Check the storage account permissions and try again.\"\n  echo \"\"\nfi\n\n# Output results\nif [ \"$IS_FLEX_LOWER\" == \"true\" ]; then\n  cat > $AZ_SCRIPTS_OUTPUT_PATH << EOF\n{\n  \"status\": \"success\",\n  \"version\": \"$VERSION\",\n  \"frontendDeployed\": $FRONTEND_DEPLOYED,\n  \"oneDeployPending\": true,\n  \"apiUrl\": \"https://$API_URL\",\n  \"frontendUrl\": \"$FRONTEND_URL\"\n}\nEOF\nelse\n  cat > $AZ_SCRIPTS_OUTPUT_PATH << EOF\n{\n  \"status\": \"success\",\n  \"version\": \"$VERSION\",\n  \"frontendDeployed\": $FRONTEND_DEPLOYED,\n  \"functionAppsDeployed\": true,\n  \"apiUrl\": \"https://$API_URL\",\n  \"frontendUrl\": \"$FRONTEND_URL\"\n}\nEOF\nfi\n    "
              }
            }
          ],
          "outputs": {
            "status": {
              "type": "string",
              "metadata": {
                "description": "Deployment script status"
              },
              "value": "[reference(resourceId('Microsoft.Resources/deploymentScripts', 'deploy-application-code'), '2023-08-01').provisioningState]"
            },
            "deployedVersion": {
              "type": "string",
              "metadata": {
                "description": "Deployed version"
              },
              "value": "[parameters('version')]"
            }
          }
        }
      },
      "dependsOn": [
        "[resourceId('Microsoft.Resources/deployments', 'appregistration-deployment')]",
        "[resourceId('Microsoft.Resources/deployments', 'deployment-identity')]",
        "[resourceId('Microsoft.Resources/deployments', 'functionapp-api-deployment')]",
        "[resourceId('Microsoft.Resources/deployments', 'functionapp-processor-deployment')]",
        "[resourceId('Microsoft.Resources/deployments', 'functionapp-scheduler-deployment')]",
        "[resourceId('Microsoft.Resources/deployments', 'rbac-all-assignments')]",
        "[resourceId('Microsoft.Resources/deployments', 'rbac-deployment-contributor')]",
        "[resourceId('Microsoft.Resources/deployments', 'rbac-deployment-storage')]",
        "[resourceId('Microsoft.Resources/deployments', 'storage-deployment')]"
      ]
    },
    {
      "condition": "[variables('isFlexConsumption')]",
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "deploy-api-code",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "functionAppName": {
            "value": "[variables('functionAppApiName')]"
          },
          "packageUri": {
            "value": "[format('{0}/api.zip', variables('gitHubReleaseUrl'))]"
          },
          "remoteBuild": {
            "value": true
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.39.26.7824",
              "templateHash": "16945624681606733019"
            }
          },
          "parameters": {
            "functionAppName": {
              "type": "string",
              "metadata": {
                "description": "Function App name"
              }
            },
            "packageUri": {
              "type": "string",
              "metadata": {
                "description": "Package URI (blob URL with SAS token or accessible via managed identity)"
              }
            },
            "remoteBuild": {
              "type": "bool",
              "defaultValue": true,
              "metadata": {
                "description": "Enable remote build (required for Python)"
              }
            }
          },
          "resources": [
            {
              "type": "Microsoft.Web/sites/extensions",
              "apiVersion": "2022-09-01",
              "name": "[format('{0}/{1}', parameters('functionAppName'), 'onedeploy')]",
              "properties": {
                "packageUri": "[parameters('packageUri')]",
                "remoteBuild": "[parameters('remoteBuild')]"
              }
            }
          ],
          "outputs": {
            "deploymentStatus": {
              "type": "string",
              "value": "[format('OneDeploy initiated for {0}', parameters('functionAppName'))]"
            }
          }
        }
      },
      "dependsOn": [
        "[resourceId('Microsoft.Resources/deployments', 'code-deployment')]"
      ]
    },
    {
      "condition": "[variables('isFlexConsumption')]",
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "deploy-scheduler-code",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "functionAppName": {
            "value": "[variables('functionAppSchedulerName')]"
          },
          "packageUri": {
            "value": "[format('{0}/scheduler.zip', variables('gitHubReleaseUrl'))]"
          },
          "remoteBuild": {
            "value": true
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.39.26.7824",
              "templateHash": "16945624681606733019"
            }
          },
          "parameters": {
            "functionAppName": {
              "type": "string",
              "metadata": {
                "description": "Function App name"
              }
            },
            "packageUri": {
              "type": "string",
              "metadata": {
                "description": "Package URI (blob URL with SAS token or accessible via managed identity)"
              }
            },
            "remoteBuild": {
              "type": "bool",
              "defaultValue": true,
              "metadata": {
                "description": "Enable remote build (required for Python)"
              }
            }
          },
          "resources": [
            {
              "type": "Microsoft.Web/sites/extensions",
              "apiVersion": "2022-09-01",
              "name": "[format('{0}/{1}', parameters('functionAppName'), 'onedeploy')]",
              "properties": {
                "packageUri": "[parameters('packageUri')]",
                "remoteBuild": "[parameters('remoteBuild')]"
              }
            }
          ],
          "outputs": {
            "deploymentStatus": {
              "type": "string",
              "value": "[format('OneDeploy initiated for {0}', parameters('functionAppName'))]"
            }
          }
        }
      },
      "dependsOn": [
        "[resourceId('Microsoft.Resources/deployments', 'code-deployment')]"
      ]
    },
    {
      "condition": "[variables('isFlexConsumption')]",
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "deploy-processor-code",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "functionAppName": {
            "value": "[variables('functionAppProcessorName')]"
          },
          "packageUri": {
            "value": "[format('{0}/processor.zip', variables('gitHubReleaseUrl'))]"
          },
          "remoteBuild": {
            "value": true
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.39.26.7824",
              "templateHash": "16945624681606733019"
            }
          },
          "parameters": {
            "functionAppName": {
              "type": "string",
              "metadata": {
                "description": "Function App name"
              }
            },
            "packageUri": {
              "type": "string",
              "metadata": {
                "description": "Package URI (blob URL with SAS token or accessible via managed identity)"
              }
            },
            "remoteBuild": {
              "type": "bool",
              "defaultValue": true,
              "metadata": {
                "description": "Enable remote build (required for Python)"
              }
            }
          },
          "resources": [
            {
              "type": "Microsoft.Web/sites/extensions",
              "apiVersion": "2022-09-01",
              "name": "[format('{0}/{1}', parameters('functionAppName'), 'onedeploy')]",
              "properties": {
                "packageUri": "[parameters('packageUri')]",
                "remoteBuild": "[parameters('remoteBuild')]"
              }
            }
          ],
          "outputs": {
            "deploymentStatus": {
              "type": "string",
              "value": "[format('OneDeploy initiated for {0}', parameters('functionAppName'))]"
            }
          }
        }
      },
      "dependsOn": [
        "[resourceId('Microsoft.Resources/deployments', 'code-deployment')]"
      ]
    }
  ],
  "outputs": {
    "apiUrl": {
      "type": "string",
      "metadata": {
        "description": "URL of the API Function App"
      },
      "value": "[format('https://{0}.azurewebsites.net', variables('functionAppApiName'))]"
    },
    "frontendUrl": {
      "type": "string",
      "metadata": {
        "description": "URL of the Frontend (Blob Storage Static Website - check deployment logs for exact URL)"
      },
      "value": "See deployment logs for frontend URL (Blob Storage Static Website)"
    },
    "storageAccountName": {
      "type": "string",
      "metadata": {
        "description": "Storage Account name"
      },
      "value": "[reference(resourceId('Microsoft.Resources/deployments', 'storage-deployment'), '2025-04-01').outputs.storageAccountName.value]"
    },
    "keyVaultName": {
      "type": "string",
      "metadata": {
        "description": "Key Vault name"
      },
      "value": "[reference(resourceId('Microsoft.Resources/deployments', 'keyvault-deployment'), '2025-04-01').outputs.keyVaultName.value]"
    },
    "appInsightsName": {
      "type": "string",
      "metadata": {
        "description": "Application Insights name"
      },
      "value": "[if(parameters('enableAppInsights'), reference(resourceId('Microsoft.Resources/deployments', 'appinsights-deployment'), '2025-04-01').outputs.appInsightsName.value, 'Not deployed')]"
    },
    "installationId": {
      "type": "string",
      "metadata": {
        "description": "Installation ID (unique identifier for this deployment)"
      },
      "value": "[variables('installationId')]"
    },
    "appVersion": {
      "type": "string",
      "metadata": {
        "description": "Application version"
      },
      "value": "[parameters('appVersion')]"
    },
    "adminEmail": {
      "type": "string",
      "metadata": {
        "description": "Admin email configured"
      },
      "value": "[parameters('adminEmail')]"
    },
    "azureAdClientId": {
      "type": "string",
      "metadata": {
        "description": "Azure AD Client ID (empty if manual setup required)"
      },
      "value": "[if(not(empty(parameters('azureAdClientId'))), parameters('azureAdClientId'), if(parameters('skipAppRegistration'), '', if(reference(resourceId('Microsoft.Resources/deployments', 'appregistration-deployment'), '2025-04-01').outputs.success.value, reference(resourceId('Microsoft.Resources/deployments', 'appregistration-deployment'), '2025-04-01').outputs.clientId.value, '')))]"
    },
    "azureAdTenantId": {
      "type": "string",
      "metadata": {
        "description": "Azure AD Tenant ID"
      },
      "value": "[variables('tenantId')]"
    },
    "appRegistrationSuccess": {
      "type": "bool",
      "metadata": {
        "description": "App Registration created successfully"
      },
      "value": "[if(parameters('skipAppRegistration'), false(), reference(resourceId('Microsoft.Resources/deployments', 'appregistration-deployment'), '2025-04-01').outputs.success.value)]"
    },
    "nextSteps": {
      "type": "string",
      "metadata": {
        "description": "Next steps message"
      },
      "value": "[if(or(parameters('skipAppRegistration'), not(reference(resourceId('Microsoft.Resources/deployments', 'appregistration-deployment'), '2025-04-01').outputs.success.value)), 'Auth not configured. Run: curl -sL https://raw.githubusercontent.com/pablodiloreto/dilux-azure-databases-backup-alpha/main/scripts/configure-auth.sh | bash', 'Deployment complete! Frontend URL in outputs.')]"
    },
    "codeDeploymentStatus": {
      "type": "string",
      "metadata": {
        "description": "Code deployment status"
      },
      "value": "[reference(resourceId('Microsoft.Resources/deployments', 'code-deployment'), '2025-04-01').outputs.status.value]"
    }
  }
}