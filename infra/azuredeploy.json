{
  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "metadata": {
    "_generator": {
      "name": "bicep",
      "version": "0.39.26.7824",
      "templateHash": "2908706952175973265"
    }
  },
  "parameters": {
    "appName": {
      "type": "string",
      "minLength": 3,
      "maxLength": 20,
      "metadata": {
        "description": "Base name for all resources. Must be unique."
      }
    },
    "location": {
      "type": "string",
      "defaultValue": "[resourceGroup().location]",
      "metadata": {
        "description": "Azure region for all resources."
      }
    },
    "adminEmail": {
      "type": "string",
      "metadata": {
        "description": "Email of the first admin user."
      }
    },
    "functionAppSku": {
      "type": "string",
      "defaultValue": "Y1",
      "allowedValues": [
        "Y1",
        "EP1",
        "EP2",
        "EP3"
      ],
      "metadata": {
        "description": "SKU for the App Service Plan."
      }
    },
    "enableAppInsights": {
      "type": "bool",
      "defaultValue": true,
      "metadata": {
        "description": "Enable Application Insights."
      }
    },
    "appVersion": {
      "type": "string",
      "defaultValue": "latest",
      "metadata": {
        "description": "Version to deploy (\"latest\" for most recent release, or specific tag like \"v1.0.0\")"
      }
    },
    "skipAppRegistration": {
      "type": "bool",
      "defaultValue": false,
      "metadata": {
        "description": "Skip App Registration creation (for manual setup)"
      }
    }
  },
  "variables": {
    "uniqueSuffix": "[uniqueString(resourceGroup().id, parameters('appName'))]",
    "shortSuffix": "[take(variables('uniqueSuffix'), 6)]",
    "storageAccountName": "[toLower(format('{0}st{1}', take(parameters('appName'), 10), variables('uniqueSuffix')))]",
    "keyVaultName": "[format('{0}-kv-{1}', parameters('appName'), take(variables('uniqueSuffix'), 8))]",
    "functionAppApiName": "[format('{0}-{1}-api', parameters('appName'), variables('shortSuffix'))]",
    "functionAppSchedulerName": "[format('{0}-{1}-scheduler', parameters('appName'), variables('shortSuffix'))]",
    "functionAppProcessorName": "[format('{0}-{1}-processor', parameters('appName'), variables('shortSuffix'))]",
    "staticWebAppName": "[format('{0}-{1}-web', parameters('appName'), variables('shortSuffix'))]",
    "appInsightsName": "[format('{0}-insights', parameters('appName'))]",
    "appServicePlanName": "[format('{0}-plan', parameters('appName'))]",
    "deploymentIdentityName": "[format('{0}-deploy-identity', parameters('appName'))]",
    "installationId": "[variables('uniqueSuffix')]",
    "tenantId": "[subscription().tenantId]",
    "tags": {
      "Application": "Dilux Database Backup",
      "Environment": "Production",
      "ManagedBy": "Bicep",
      "Version": "[parameters('appVersion')]"
    },
    "keyVaultSecretsUserRoleId": "4633458b-17de-408a-b874-0445c86b69e6",
    "storageBlobDataContributorRoleId": "ba92f5b4-2d11-453d-a403-e96b0029c9fe",
    "storageQueueDataContributorRoleId": "974c5e8b-45b9-4653-ba55-5f855dd0fb88",
    "storageTableDataContributorRoleId": "0a9a7e1f-b9d0-4cc4-a60d-0319b160aaa3",
    "contributorRoleId": "b24988ac-6180-42a0-ab88-20f7382dd24c"
  },
  "resources": [
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "storage-deployment",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "storageAccountName": {
            "value": "[variables('storageAccountName')]"
          },
          "location": {
            "value": "[parameters('location')]"
          },
          "tags": {
            "value": "[variables('tags')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.39.26.7824",
              "templateHash": "17117786387198307596"
            }
          },
          "parameters": {
            "storageAccountName": {
              "type": "string",
              "metadata": {
                "description": "Name of the storage account"
              }
            },
            "location": {
              "type": "string",
              "metadata": {
                "description": "Azure region"
              }
            },
            "tags": {
              "type": "object",
              "metadata": {
                "description": "Tags to apply"
              }
            }
          },
          "resources": [
            {
              "type": "Microsoft.Storage/storageAccounts",
              "apiVersion": "2023-01-01",
              "name": "[parameters('storageAccountName')]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]",
              "sku": {
                "name": "Standard_LRS"
              },
              "kind": "StorageV2",
              "properties": {
                "accessTier": "Hot",
                "supportsHttpsTrafficOnly": true,
                "minimumTlsVersion": "TLS1_2",
                "allowBlobPublicAccess": false,
                "networkAcls": {
                  "defaultAction": "Allow",
                  "bypass": "AzureServices"
                }
              }
            },
            {
              "type": "Microsoft.Storage/storageAccounts/blobServices",
              "apiVersion": "2023-01-01",
              "name": "[format('{0}/{1}', parameters('storageAccountName'), 'default')]",
              "properties": {
                "deleteRetentionPolicy": {
                  "enabled": true,
                  "days": 7
                }
              },
              "dependsOn": [
                "[resourceId('Microsoft.Storage/storageAccounts', parameters('storageAccountName'))]"
              ]
            },
            {
              "type": "Microsoft.Storage/storageAccounts/blobServices/containers",
              "apiVersion": "2023-01-01",
              "name": "[format('{0}/{1}/{2}', parameters('storageAccountName'), 'default', 'backups')]",
              "properties": {
                "publicAccess": "None"
              },
              "dependsOn": [
                "[resourceId('Microsoft.Storage/storageAccounts/blobServices', parameters('storageAccountName'), 'default')]"
              ]
            },
            {
              "type": "Microsoft.Storage/storageAccounts/queueServices",
              "apiVersion": "2023-01-01",
              "name": "[format('{0}/{1}', parameters('storageAccountName'), 'default')]",
              "dependsOn": [
                "[resourceId('Microsoft.Storage/storageAccounts', parameters('storageAccountName'))]"
              ]
            },
            {
              "type": "Microsoft.Storage/storageAccounts/queueServices/queues",
              "apiVersion": "2023-01-01",
              "name": "[format('{0}/{1}/{2}', parameters('storageAccountName'), 'default', 'backup-jobs')]",
              "dependsOn": [
                "[resourceId('Microsoft.Storage/storageAccounts/queueServices', parameters('storageAccountName'), 'default')]"
              ]
            },
            {
              "type": "Microsoft.Storage/storageAccounts/tableServices",
              "apiVersion": "2023-01-01",
              "name": "[format('{0}/{1}', parameters('storageAccountName'), 'default')]",
              "dependsOn": [
                "[resourceId('Microsoft.Storage/storageAccounts', parameters('storageAccountName'))]"
              ]
            },
            {
              "type": "Microsoft.Storage/storageAccounts/tableServices/tables",
              "apiVersion": "2023-01-01",
              "name": "[format('{0}/{1}/{2}', parameters('storageAccountName'), 'default', 'databaseconfigs')]",
              "dependsOn": [
                "[resourceId('Microsoft.Storage/storageAccounts/tableServices', parameters('storageAccountName'), 'default')]"
              ]
            },
            {
              "type": "Microsoft.Storage/storageAccounts/tableServices/tables",
              "apiVersion": "2023-01-01",
              "name": "[format('{0}/{1}/{2}', parameters('storageAccountName'), 'default', 'backuphistory')]",
              "dependsOn": [
                "[resourceId('Microsoft.Storage/storageAccounts/tableServices', parameters('storageAccountName'), 'default')]"
              ]
            },
            {
              "type": "Microsoft.Storage/storageAccounts/tableServices/tables",
              "apiVersion": "2023-01-01",
              "name": "[format('{0}/{1}/{2}', parameters('storageAccountName'), 'default', 'auditlogs')]",
              "dependsOn": [
                "[resourceId('Microsoft.Storage/storageAccounts/tableServices', parameters('storageAccountName'), 'default')]"
              ]
            },
            {
              "type": "Microsoft.Storage/storageAccounts/tableServices/tables",
              "apiVersion": "2023-01-01",
              "name": "[format('{0}/{1}/{2}', parameters('storageAccountName'), 'default', 'users')]",
              "dependsOn": [
                "[resourceId('Microsoft.Storage/storageAccounts/tableServices', parameters('storageAccountName'), 'default')]"
              ]
            },
            {
              "type": "Microsoft.Storage/storageAccounts/tableServices/tables",
              "apiVersion": "2023-01-01",
              "name": "[format('{0}/{1}/{2}', parameters('storageAccountName'), 'default', 'settings')]",
              "dependsOn": [
                "[resourceId('Microsoft.Storage/storageAccounts/tableServices', parameters('storageAccountName'), 'default')]"
              ]
            },
            {
              "type": "Microsoft.Storage/storageAccounts/tableServices/tables",
              "apiVersion": "2023-01-01",
              "name": "[format('{0}/{1}/{2}', parameters('storageAccountName'), 'default', 'accessrequests')]",
              "dependsOn": [
                "[resourceId('Microsoft.Storage/storageAccounts/tableServices', parameters('storageAccountName'), 'default')]"
              ]
            },
            {
              "type": "Microsoft.Storage/storageAccounts/tableServices/tables",
              "apiVersion": "2023-01-01",
              "name": "[format('{0}/{1}/{2}', parameters('storageAccountName'), 'default', 'backuppolicies')]",
              "dependsOn": [
                "[resourceId('Microsoft.Storage/storageAccounts/tableServices', parameters('storageAccountName'), 'default')]"
              ]
            }
          ],
          "outputs": {
            "storageAccountName": {
              "type": "string",
              "metadata": {
                "description": "Storage account name"
              },
              "value": "[parameters('storageAccountName')]"
            },
            "storageAccountId": {
              "type": "string",
              "metadata": {
                "description": "Storage account resource ID"
              },
              "value": "[resourceId('Microsoft.Storage/storageAccounts', parameters('storageAccountName'))]"
            },
            "storageAccountKey": {
              "type": "string",
              "metadata": {
                "description": "Storage account primary key"
              },
              "value": "[listKeys(resourceId('Microsoft.Storage/storageAccounts', parameters('storageAccountName')), '2023-01-01').keys[0].value]"
            },
            "connectionString": {
              "type": "string",
              "metadata": {
                "description": "Storage account connection string"
              },
              "value": "[format('DefaultEndpointsProtocol=https;AccountName={0};AccountKey={1};EndpointSuffix={2}', parameters('storageAccountName'), listKeys(resourceId('Microsoft.Storage/storageAccounts', parameters('storageAccountName')), '2023-01-01').keys[0].value, environment().suffixes.storage)]"
            },
            "blobEndpoint": {
              "type": "string",
              "metadata": {
                "description": "Blob endpoint"
              },
              "value": "[reference(resourceId('Microsoft.Storage/storageAccounts', parameters('storageAccountName')), '2023-01-01').primaryEndpoints.blob]"
            },
            "queueEndpoint": {
              "type": "string",
              "metadata": {
                "description": "Queue endpoint"
              },
              "value": "[reference(resourceId('Microsoft.Storage/storageAccounts', parameters('storageAccountName')), '2023-01-01').primaryEndpoints.queue]"
            },
            "tableEndpoint": {
              "type": "string",
              "metadata": {
                "description": "Table endpoint"
              },
              "value": "[reference(resourceId('Microsoft.Storage/storageAccounts', parameters('storageAccountName')), '2023-01-01').primaryEndpoints.table]"
            }
          }
        }
      }
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "keyvault-deployment",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "keyVaultName": {
            "value": "[variables('keyVaultName')]"
          },
          "location": {
            "value": "[parameters('location')]"
          },
          "tags": {
            "value": "[variables('tags')]"
          },
          "tenantId": {
            "value": "[variables('tenantId')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.39.26.7824",
              "templateHash": "4101464948759302784"
            }
          },
          "parameters": {
            "keyVaultName": {
              "type": "string",
              "metadata": {
                "description": "Name of the Key Vault"
              }
            },
            "location": {
              "type": "string",
              "metadata": {
                "description": "Azure region"
              }
            },
            "tags": {
              "type": "object",
              "metadata": {
                "description": "Tags to apply"
              }
            },
            "tenantId": {
              "type": "string",
              "metadata": {
                "description": "Azure AD Tenant ID"
              }
            }
          },
          "resources": [
            {
              "type": "Microsoft.KeyVault/vaults",
              "apiVersion": "2023-07-01",
              "name": "[parameters('keyVaultName')]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]",
              "properties": {
                "tenantId": "[parameters('tenantId')]",
                "sku": {
                  "family": "A",
                  "name": "standard"
                },
                "enableRbacAuthorization": true,
                "enableSoftDelete": true,
                "softDeleteRetentionInDays": 7,
                "networkAcls": {
                  "defaultAction": "Allow",
                  "bypass": "AzureServices"
                }
              }
            }
          ],
          "outputs": {
            "keyVaultName": {
              "type": "string",
              "metadata": {
                "description": "Key Vault name"
              },
              "value": "[parameters('keyVaultName')]"
            },
            "keyVaultUri": {
              "type": "string",
              "metadata": {
                "description": "Key Vault URI"
              },
              "value": "[reference(resourceId('Microsoft.KeyVault/vaults', parameters('keyVaultName')), '2023-07-01').vaultUri]"
            },
            "keyVaultId": {
              "type": "string",
              "metadata": {
                "description": "Key Vault resource ID"
              },
              "value": "[resourceId('Microsoft.KeyVault/vaults', parameters('keyVaultName'))]"
            }
          }
        }
      }
    },
    {
      "condition": "[parameters('enableAppInsights')]",
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "appinsights-deployment",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "appInsightsName": {
            "value": "[variables('appInsightsName')]"
          },
          "location": {
            "value": "[parameters('location')]"
          },
          "tags": {
            "value": "[variables('tags')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.39.26.7824",
              "templateHash": "5630221161256163117"
            }
          },
          "parameters": {
            "appInsightsName": {
              "type": "string",
              "metadata": {
                "description": "Name of the Application Insights resource"
              }
            },
            "location": {
              "type": "string",
              "metadata": {
                "description": "Azure region"
              }
            },
            "tags": {
              "type": "object",
              "metadata": {
                "description": "Tags to apply"
              }
            }
          },
          "resources": [
            {
              "type": "Microsoft.OperationalInsights/workspaces",
              "apiVersion": "2022-10-01",
              "name": "[format('{0}-logs', parameters('appInsightsName'))]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]",
              "properties": {
                "sku": {
                  "name": "PerGB2018"
                },
                "retentionInDays": 30
              }
            },
            {
              "type": "Microsoft.Insights/components",
              "apiVersion": "2020-02-02",
              "name": "[parameters('appInsightsName')]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]",
              "kind": "web",
              "properties": {
                "Application_Type": "web",
                "WorkspaceResourceId": "[resourceId('Microsoft.OperationalInsights/workspaces', format('{0}-logs', parameters('appInsightsName')))]",
                "IngestionMode": "LogAnalytics",
                "publicNetworkAccessForIngestion": "Enabled",
                "publicNetworkAccessForQuery": "Enabled"
              },
              "dependsOn": [
                "[resourceId('Microsoft.OperationalInsights/workspaces', format('{0}-logs', parameters('appInsightsName')))]"
              ]
            }
          ],
          "outputs": {
            "appInsightsName": {
              "type": "string",
              "metadata": {
                "description": "Application Insights name"
              },
              "value": "[parameters('appInsightsName')]"
            },
            "instrumentationKey": {
              "type": "string",
              "metadata": {
                "description": "Application Insights instrumentation key"
              },
              "value": "[reference(resourceId('Microsoft.Insights/components', parameters('appInsightsName')), '2020-02-02').InstrumentationKey]"
            },
            "connectionString": {
              "type": "string",
              "metadata": {
                "description": "Application Insights connection string"
              },
              "value": "[reference(resourceId('Microsoft.Insights/components', parameters('appInsightsName')), '2020-02-02').ConnectionString]"
            },
            "logAnalyticsWorkspaceId": {
              "type": "string",
              "metadata": {
                "description": "Log Analytics Workspace ID"
              },
              "value": "[resourceId('Microsoft.OperationalInsights/workspaces', format('{0}-logs', parameters('appInsightsName')))]"
            }
          }
        }
      }
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "appserviceplan-deployment",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "planName": {
            "value": "[variables('appServicePlanName')]"
          },
          "location": {
            "value": "[parameters('location')]"
          },
          "tags": {
            "value": "[variables('tags')]"
          },
          "sku": {
            "value": "[parameters('functionAppSku')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.39.26.7824",
              "templateHash": "6635559551537838525"
            }
          },
          "parameters": {
            "planName": {
              "type": "string",
              "metadata": {
                "description": "Name of the App Service Plan"
              }
            },
            "location": {
              "type": "string",
              "metadata": {
                "description": "Azure region"
              }
            },
            "tags": {
              "type": "object",
              "metadata": {
                "description": "Tags to apply"
              }
            },
            "sku": {
              "type": "string",
              "defaultValue": "Y1",
              "allowedValues": [
                "Y1",
                "EP1",
                "EP2",
                "EP3"
              ],
              "metadata": {
                "description": "SKU for the plan"
              }
            }
          },
          "variables": {
            "skuConfig": {
              "Y1": {
                "name": "Y1",
                "tier": "Dynamic"
              },
              "EP1": {
                "name": "EP1",
                "tier": "ElasticPremium"
              },
              "EP2": {
                "name": "EP2",
                "tier": "ElasticPremium"
              },
              "EP3": {
                "name": "EP3",
                "tier": "ElasticPremium"
              }
            }
          },
          "resources": [
            {
              "type": "Microsoft.Web/serverfarms",
              "apiVersion": "2023-01-01",
              "name": "[parameters('planName')]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]",
              "sku": {
                "name": "[variables('skuConfig')[parameters('sku')].name]",
                "tier": "[variables('skuConfig')[parameters('sku')].tier]"
              },
              "properties": {
                "reserved": true
              }
            }
          ],
          "outputs": {
            "planId": {
              "type": "string",
              "metadata": {
                "description": "App Service Plan resource ID"
              },
              "value": "[resourceId('Microsoft.Web/serverfarms', parameters('planName'))]"
            },
            "planName": {
              "type": "string",
              "metadata": {
                "description": "App Service Plan name"
              },
              "value": "[parameters('planName')]"
            }
          }
        }
      }
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "deployment-identity",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "identityName": {
            "value": "[variables('deploymentIdentityName')]"
          },
          "location": {
            "value": "[parameters('location')]"
          },
          "tags": {
            "value": "[variables('tags')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.39.26.7824",
              "templateHash": "18425978129405451201"
            }
          },
          "parameters": {
            "identityName": {
              "type": "string",
              "metadata": {
                "description": "Name of the managed identity"
              }
            },
            "location": {
              "type": "string",
              "metadata": {
                "description": "Azure region"
              }
            },
            "tags": {
              "type": "object",
              "metadata": {
                "description": "Tags to apply"
              }
            }
          },
          "resources": [
            {
              "type": "Microsoft.ManagedIdentity/userAssignedIdentities",
              "apiVersion": "2023-01-31",
              "name": "[parameters('identityName')]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]"
            }
          ],
          "outputs": {
            "identityId": {
              "type": "string",
              "metadata": {
                "description": "Managed Identity resource ID"
              },
              "value": "[resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', parameters('identityName'))]"
            },
            "principalId": {
              "type": "string",
              "metadata": {
                "description": "Managed Identity principal ID"
              },
              "value": "[reference(resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', parameters('identityName')), '2023-01-31').principalId]"
            },
            "clientId": {
              "type": "string",
              "metadata": {
                "description": "Managed Identity client ID"
              },
              "value": "[reference(resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', parameters('identityName')), '2023-01-31').clientId]"
            }
          }
        }
      }
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "rbac-deployment-contributor",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "principalId": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', 'deployment-identity'), '2025-04-01').outputs.principalId.value]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.39.26.7824",
              "templateHash": "14210500320083670913"
            }
          },
          "parameters": {
            "principalId": {
              "type": "string",
              "metadata": {
                "description": "Principal ID to assign the role to"
              }
            },
            "principalType": {
              "type": "string",
              "defaultValue": "ServicePrincipal",
              "metadata": {
                "description": "Principal type (ServicePrincipal, User, Group)"
              }
            }
          },
          "variables": {
            "contributorRoleId": "b24988ac-6180-42a0-ab88-20f7382dd24c"
          },
          "resources": [
            {
              "type": "Microsoft.Authorization/roleAssignments",
              "apiVersion": "2022-04-01",
              "name": "[guid(resourceGroup().id, parameters('principalId'), variables('contributorRoleId'))]",
              "properties": {
                "roleDefinitionId": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', variables('contributorRoleId'))]",
                "principalId": "[parameters('principalId')]",
                "principalType": "[parameters('principalType')]"
              }
            }
          ],
          "outputs": {
            "roleAssignmentId": {
              "type": "string",
              "metadata": {
                "description": "Role assignment ID"
              },
              "value": "[resourceId('Microsoft.Authorization/roleAssignments', guid(resourceGroup().id, parameters('principalId'), variables('contributorRoleId')))]"
            }
          }
        }
      },
      "dependsOn": [
        "[resourceId('Microsoft.Resources/deployments', 'deployment-identity')]"
      ]
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "staticwebapp-deployment",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "staticWebAppName": {
            "value": "[variables('staticWebAppName')]"
          },
          "location": {
            "value": "[parameters('location')]"
          },
          "tags": {
            "value": "[variables('tags')]"
          },
          "apiBaseUrl": {
            "value": "[format('https://{0}.azurewebsites.net', variables('functionAppApiName'))]"
          },
          "tenantId": {
            "value": "[variables('tenantId')]"
          },
          "clientId": {
            "value": ""
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.39.26.7824",
              "templateHash": "3843008348940777103"
            }
          },
          "parameters": {
            "staticWebAppName": {
              "type": "string",
              "metadata": {
                "description": "Name of the Static Web App"
              }
            },
            "location": {
              "type": "string",
              "metadata": {
                "description": "Azure region (Static Web Apps have limited regions)"
              }
            },
            "tags": {
              "type": "object",
              "metadata": {
                "description": "Tags to apply"
              }
            },
            "apiBaseUrl": {
              "type": "string",
              "metadata": {
                "description": "API base URL for the backend"
              }
            },
            "tenantId": {
              "type": "string",
              "metadata": {
                "description": "Azure AD Tenant ID"
              }
            },
            "clientId": {
              "type": "string",
              "metadata": {
                "description": "Azure AD Client ID"
              }
            }
          },
          "variables": {
            "staticWebAppLocation": "[if(contains(createArray('eastus2', 'westus2', 'westeurope', 'eastasia', 'centralus'), parameters('location')), parameters('location'), 'eastus2')]"
          },
          "resources": [
            {
              "type": "Microsoft.Web/staticSites",
              "apiVersion": "2023-01-01",
              "name": "[parameters('staticWebAppName')]",
              "location": "[variables('staticWebAppLocation')]",
              "tags": "[parameters('tags')]",
              "sku": {
                "name": "Free",
                "tier": "Free"
              },
              "properties": {
                "stagingEnvironmentPolicy": "Enabled",
                "allowConfigFileUpdates": true,
                "buildProperties": {
                  "appLocation": "src/frontend",
                  "apiLocation": "",
                  "outputLocation": "dist"
                }
              }
            },
            {
              "type": "Microsoft.Web/staticSites/config",
              "apiVersion": "2023-01-01",
              "name": "[format('{0}/{1}', parameters('staticWebAppName'), 'appsettings')]",
              "properties": {
                "VITE_API_BASE_URL": "[parameters('apiBaseUrl')]",
                "VITE_AZURE_AD_TENANT_ID": "[parameters('tenantId')]",
                "VITE_AZURE_AD_CLIENT_ID": "[parameters('clientId')]"
              },
              "dependsOn": [
                "[resourceId('Microsoft.Web/staticSites', parameters('staticWebAppName'))]"
              ]
            }
          ],
          "outputs": {
            "staticWebAppName": {
              "type": "string",
              "metadata": {
                "description": "Static Web App name"
              },
              "value": "[parameters('staticWebAppName')]"
            },
            "defaultHostname": {
              "type": "string",
              "metadata": {
                "description": "Static Web App default hostname (with https)"
              },
              "value": "[format('https://{0}', reference(resourceId('Microsoft.Web/staticSites', parameters('staticWebAppName')), '2023-01-01').defaultHostname)]"
            },
            "defaultHostnameClean": {
              "type": "string",
              "metadata": {
                "description": "Static Web App default hostname (without protocol, for redirect URIs)"
              },
              "value": "[reference(resourceId('Microsoft.Web/staticSites', parameters('staticWebAppName')), '2023-01-01').defaultHostname]"
            },
            "resourceId": {
              "type": "string",
              "metadata": {
                "description": "Static Web App resource ID"
              },
              "value": "[resourceId('Microsoft.Web/staticSites', parameters('staticWebAppName'))]"
            },
            "deploymentToken": {
              "type": "string",
              "metadata": {
                "description": "Deployment token (for CI/CD)"
              },
              "value": "[listSecrets(resourceId('Microsoft.Web/staticSites', parameters('staticWebAppName')), '2023-01-01').properties.apiKey]"
            }
          }
        }
      }
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "rbac-deployment-keyvault",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "keyVaultName": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', 'keyvault-deployment'), '2025-04-01').outputs.keyVaultName.value]"
          },
          "principalId": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', 'deployment-identity'), '2025-04-01').outputs.principalId.value]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.39.26.7824",
              "templateHash": "15993742515363455244"
            }
          },
          "parameters": {
            "keyVaultName": {
              "type": "string",
              "metadata": {
                "description": "Name of the Key Vault"
              }
            },
            "principalId": {
              "type": "string",
              "metadata": {
                "description": "Principal ID to grant access to"
              }
            }
          },
          "variables": {
            "keyVaultSecretsOfficerRoleId": "b86a8fe4-44ce-4948-aee5-eccb2c155cd7"
          },
          "resources": [
            {
              "type": "Microsoft.Authorization/roleAssignments",
              "apiVersion": "2022-04-01",
              "scope": "[format('Microsoft.KeyVault/vaults/{0}', parameters('keyVaultName'))]",
              "name": "[guid(resourceId('Microsoft.KeyVault/vaults', parameters('keyVaultName')), parameters('principalId'), variables('keyVaultSecretsOfficerRoleId'))]",
              "properties": {
                "roleDefinitionId": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', variables('keyVaultSecretsOfficerRoleId'))]",
                "principalId": "[parameters('principalId')]",
                "principalType": "ServicePrincipal"
              }
            }
          ],
          "outputs": {
            "roleAssignmentId": {
              "type": "string",
              "metadata": {
                "description": "Role assignment ID"
              },
              "value": "[extensionResourceId(resourceId('Microsoft.KeyVault/vaults', parameters('keyVaultName')), 'Microsoft.Authorization/roleAssignments', guid(resourceId('Microsoft.KeyVault/vaults', parameters('keyVaultName')), parameters('principalId'), variables('keyVaultSecretsOfficerRoleId')))]"
            }
          }
        }
      },
      "dependsOn": [
        "[resourceId('Microsoft.Resources/deployments', 'deployment-identity')]",
        "[resourceId('Microsoft.Resources/deployments', 'keyvault-deployment')]"
      ]
    },
    {
      "condition": "[not(parameters('skipAppRegistration'))]",
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "appregistration-deployment",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "appName": {
            "value": "[parameters('appName')]"
          },
          "location": {
            "value": "[parameters('location')]"
          },
          "tags": {
            "value": "[variables('tags')]"
          },
          "staticWebAppHostname": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', 'staticwebapp-deployment'), '2025-04-01').outputs.defaultHostnameClean.value]"
          },
          "apiFunctionAppHostname": {
            "value": "[format('{0}.azurewebsites.net', variables('functionAppApiName'))]"
          },
          "keyVaultName": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', 'keyvault-deployment'), '2025-04-01').outputs.keyVaultName.value]"
          },
          "managedIdentityId": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', 'deployment-identity'), '2025-04-01').outputs.identityId.value]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.39.26.7824",
              "templateHash": "10459075157730796584"
            }
          },
          "parameters": {
            "appName": {
              "type": "string",
              "metadata": {
                "description": "Base name for the application"
              }
            },
            "location": {
              "type": "string",
              "metadata": {
                "description": "Azure region"
              }
            },
            "tags": {
              "type": "object",
              "metadata": {
                "description": "Tags to apply"
              }
            },
            "staticWebAppHostname": {
              "type": "string",
              "metadata": {
                "description": "Static Web App default hostname (for redirect URI)"
              }
            },
            "apiFunctionAppHostname": {
              "type": "string",
              "metadata": {
                "description": "API Function App hostname (for API permissions)"
              }
            },
            "keyVaultName": {
              "type": "string",
              "metadata": {
                "description": "Key Vault name to store the client secret"
              }
            },
            "managedIdentityId": {
              "type": "string",
              "metadata": {
                "description": "Managed Identity ID for the deployment script"
              }
            }
          },
          "resources": [
            {
              "type": "Microsoft.Resources/deploymentScripts",
              "apiVersion": "2023-08-01",
              "name": "[format('{0}-create-app-registration', parameters('appName'))]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]",
              "kind": "AzureCLI",
              "identity": {
                "type": "UserAssigned",
                "userAssignedIdentities": {
                  "[format('{0}', parameters('managedIdentityId'))]": {}
                }
              },
              "properties": {
                "azCliVersion": "2.50.0",
                "timeout": "PT10M",
                "retentionInterval": "PT1H",
                "cleanupPreference": "OnSuccess",
                "environmentVariables": [
                  {
                    "name": "APP_NAME",
                    "value": "[parameters('appName')]"
                  },
                  {
                    "name": "STATIC_WEB_APP_HOSTNAME",
                    "value": "[parameters('staticWebAppHostname')]"
                  },
                  {
                    "name": "API_HOSTNAME",
                    "value": "[parameters('apiFunctionAppHostname')]"
                  },
                  {
                    "name": "KEY_VAULT_NAME",
                    "value": "[parameters('keyVaultName')]"
                  }
                ],
                "scriptContent": "      #!/bin/bash\n      set -e\n\n      echo \"==========================================\"\n      echo \"Creating Azure AD App Registration\"\n      echo \"==========================================\"\n\n      # Check if we have permissions to create app registrations\n      echo \"Checking permissions...\"\n\n      # Try to create the app registration\n      APP_DISPLAY_NAME=\"Dilux Database Backup - ${APP_NAME}\"\n\n      # Check if app already exists\n      EXISTING_APP=$(az ad app list --display-name \"$APP_DISPLAY_NAME\" --query \"[0].appId\" -o tsv 2>/dev/null || echo \"\")\n\n      if [ -n \"$EXISTING_APP\" ] && [ \"$EXISTING_APP\" != \"None\" ]; then\n        echo \"App Registration already exists: $EXISTING_APP\"\n        CLIENT_ID=$EXISTING_APP\n      else\n        echo \"Creating new App Registration...\"\n\n        # Create the app registration\n        CREATE_RESULT=$(az ad app create \\\n          --display-name \"$APP_DISPLAY_NAME\" \\\n          --sign-in-audience \"AzureADMyOrg\" \\\n          --web-redirect-uris \"https://${STATIC_WEB_APP_HOSTNAME}\" \"https://${STATIC_WEB_APP_HOSTNAME}/auth/callback\" \\\n          --enable-id-token-issuance true \\\n          --enable-access-token-issuance true \\\n          2>&1) || {\n            echo \"==========================================\"\n            echo \"ERROR: No se pudo crear el App Registration\"\n            echo \"==========================================\"\n            echo \"\"\n            echo \"El usuario que ejecuta el deploy no tiene permisos para crear\"\n            echo \"App Registrations en Azure AD.\"\n            echo \"\"\n            echo \"SOLUCIÓN MANUAL:\"\n            echo \"1. Ve a Azure Portal → Azure Active Directory → App registrations\"\n            echo \"2. Click en 'New registration'\"\n            echo \"3. Nombre: $APP_DISPLAY_NAME\"\n            echo \"4. Supported account types: Single tenant\"\n            echo \"5. Redirect URI (Web): https://${STATIC_WEB_APP_HOSTNAME}\"\n            echo \"6. Después de crear, ve a 'Authentication' y agrega:\"\n            echo \"   - https://${STATIC_WEB_APP_HOSTNAME}/auth/callback\"\n            echo \"   - Marca 'ID tokens' y 'Access tokens'\"\n            echo \"7. Copia el 'Application (client) ID'\"\n            echo \"8. Ve a 'Certificates & secrets' → 'New client secret'\"\n            echo \"9. Guarda el secret en Key Vault: $KEY_VAULT_NAME\"\n            echo \"   - Nombre del secret: azure-ad-client-secret\"\n            echo \"10. Actualiza las Function Apps con:\"\n            echo \"    - AZURE_AD_CLIENT_ID = <tu client id>\"\n            echo \"\"\n            echo \"==========================================\"\n\n            # Output empty values so the deployment doesn't fail completely\n            echo \"{\\\"clientId\\\": \\\"\\\", \\\"success\\\": false, \\\"message\\\": \\\"Manual setup required\\\"}\" > $AZ_SCRIPTS_OUTPUT_PATH\n            exit 0\n          }\n\n        CLIENT_ID=$(echo $CREATE_RESULT | jq -r '.appId')\n        echo \"App Registration created: $CLIENT_ID\"\n      fi\n\n      # Create a client secret\n      echo \"Creating client secret...\"\n      SECRET_RESULT=$(az ad app credential reset \\\n        --id $CLIENT_ID \\\n        --display-name \"Dilux Backup Secret\" \\\n        --years 2 \\\n        --query password -o tsv 2>/dev/null) || {\n          echo \"Warning: Could not create client secret. Manual setup may be required.\"\n          SECRET_RESULT=\"\"\n        }\n\n      # Store the secret in Key Vault\n      if [ -n \"$SECRET_RESULT\" ]; then\n        echo \"Storing client secret in Key Vault...\"\n        az keyvault secret set \\\n          --vault-name \"$KEY_VAULT_NAME\" \\\n          --name \"azure-ad-client-secret\" \\\n          --value \"$SECRET_RESULT\" \\\n          --only-show-errors || echo \"Warning: Could not store secret in Key Vault\"\n\n        # Also store the client ID\n        az keyvault secret set \\\n          --vault-name \"$KEY_VAULT_NAME\" \\\n          --name \"azure-ad-client-id\" \\\n          --value \"$CLIENT_ID\" \\\n          --only-show-errors || echo \"Warning: Could not store client ID in Key Vault\"\n      fi\n\n      # Get tenant ID\n      TENANT_ID=$(az account show --query tenantId -o tsv)\n\n      echo \"==========================================\"\n      echo \"App Registration configured successfully!\"\n      echo \"==========================================\"\n      echo \"Client ID: $CLIENT_ID\"\n      echo \"Tenant ID: $TENANT_ID\"\n      echo \"Redirect URIs configured for: https://${STATIC_WEB_APP_HOSTNAME}\"\n      echo \"==========================================\"\n\n      # Output the results\n      echo \"{\\\"clientId\\\": \\\"$CLIENT_ID\\\", \\\"tenantId\\\": \\\"$TENANT_ID\\\", \\\"success\\\": true}\" > $AZ_SCRIPTS_OUTPUT_PATH\n    "
              }
            }
          ],
          "outputs": {
            "clientId": {
              "type": "string",
              "metadata": {
                "description": "The Client ID of the App Registration (empty if manual setup required)"
              },
              "value": "[reference(resourceId('Microsoft.Resources/deploymentScripts', format('{0}-create-app-registration', parameters('appName'))), '2023-08-01').outputs.clientId]"
            },
            "tenantId": {
              "type": "string",
              "metadata": {
                "description": "The Tenant ID"
              },
              "value": "[coalesce(tryGet(reference(resourceId('Microsoft.Resources/deploymentScripts', format('{0}-create-app-registration', parameters('appName'))), '2023-08-01').outputs, 'tenantId'), subscription().tenantId)]"
            },
            "success": {
              "type": "bool",
              "metadata": {
                "description": "Whether the App Registration was created successfully"
              },
              "value": "[coalesce(tryGet(reference(resourceId('Microsoft.Resources/deploymentScripts', format('{0}-create-app-registration', parameters('appName'))), '2023-08-01').outputs, 'success'), false())]"
            }
          }
        }
      },
      "dependsOn": [
        "[resourceId('Microsoft.Resources/deployments', 'deployment-identity')]",
        "[resourceId('Microsoft.Resources/deployments', 'keyvault-deployment')]",
        "[resourceId('Microsoft.Resources/deployments', 'rbac-deployment-contributor')]",
        "[resourceId('Microsoft.Resources/deployments', 'rbac-deployment-keyvault')]",
        "[resourceId('Microsoft.Resources/deployments', 'staticwebapp-deployment')]"
      ]
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "functionapp-api-deployment",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "functionAppName": {
            "value": "[variables('functionAppApiName')]"
          },
          "location": {
            "value": "[parameters('location')]"
          },
          "tags": {
            "value": "[variables('tags')]"
          },
          "appServicePlanId": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', 'appserviceplan-deployment'), '2025-04-01').outputs.planId.value]"
          },
          "sku": {
            "value": "[parameters('functionAppSku')]"
          },
          "storageAccountName": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', 'storage-deployment'), '2025-04-01').outputs.storageAccountName.value]"
          },
          "storageConnectionString": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', 'storage-deployment'), '2025-04-01').outputs.connectionString.value]"
          },
          "storageBlobEndpoint": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', 'storage-deployment'), '2025-04-01').outputs.blobEndpoint.value]"
          },
          "storageQueueEndpoint": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', 'storage-deployment'), '2025-04-01').outputs.queueEndpoint.value]"
          },
          "storageTableEndpoint": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', 'storage-deployment'), '2025-04-01').outputs.tableEndpoint.value]"
          },
          "appInsightsConnectionString": "[if(parameters('enableAppInsights'), createObject('value', reference(resourceId('Microsoft.Resources/deployments', 'appinsights-deployment'), '2025-04-01').outputs.connectionString.value), createObject('value', ''))]",
          "appInsightsInstrumentationKey": "[if(parameters('enableAppInsights'), createObject('value', reference(resourceId('Microsoft.Resources/deployments', 'appinsights-deployment'), '2025-04-01').outputs.instrumentationKey.value), createObject('value', ''))]",
          "keyVaultName": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', 'keyvault-deployment'), '2025-04-01').outputs.keyVaultName.value]"
          },
          "additionalAppSettings": {
            "value": {
              "FUNCTION_APP_TYPE": "api",
              "ADMIN_EMAIL": "[parameters('adminEmail')]",
              "APP_VERSION": "[parameters('appVersion')]",
              "INSTALLATION_ID": "[variables('installationId')]",
              "AZURE_AD_TENANT_ID": "[variables('tenantId')]",
              "AZURE_AD_CLIENT_ID": "[if(parameters('skipAppRegistration'), '', if(reference(resourceId('Microsoft.Resources/deployments', 'appregistration-deployment'), '2025-04-01').outputs.success.value, reference(resourceId('Microsoft.Resources/deployments', 'appregistration-deployment'), '2025-04-01').outputs.clientId.value, ''))]"
            }
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.39.26.7824",
              "templateHash": "13760038921440905211"
            }
          },
          "parameters": {
            "functionAppName": {
              "type": "string",
              "metadata": {
                "description": "Name of the Function App"
              }
            },
            "location": {
              "type": "string",
              "metadata": {
                "description": "Azure region"
              }
            },
            "tags": {
              "type": "object",
              "metadata": {
                "description": "Tags to apply"
              }
            },
            "appServicePlanId": {
              "type": "string",
              "metadata": {
                "description": "App Service Plan resource ID"
              }
            },
            "sku": {
              "type": "string",
              "metadata": {
                "description": "App Service Plan SKU (Y1, EP1, EP2, EP3)"
              }
            },
            "storageAccountName": {
              "type": "string",
              "metadata": {
                "description": "Storage Account name"
              }
            },
            "storageConnectionString": {
              "type": "securestring",
              "metadata": {
                "description": "Storage Account connection string (for Y1/Consumption plan)"
              }
            },
            "storageBlobEndpoint": {
              "type": "string",
              "metadata": {
                "description": "Storage Account blob endpoint"
              }
            },
            "storageQueueEndpoint": {
              "type": "string",
              "metadata": {
                "description": "Storage Account queue endpoint"
              }
            },
            "storageTableEndpoint": {
              "type": "string",
              "metadata": {
                "description": "Storage Account table endpoint"
              }
            },
            "appInsightsConnectionString": {
              "type": "string",
              "defaultValue": "",
              "metadata": {
                "description": "Application Insights connection string"
              }
            },
            "appInsightsInstrumentationKey": {
              "type": "string",
              "defaultValue": "",
              "metadata": {
                "description": "Application Insights instrumentation key"
              }
            },
            "keyVaultName": {
              "type": "string",
              "metadata": {
                "description": "Key Vault name"
              }
            },
            "additionalAppSettings": {
              "type": "object",
              "defaultValue": {},
              "metadata": {
                "description": "Additional app settings"
              }
            }
          },
          "variables": {
            "isConsumptionPlan": "[equals(parameters('sku'), 'Y1')]",
            "consumptionStorageSettings": {
              "AzureWebJobsStorage": "[parameters('storageConnectionString')]",
              "WEBSITE_CONTENTAZUREFILECONNECTIONSTRING": "[parameters('storageConnectionString')]",
              "WEBSITE_CONTENTSHARE": "[toLower(parameters('functionAppName'))]"
            },
            "premiumStorageSettings": {
              "AzureWebJobsStorage__accountName": "[parameters('storageAccountName')]",
              "AzureWebJobsStorage__blobServiceUri": "[parameters('storageBlobEndpoint')]",
              "AzureWebJobsStorage__queueServiceUri": "[parameters('storageQueueEndpoint')]",
              "AzureWebJobsStorage__tableServiceUri": "[parameters('storageTableEndpoint')]"
            },
            "runtimeStorageSettings": "[if(variables('isConsumptionPlan'), variables('consumptionStorageSettings'), variables('premiumStorageSettings'))]",
            "baseAppSettings": {
              "FUNCTIONS_EXTENSION_VERSION": "~4",
              "FUNCTIONS_WORKER_RUNTIME": "python",
              "STORAGE_ACCOUNT_NAME": "[parameters('storageAccountName')]",
              "STORAGE_BLOB_ENDPOINT": "[parameters('storageBlobEndpoint')]",
              "STORAGE_QUEUE_ENDPOINT": "[parameters('storageQueueEndpoint')]",
              "STORAGE_TABLE_ENDPOINT": "[parameters('storageTableEndpoint')]",
              "KEY_VAULT_NAME": "[parameters('keyVaultName')]",
              "ENVIRONMENT": "production"
            },
            "appInsightsSettings": "[if(not(empty(parameters('appInsightsConnectionString'))), createObject('APPLICATIONINSIGHTS_CONNECTION_STRING', parameters('appInsightsConnectionString'), 'APPINSIGHTS_INSTRUMENTATIONKEY', parameters('appInsightsInstrumentationKey')), createObject())]",
            "appSettings": "[union(variables('runtimeStorageSettings'), variables('baseAppSettings'), variables('appInsightsSettings'), parameters('additionalAppSettings'))]"
          },
          "resources": [
            {
              "type": "Microsoft.Web/sites",
              "apiVersion": "2023-01-01",
              "name": "[parameters('functionAppName')]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]",
              "kind": "functionapp,linux",
              "identity": {
                "type": "SystemAssigned"
              },
              "properties": {
                "serverFarmId": "[parameters('appServicePlanId')]",
                "httpsOnly": true,
                "reserved": true,
                "siteConfig": {
                  "copy": [
                    {
                      "name": "appSettings",
                      "count": "[length(items(variables('appSettings')))]",
                      "input": {
                        "name": "[items(variables('appSettings'))[copyIndex('appSettings')].key]",
                        "value": "[string(items(variables('appSettings'))[copyIndex('appSettings')].value)]"
                      }
                    }
                  ],
                  "linuxFxVersion": "PYTHON|3.10",
                  "ftpsState": "Disabled",
                  "minTlsVersion": "1.2",
                  "cors": {
                    "allowedOrigins": [
                      "https://portal.azure.com",
                      "https://*.azurestaticapps.net"
                    ],
                    "supportCredentials": true
                  }
                }
              }
            }
          ],
          "outputs": {
            "functionAppName": {
              "type": "string",
              "metadata": {
                "description": "Function App name"
              },
              "value": "[parameters('functionAppName')]"
            },
            "defaultHostname": {
              "type": "string",
              "metadata": {
                "description": "Function App default hostname"
              },
              "value": "[reference(resourceId('Microsoft.Web/sites', parameters('functionAppName')), '2023-01-01').defaultHostName]"
            },
            "principalId": {
              "type": "string",
              "metadata": {
                "description": "Function App principal ID (Managed Identity)"
              },
              "value": "[reference(resourceId('Microsoft.Web/sites', parameters('functionAppName')), '2023-01-01', 'full').identity.principalId]"
            },
            "resourceId": {
              "type": "string",
              "metadata": {
                "description": "Function App resource ID"
              },
              "value": "[resourceId('Microsoft.Web/sites', parameters('functionAppName'))]"
            },
            "isConsumptionPlan": {
              "type": "bool",
              "metadata": {
                "description": "Is using Consumption plan"
              },
              "value": "[variables('isConsumptionPlan')]"
            }
          }
        }
      },
      "dependsOn": [
        "[resourceId('Microsoft.Resources/deployments', 'appinsights-deployment')]",
        "[resourceId('Microsoft.Resources/deployments', 'appregistration-deployment')]",
        "[resourceId('Microsoft.Resources/deployments', 'appserviceplan-deployment')]",
        "[resourceId('Microsoft.Resources/deployments', 'keyvault-deployment')]",
        "[resourceId('Microsoft.Resources/deployments', 'storage-deployment')]"
      ]
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "functionapp-scheduler-deployment",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "functionAppName": {
            "value": "[variables('functionAppSchedulerName')]"
          },
          "location": {
            "value": "[parameters('location')]"
          },
          "tags": {
            "value": "[variables('tags')]"
          },
          "appServicePlanId": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', 'appserviceplan-deployment'), '2025-04-01').outputs.planId.value]"
          },
          "sku": {
            "value": "[parameters('functionAppSku')]"
          },
          "storageAccountName": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', 'storage-deployment'), '2025-04-01').outputs.storageAccountName.value]"
          },
          "storageConnectionString": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', 'storage-deployment'), '2025-04-01').outputs.connectionString.value]"
          },
          "storageBlobEndpoint": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', 'storage-deployment'), '2025-04-01').outputs.blobEndpoint.value]"
          },
          "storageQueueEndpoint": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', 'storage-deployment'), '2025-04-01').outputs.queueEndpoint.value]"
          },
          "storageTableEndpoint": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', 'storage-deployment'), '2025-04-01').outputs.tableEndpoint.value]"
          },
          "appInsightsConnectionString": "[if(parameters('enableAppInsights'), createObject('value', reference(resourceId('Microsoft.Resources/deployments', 'appinsights-deployment'), '2025-04-01').outputs.connectionString.value), createObject('value', ''))]",
          "appInsightsInstrumentationKey": "[if(parameters('enableAppInsights'), createObject('value', reference(resourceId('Microsoft.Resources/deployments', 'appinsights-deployment'), '2025-04-01').outputs.instrumentationKey.value), createObject('value', ''))]",
          "keyVaultName": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', 'keyvault-deployment'), '2025-04-01').outputs.keyVaultName.value]"
          },
          "additionalAppSettings": {
            "value": {
              "FUNCTION_APP_TYPE": "scheduler",
              "APP_VERSION": "[parameters('appVersion')]",
              "INSTALLATION_ID": "[variables('installationId')]"
            }
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.39.26.7824",
              "templateHash": "13760038921440905211"
            }
          },
          "parameters": {
            "functionAppName": {
              "type": "string",
              "metadata": {
                "description": "Name of the Function App"
              }
            },
            "location": {
              "type": "string",
              "metadata": {
                "description": "Azure region"
              }
            },
            "tags": {
              "type": "object",
              "metadata": {
                "description": "Tags to apply"
              }
            },
            "appServicePlanId": {
              "type": "string",
              "metadata": {
                "description": "App Service Plan resource ID"
              }
            },
            "sku": {
              "type": "string",
              "metadata": {
                "description": "App Service Plan SKU (Y1, EP1, EP2, EP3)"
              }
            },
            "storageAccountName": {
              "type": "string",
              "metadata": {
                "description": "Storage Account name"
              }
            },
            "storageConnectionString": {
              "type": "securestring",
              "metadata": {
                "description": "Storage Account connection string (for Y1/Consumption plan)"
              }
            },
            "storageBlobEndpoint": {
              "type": "string",
              "metadata": {
                "description": "Storage Account blob endpoint"
              }
            },
            "storageQueueEndpoint": {
              "type": "string",
              "metadata": {
                "description": "Storage Account queue endpoint"
              }
            },
            "storageTableEndpoint": {
              "type": "string",
              "metadata": {
                "description": "Storage Account table endpoint"
              }
            },
            "appInsightsConnectionString": {
              "type": "string",
              "defaultValue": "",
              "metadata": {
                "description": "Application Insights connection string"
              }
            },
            "appInsightsInstrumentationKey": {
              "type": "string",
              "defaultValue": "",
              "metadata": {
                "description": "Application Insights instrumentation key"
              }
            },
            "keyVaultName": {
              "type": "string",
              "metadata": {
                "description": "Key Vault name"
              }
            },
            "additionalAppSettings": {
              "type": "object",
              "defaultValue": {},
              "metadata": {
                "description": "Additional app settings"
              }
            }
          },
          "variables": {
            "isConsumptionPlan": "[equals(parameters('sku'), 'Y1')]",
            "consumptionStorageSettings": {
              "AzureWebJobsStorage": "[parameters('storageConnectionString')]",
              "WEBSITE_CONTENTAZUREFILECONNECTIONSTRING": "[parameters('storageConnectionString')]",
              "WEBSITE_CONTENTSHARE": "[toLower(parameters('functionAppName'))]"
            },
            "premiumStorageSettings": {
              "AzureWebJobsStorage__accountName": "[parameters('storageAccountName')]",
              "AzureWebJobsStorage__blobServiceUri": "[parameters('storageBlobEndpoint')]",
              "AzureWebJobsStorage__queueServiceUri": "[parameters('storageQueueEndpoint')]",
              "AzureWebJobsStorage__tableServiceUri": "[parameters('storageTableEndpoint')]"
            },
            "runtimeStorageSettings": "[if(variables('isConsumptionPlan'), variables('consumptionStorageSettings'), variables('premiumStorageSettings'))]",
            "baseAppSettings": {
              "FUNCTIONS_EXTENSION_VERSION": "~4",
              "FUNCTIONS_WORKER_RUNTIME": "python",
              "STORAGE_ACCOUNT_NAME": "[parameters('storageAccountName')]",
              "STORAGE_BLOB_ENDPOINT": "[parameters('storageBlobEndpoint')]",
              "STORAGE_QUEUE_ENDPOINT": "[parameters('storageQueueEndpoint')]",
              "STORAGE_TABLE_ENDPOINT": "[parameters('storageTableEndpoint')]",
              "KEY_VAULT_NAME": "[parameters('keyVaultName')]",
              "ENVIRONMENT": "production"
            },
            "appInsightsSettings": "[if(not(empty(parameters('appInsightsConnectionString'))), createObject('APPLICATIONINSIGHTS_CONNECTION_STRING', parameters('appInsightsConnectionString'), 'APPINSIGHTS_INSTRUMENTATIONKEY', parameters('appInsightsInstrumentationKey')), createObject())]",
            "appSettings": "[union(variables('runtimeStorageSettings'), variables('baseAppSettings'), variables('appInsightsSettings'), parameters('additionalAppSettings'))]"
          },
          "resources": [
            {
              "type": "Microsoft.Web/sites",
              "apiVersion": "2023-01-01",
              "name": "[parameters('functionAppName')]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]",
              "kind": "functionapp,linux",
              "identity": {
                "type": "SystemAssigned"
              },
              "properties": {
                "serverFarmId": "[parameters('appServicePlanId')]",
                "httpsOnly": true,
                "reserved": true,
                "siteConfig": {
                  "copy": [
                    {
                      "name": "appSettings",
                      "count": "[length(items(variables('appSettings')))]",
                      "input": {
                        "name": "[items(variables('appSettings'))[copyIndex('appSettings')].key]",
                        "value": "[string(items(variables('appSettings'))[copyIndex('appSettings')].value)]"
                      }
                    }
                  ],
                  "linuxFxVersion": "PYTHON|3.10",
                  "ftpsState": "Disabled",
                  "minTlsVersion": "1.2",
                  "cors": {
                    "allowedOrigins": [
                      "https://portal.azure.com",
                      "https://*.azurestaticapps.net"
                    ],
                    "supportCredentials": true
                  }
                }
              }
            }
          ],
          "outputs": {
            "functionAppName": {
              "type": "string",
              "metadata": {
                "description": "Function App name"
              },
              "value": "[parameters('functionAppName')]"
            },
            "defaultHostname": {
              "type": "string",
              "metadata": {
                "description": "Function App default hostname"
              },
              "value": "[reference(resourceId('Microsoft.Web/sites', parameters('functionAppName')), '2023-01-01').defaultHostName]"
            },
            "principalId": {
              "type": "string",
              "metadata": {
                "description": "Function App principal ID (Managed Identity)"
              },
              "value": "[reference(resourceId('Microsoft.Web/sites', parameters('functionAppName')), '2023-01-01', 'full').identity.principalId]"
            },
            "resourceId": {
              "type": "string",
              "metadata": {
                "description": "Function App resource ID"
              },
              "value": "[resourceId('Microsoft.Web/sites', parameters('functionAppName'))]"
            },
            "isConsumptionPlan": {
              "type": "bool",
              "metadata": {
                "description": "Is using Consumption plan"
              },
              "value": "[variables('isConsumptionPlan')]"
            }
          }
        }
      },
      "dependsOn": [
        "[resourceId('Microsoft.Resources/deployments', 'appinsights-deployment')]",
        "[resourceId('Microsoft.Resources/deployments', 'appregistration-deployment')]",
        "[resourceId('Microsoft.Resources/deployments', 'appserviceplan-deployment')]",
        "[resourceId('Microsoft.Resources/deployments', 'keyvault-deployment')]",
        "[resourceId('Microsoft.Resources/deployments', 'storage-deployment')]"
      ]
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "functionapp-processor-deployment",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "functionAppName": {
            "value": "[variables('functionAppProcessorName')]"
          },
          "location": {
            "value": "[parameters('location')]"
          },
          "tags": {
            "value": "[variables('tags')]"
          },
          "appServicePlanId": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', 'appserviceplan-deployment'), '2025-04-01').outputs.planId.value]"
          },
          "sku": {
            "value": "[parameters('functionAppSku')]"
          },
          "storageAccountName": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', 'storage-deployment'), '2025-04-01').outputs.storageAccountName.value]"
          },
          "storageConnectionString": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', 'storage-deployment'), '2025-04-01').outputs.connectionString.value]"
          },
          "storageBlobEndpoint": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', 'storage-deployment'), '2025-04-01').outputs.blobEndpoint.value]"
          },
          "storageQueueEndpoint": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', 'storage-deployment'), '2025-04-01').outputs.queueEndpoint.value]"
          },
          "storageTableEndpoint": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', 'storage-deployment'), '2025-04-01').outputs.tableEndpoint.value]"
          },
          "appInsightsConnectionString": "[if(parameters('enableAppInsights'), createObject('value', reference(resourceId('Microsoft.Resources/deployments', 'appinsights-deployment'), '2025-04-01').outputs.connectionString.value), createObject('value', ''))]",
          "appInsightsInstrumentationKey": "[if(parameters('enableAppInsights'), createObject('value', reference(resourceId('Microsoft.Resources/deployments', 'appinsights-deployment'), '2025-04-01').outputs.instrumentationKey.value), createObject('value', ''))]",
          "keyVaultName": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', 'keyvault-deployment'), '2025-04-01').outputs.keyVaultName.value]"
          },
          "additionalAppSettings": {
            "value": {
              "FUNCTION_APP_TYPE": "processor",
              "APP_VERSION": "[parameters('appVersion')]",
              "INSTALLATION_ID": "[variables('installationId')]"
            }
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.39.26.7824",
              "templateHash": "13760038921440905211"
            }
          },
          "parameters": {
            "functionAppName": {
              "type": "string",
              "metadata": {
                "description": "Name of the Function App"
              }
            },
            "location": {
              "type": "string",
              "metadata": {
                "description": "Azure region"
              }
            },
            "tags": {
              "type": "object",
              "metadata": {
                "description": "Tags to apply"
              }
            },
            "appServicePlanId": {
              "type": "string",
              "metadata": {
                "description": "App Service Plan resource ID"
              }
            },
            "sku": {
              "type": "string",
              "metadata": {
                "description": "App Service Plan SKU (Y1, EP1, EP2, EP3)"
              }
            },
            "storageAccountName": {
              "type": "string",
              "metadata": {
                "description": "Storage Account name"
              }
            },
            "storageConnectionString": {
              "type": "securestring",
              "metadata": {
                "description": "Storage Account connection string (for Y1/Consumption plan)"
              }
            },
            "storageBlobEndpoint": {
              "type": "string",
              "metadata": {
                "description": "Storage Account blob endpoint"
              }
            },
            "storageQueueEndpoint": {
              "type": "string",
              "metadata": {
                "description": "Storage Account queue endpoint"
              }
            },
            "storageTableEndpoint": {
              "type": "string",
              "metadata": {
                "description": "Storage Account table endpoint"
              }
            },
            "appInsightsConnectionString": {
              "type": "string",
              "defaultValue": "",
              "metadata": {
                "description": "Application Insights connection string"
              }
            },
            "appInsightsInstrumentationKey": {
              "type": "string",
              "defaultValue": "",
              "metadata": {
                "description": "Application Insights instrumentation key"
              }
            },
            "keyVaultName": {
              "type": "string",
              "metadata": {
                "description": "Key Vault name"
              }
            },
            "additionalAppSettings": {
              "type": "object",
              "defaultValue": {},
              "metadata": {
                "description": "Additional app settings"
              }
            }
          },
          "variables": {
            "isConsumptionPlan": "[equals(parameters('sku'), 'Y1')]",
            "consumptionStorageSettings": {
              "AzureWebJobsStorage": "[parameters('storageConnectionString')]",
              "WEBSITE_CONTENTAZUREFILECONNECTIONSTRING": "[parameters('storageConnectionString')]",
              "WEBSITE_CONTENTSHARE": "[toLower(parameters('functionAppName'))]"
            },
            "premiumStorageSettings": {
              "AzureWebJobsStorage__accountName": "[parameters('storageAccountName')]",
              "AzureWebJobsStorage__blobServiceUri": "[parameters('storageBlobEndpoint')]",
              "AzureWebJobsStorage__queueServiceUri": "[parameters('storageQueueEndpoint')]",
              "AzureWebJobsStorage__tableServiceUri": "[parameters('storageTableEndpoint')]"
            },
            "runtimeStorageSettings": "[if(variables('isConsumptionPlan'), variables('consumptionStorageSettings'), variables('premiumStorageSettings'))]",
            "baseAppSettings": {
              "FUNCTIONS_EXTENSION_VERSION": "~4",
              "FUNCTIONS_WORKER_RUNTIME": "python",
              "STORAGE_ACCOUNT_NAME": "[parameters('storageAccountName')]",
              "STORAGE_BLOB_ENDPOINT": "[parameters('storageBlobEndpoint')]",
              "STORAGE_QUEUE_ENDPOINT": "[parameters('storageQueueEndpoint')]",
              "STORAGE_TABLE_ENDPOINT": "[parameters('storageTableEndpoint')]",
              "KEY_VAULT_NAME": "[parameters('keyVaultName')]",
              "ENVIRONMENT": "production"
            },
            "appInsightsSettings": "[if(not(empty(parameters('appInsightsConnectionString'))), createObject('APPLICATIONINSIGHTS_CONNECTION_STRING', parameters('appInsightsConnectionString'), 'APPINSIGHTS_INSTRUMENTATIONKEY', parameters('appInsightsInstrumentationKey')), createObject())]",
            "appSettings": "[union(variables('runtimeStorageSettings'), variables('baseAppSettings'), variables('appInsightsSettings'), parameters('additionalAppSettings'))]"
          },
          "resources": [
            {
              "type": "Microsoft.Web/sites",
              "apiVersion": "2023-01-01",
              "name": "[parameters('functionAppName')]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]",
              "kind": "functionapp,linux",
              "identity": {
                "type": "SystemAssigned"
              },
              "properties": {
                "serverFarmId": "[parameters('appServicePlanId')]",
                "httpsOnly": true,
                "reserved": true,
                "siteConfig": {
                  "copy": [
                    {
                      "name": "appSettings",
                      "count": "[length(items(variables('appSettings')))]",
                      "input": {
                        "name": "[items(variables('appSettings'))[copyIndex('appSettings')].key]",
                        "value": "[string(items(variables('appSettings'))[copyIndex('appSettings')].value)]"
                      }
                    }
                  ],
                  "linuxFxVersion": "PYTHON|3.10",
                  "ftpsState": "Disabled",
                  "minTlsVersion": "1.2",
                  "cors": {
                    "allowedOrigins": [
                      "https://portal.azure.com",
                      "https://*.azurestaticapps.net"
                    ],
                    "supportCredentials": true
                  }
                }
              }
            }
          ],
          "outputs": {
            "functionAppName": {
              "type": "string",
              "metadata": {
                "description": "Function App name"
              },
              "value": "[parameters('functionAppName')]"
            },
            "defaultHostname": {
              "type": "string",
              "metadata": {
                "description": "Function App default hostname"
              },
              "value": "[reference(resourceId('Microsoft.Web/sites', parameters('functionAppName')), '2023-01-01').defaultHostName]"
            },
            "principalId": {
              "type": "string",
              "metadata": {
                "description": "Function App principal ID (Managed Identity)"
              },
              "value": "[reference(resourceId('Microsoft.Web/sites', parameters('functionAppName')), '2023-01-01', 'full').identity.principalId]"
            },
            "resourceId": {
              "type": "string",
              "metadata": {
                "description": "Function App resource ID"
              },
              "value": "[resourceId('Microsoft.Web/sites', parameters('functionAppName'))]"
            },
            "isConsumptionPlan": {
              "type": "bool",
              "metadata": {
                "description": "Is using Consumption plan"
              },
              "value": "[variables('isConsumptionPlan')]"
            }
          }
        }
      },
      "dependsOn": [
        "[resourceId('Microsoft.Resources/deployments', 'appinsights-deployment')]",
        "[resourceId('Microsoft.Resources/deployments', 'appregistration-deployment')]",
        "[resourceId('Microsoft.Resources/deployments', 'appserviceplan-deployment')]",
        "[resourceId('Microsoft.Resources/deployments', 'keyvault-deployment')]",
        "[resourceId('Microsoft.Resources/deployments', 'storage-deployment')]"
      ]
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "rbac-all-assignments",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "location": {
            "value": "[parameters('location')]"
          },
          "tags": {
            "value": "[variables('tags')]"
          },
          "identityId": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', 'deployment-identity'), '2025-04-01').outputs.identityId.value]"
          },
          "resourceGroupName": {
            "value": "[resourceGroup().name]"
          },
          "roleAssignments": {
            "value": [
              {
                "principalId": "[reference(resourceId('Microsoft.Resources/deployments', 'functionapp-api-deployment'), '2025-04-01').outputs.principalId.value]",
                "scope": "[reference(resourceId('Microsoft.Resources/deployments', 'keyvault-deployment'), '2025-04-01').outputs.keyVaultId.value]",
                "roleId": "[variables('keyVaultSecretsUserRoleId')]",
                "description": "API - Key Vault Secrets User"
              },
              {
                "principalId": "[reference(resourceId('Microsoft.Resources/deployments', 'functionapp-api-deployment'), '2025-04-01').outputs.principalId.value]",
                "scope": "[reference(resourceId('Microsoft.Resources/deployments', 'storage-deployment'), '2025-04-01').outputs.storageAccountId.value]",
                "roleId": "[variables('storageBlobDataContributorRoleId')]",
                "description": "API - Storage Blob Contributor"
              },
              {
                "principalId": "[reference(resourceId('Microsoft.Resources/deployments', 'functionapp-api-deployment'), '2025-04-01').outputs.principalId.value]",
                "scope": "[reference(resourceId('Microsoft.Resources/deployments', 'storage-deployment'), '2025-04-01').outputs.storageAccountId.value]",
                "roleId": "[variables('storageQueueDataContributorRoleId')]",
                "description": "API - Storage Queue Contributor"
              },
              {
                "principalId": "[reference(resourceId('Microsoft.Resources/deployments', 'functionapp-api-deployment'), '2025-04-01').outputs.principalId.value]",
                "scope": "[reference(resourceId('Microsoft.Resources/deployments', 'storage-deployment'), '2025-04-01').outputs.storageAccountId.value]",
                "roleId": "[variables('storageTableDataContributorRoleId')]",
                "description": "API - Storage Table Contributor"
              },
              {
                "principalId": "[reference(resourceId('Microsoft.Resources/deployments', 'functionapp-scheduler-deployment'), '2025-04-01').outputs.principalId.value]",
                "scope": "[reference(resourceId('Microsoft.Resources/deployments', 'keyvault-deployment'), '2025-04-01').outputs.keyVaultId.value]",
                "roleId": "[variables('keyVaultSecretsUserRoleId')]",
                "description": "Scheduler - Key Vault Secrets User"
              },
              {
                "principalId": "[reference(resourceId('Microsoft.Resources/deployments', 'functionapp-scheduler-deployment'), '2025-04-01').outputs.principalId.value]",
                "scope": "[reference(resourceId('Microsoft.Resources/deployments', 'storage-deployment'), '2025-04-01').outputs.storageAccountId.value]",
                "roleId": "[variables('storageBlobDataContributorRoleId')]",
                "description": "Scheduler - Storage Blob Contributor"
              },
              {
                "principalId": "[reference(resourceId('Microsoft.Resources/deployments', 'functionapp-scheduler-deployment'), '2025-04-01').outputs.principalId.value]",
                "scope": "[reference(resourceId('Microsoft.Resources/deployments', 'storage-deployment'), '2025-04-01').outputs.storageAccountId.value]",
                "roleId": "[variables('storageQueueDataContributorRoleId')]",
                "description": "Scheduler - Storage Queue Contributor"
              },
              {
                "principalId": "[reference(resourceId('Microsoft.Resources/deployments', 'functionapp-scheduler-deployment'), '2025-04-01').outputs.principalId.value]",
                "scope": "[reference(resourceId('Microsoft.Resources/deployments', 'storage-deployment'), '2025-04-01').outputs.storageAccountId.value]",
                "roleId": "[variables('storageTableDataContributorRoleId')]",
                "description": "Scheduler - Storage Table Contributor"
              },
              {
                "principalId": "[reference(resourceId('Microsoft.Resources/deployments', 'functionapp-processor-deployment'), '2025-04-01').outputs.principalId.value]",
                "scope": "[reference(resourceId('Microsoft.Resources/deployments', 'keyvault-deployment'), '2025-04-01').outputs.keyVaultId.value]",
                "roleId": "[variables('keyVaultSecretsUserRoleId')]",
                "description": "Processor - Key Vault Secrets User"
              },
              {
                "principalId": "[reference(resourceId('Microsoft.Resources/deployments', 'functionapp-processor-deployment'), '2025-04-01').outputs.principalId.value]",
                "scope": "[reference(resourceId('Microsoft.Resources/deployments', 'storage-deployment'), '2025-04-01').outputs.storageAccountId.value]",
                "roleId": "[variables('storageBlobDataContributorRoleId')]",
                "description": "Processor - Storage Blob Contributor"
              },
              {
                "principalId": "[reference(resourceId('Microsoft.Resources/deployments', 'functionapp-processor-deployment'), '2025-04-01').outputs.principalId.value]",
                "scope": "[reference(resourceId('Microsoft.Resources/deployments', 'storage-deployment'), '2025-04-01').outputs.storageAccountId.value]",
                "roleId": "[variables('storageQueueDataContributorRoleId')]",
                "description": "Processor - Storage Queue Contributor"
              },
              {
                "principalId": "[reference(resourceId('Microsoft.Resources/deployments', 'functionapp-processor-deployment'), '2025-04-01').outputs.principalId.value]",
                "scope": "[reference(resourceId('Microsoft.Resources/deployments', 'storage-deployment'), '2025-04-01').outputs.storageAccountId.value]",
                "roleId": "[variables('storageTableDataContributorRoleId')]",
                "description": "Processor - Storage Table Contributor"
              }
            ]
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.39.26.7824",
              "templateHash": "16765930261850215111"
            }
          },
          "parameters": {
            "location": {
              "type": "string",
              "metadata": {
                "description": "Azure region"
              }
            },
            "tags": {
              "type": "object",
              "metadata": {
                "description": "Tags to apply"
              }
            },
            "identityId": {
              "type": "string",
              "metadata": {
                "description": "User-assigned Managed Identity ID for running the script"
              }
            },
            "resourceGroupName": {
              "type": "string",
              "metadata": {
                "description": "Resource group name"
              }
            },
            "roleAssignments": {
              "type": "array",
              "metadata": {
                "description": "Array of role assignments to create"
              }
            }
          },
          "resources": [
            {
              "type": "Microsoft.Resources/deploymentScripts",
              "apiVersion": "2023-08-01",
              "name": "create-role-assignments",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]",
              "kind": "AzureCLI",
              "identity": {
                "type": "UserAssigned",
                "userAssignedIdentities": {
                  "[format('{0}', parameters('identityId'))]": {}
                }
              },
              "properties": {
                "azCliVersion": "2.50.0",
                "timeout": "PT10M",
                "retentionInterval": "PT1H",
                "cleanupPreference": "OnSuccess",
                "environmentVariables": [
                  {
                    "name": "ROLE_ASSIGNMENTS_JSON",
                    "value": "[string(parameters('roleAssignments'))]"
                  },
                  {
                    "name": "RESOURCE_GROUP",
                    "value": "[parameters('resourceGroupName')]"
                  }
                ],
                "scriptContent": "      #!/bin/bash\n\n      echo \"==========================================\"\n      echo \"Creating Role Assignments (Resilient)\"\n      echo \"==========================================\"\n\n      # Install jq for JSON parsing (Alpine-based container)\n      echo \"Installing jq...\"\n      apk add --no-cache jq > /dev/null 2>&1 || apt-get install -y jq > /dev/null 2>&1 || echo \"jq may already be installed\"\n\n      # Parse the JSON array of role assignments\n      ASSIGNMENTS=$(echo \"$ROLE_ASSIGNMENTS_JSON\" | tr -d '\\n')\n\n      SUCCESS_COUNT=0\n      SKIPPED_COUNT=0\n      FAILED_COUNT=0\n\n      # Process each role assignment\n      echo \"$ASSIGNMENTS\" | jq -c '.[]' | while read -r assignment; do\n        PRINCIPAL_ID=$(echo \"$assignment\" | jq -r '.principalId')\n        SCOPE=$(echo \"$assignment\" | jq -r '.scope')\n        ROLE_ID=$(echo \"$assignment\" | jq -r '.roleId')\n        DESCRIPTION=$(echo \"$assignment\" | jq -r '.description // \"Role assignment\"')\n\n        echo \"\"\n        echo \"Processing: $DESCRIPTION\"\n        echo \"  Principal: $PRINCIPAL_ID\"\n        echo \"  Role: $ROLE_ID\"\n        echo \"  Scope: $SCOPE\"\n\n        # Try to create the role assignment\n        OUTPUT=$(az role assignment create \\\n          --assignee-object-id \"$PRINCIPAL_ID\" \\\n          --assignee-principal-type ServicePrincipal \\\n          --role \"$ROLE_ID\" \\\n          --scope \"$SCOPE\" 2>&1) || true\n\n        # Check the result\n        if echo \"$OUTPUT\" | grep -q \"already exists\"; then\n          echo \"  ⏭️  SKIPPED - Already exists\"\n        elif echo \"$OUTPUT\" | grep -q \"roleAssignmentId\"; then\n          echo \"  ✅ CREATED\"\n        elif echo \"$OUTPUT\" | grep -q \"error\"; then\n          echo \"  ⚠️  WARNING: $OUTPUT\"\n          # Don't fail, just warn\n        else\n          echo \"  ✅ OK\"\n        fi\n      done\n\n      echo \"\"\n      echo \"==========================================\"\n      echo \"Role Assignments Complete\"\n      echo \"==========================================\"\n\n      # Always succeed - role assignments should not block deployment\n      echo '{\"status\": \"success\"}' > $AZ_SCRIPTS_OUTPUT_PATH\n    "
              }
            }
          ],
          "outputs": {
            "status": {
              "type": "string",
              "metadata": {
                "description": "Deployment script status"
              },
              "value": "[reference(resourceId('Microsoft.Resources/deploymentScripts', 'create-role-assignments'), '2023-08-01').provisioningState]"
            }
          }
        }
      },
      "dependsOn": [
        "[resourceId('Microsoft.Resources/deployments', 'deployment-identity')]",
        "[resourceId('Microsoft.Resources/deployments', 'functionapp-api-deployment')]",
        "[resourceId('Microsoft.Resources/deployments', 'functionapp-processor-deployment')]",
        "[resourceId('Microsoft.Resources/deployments', 'functionapp-scheduler-deployment')]",
        "[resourceId('Microsoft.Resources/deployments', 'keyvault-deployment')]",
        "[resourceId('Microsoft.Resources/deployments', 'rbac-deployment-contributor')]",
        "[resourceId('Microsoft.Resources/deployments', 'storage-deployment')]"
      ]
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "code-deployment",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "location": {
            "value": "[parameters('location')]"
          },
          "tags": {
            "value": "[variables('tags')]"
          },
          "identityId": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', 'deployment-identity'), '2025-04-01').outputs.identityId.value]"
          },
          "version": {
            "value": "[parameters('appVersion')]"
          },
          "staticWebAppName": {
            "value": "[variables('staticWebAppName')]"
          },
          "apiFunctionAppName": {
            "value": "[variables('functionAppApiName')]"
          },
          "schedulerFunctionAppName": {
            "value": "[variables('functionAppSchedulerName')]"
          },
          "processorFunctionAppName": {
            "value": "[variables('functionAppProcessorName')]"
          },
          "resourceGroupName": {
            "value": "[resourceGroup().name]"
          },
          "apiBaseUrl": {
            "value": "[format('https://{0}.azurewebsites.net', variables('functionAppApiName'))]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.39.26.7824",
              "templateHash": "13094006017243187220"
            }
          },
          "parameters": {
            "location": {
              "type": "string",
              "metadata": {
                "description": "Azure region"
              }
            },
            "tags": {
              "type": "object",
              "metadata": {
                "description": "Tags to apply"
              }
            },
            "identityId": {
              "type": "string",
              "metadata": {
                "description": "User-assigned Managed Identity ID for running the script"
              }
            },
            "gitHubRepo": {
              "type": "string",
              "defaultValue": "pablodiloreto/dilux-azure-databases-backup-alpha",
              "metadata": {
                "description": "GitHub repository (owner/repo)"
              }
            },
            "version": {
              "type": "string",
              "metadata": {
                "description": "Version to deploy (GitHub release tag)"
              }
            },
            "staticWebAppName": {
              "type": "string",
              "metadata": {
                "description": "Static Web App name"
              }
            },
            "apiFunctionAppName": {
              "type": "string",
              "metadata": {
                "description": "API Function App name"
              }
            },
            "schedulerFunctionAppName": {
              "type": "string",
              "metadata": {
                "description": "Scheduler Function App name"
              }
            },
            "processorFunctionAppName": {
              "type": "string",
              "metadata": {
                "description": "Processor Function App name"
              }
            },
            "resourceGroupName": {
              "type": "string",
              "metadata": {
                "description": "Resource group name"
              }
            },
            "apiBaseUrl": {
              "type": "string",
              "metadata": {
                "description": "API base URL for frontend build"
              }
            }
          },
          "resources": [
            {
              "type": "Microsoft.Resources/deploymentScripts",
              "apiVersion": "2023-08-01",
              "name": "deploy-application-code",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]",
              "kind": "AzureCLI",
              "identity": {
                "type": "UserAssigned",
                "userAssignedIdentities": {
                  "[format('{0}', parameters('identityId'))]": {}
                }
              },
              "properties": {
                "azCliVersion": "2.50.0",
                "timeout": "PT20M",
                "retentionInterval": "PT1H",
                "cleanupPreference": "OnSuccess",
                "environmentVariables": [
                  {
                    "name": "GITHUB_REPO",
                    "value": "[parameters('gitHubRepo')]"
                  },
                  {
                    "name": "VERSION",
                    "value": "[parameters('version')]"
                  },
                  {
                    "name": "STATIC_WEB_APP_NAME",
                    "value": "[parameters('staticWebAppName')]"
                  },
                  {
                    "name": "API_FUNCTION_APP_NAME",
                    "value": "[parameters('apiFunctionAppName')]"
                  },
                  {
                    "name": "SCHEDULER_FUNCTION_APP_NAME",
                    "value": "[parameters('schedulerFunctionAppName')]"
                  },
                  {
                    "name": "PROCESSOR_FUNCTION_APP_NAME",
                    "value": "[parameters('processorFunctionAppName')]"
                  },
                  {
                    "name": "RESOURCE_GROUP",
                    "value": "[parameters('resourceGroupName')]"
                  },
                  {
                    "name": "VITE_API_BASE_URL",
                    "value": "[parameters('apiBaseUrl')]"
                  }
                ],
                "scriptContent": "#!/bin/bash\nset -e\n\necho \"==========================================\"\necho \"Deploying Dilux Database Backup\"\necho \"==========================================\"\n\n# Function to deploy with retry (for RBAC propagation delay)\ndeploy_with_retry() {\n  local app_name=$1\n  local zip_file=$2\n  local max_attempts=5\n  local attempt=1\n  local wait_time=30\n\n  while [ $attempt -le $max_attempts ]; do\n    echo \"    Attempt $attempt of $max_attempts...\"\n\n    if az functionapp deployment source config-zip \\\n      --resource-group $RESOURCE_GROUP \\\n      --name $app_name \\\n      --src $zip_file \\\n      --timeout 300 2>&1; then\n      echo \"    Success!\"\n      return 0\n    fi\n\n    if [ $attempt -lt $max_attempts ]; then\n      echo \"    Failed. Waiting ${wait_time}s for RBAC propagation...\"\n      sleep $wait_time\n      wait_time=$((wait_time + 30))\n    fi\n\n    attempt=$((attempt + 1))\n  done\n\n  echo \"    ERROR: Failed after $max_attempts attempts\"\n  return 1\n}\n\n# Resolve \"latest\" to actual version tag using GitHub API\nif [ \"$VERSION\" == \"latest\" ]; then\n  echo \"Resolving latest release from GitHub...\"\n\n  RELEASE_INFO=$(curl -s \"https://api.github.com/repos/$GITHUB_REPO/releases/latest\")\n  RESOLVED_VERSION=$(echo \"$RELEASE_INFO\" | grep '\"tag_name\"' | head -1 | sed -E 's/.*\"tag_name\": *\"([^\"]+)\".*/\\1/')\n\n  if [ -z \"$RESOLVED_VERSION\" ] || [ \"$RESOLVED_VERSION\" == \"null\" ]; then\n    echo \"ERROR: Could not resolve latest release\"\n    echo \"Make sure the repository has at least one published release.\"\n    echo '{\"status\": \"failed\", \"error\": \"No releases found\"}' > $AZ_SCRIPTS_OUTPUT_PATH\n    exit 1\n  fi\n\n  echo \"Resolved latest to: $RESOLVED_VERSION\"\n  VERSION=$RESOLVED_VERSION\nfi\n\necho \"Version: $VERSION\"\necho \"Repository: $GITHUB_REPO\"\necho \"==========================================\"\n\n# Base URL for release assets\nRELEASE_URL=\"https://github.com/$GITHUB_REPO/releases/download/$VERSION\"\n\necho \"\"\necho \"Downloading pre-built release assets from:\"\necho \"$RELEASE_URL\"\necho \"\"\n\n# Download all ZIPs (frontend + 3 Function Apps)\necho \"[1/4] Downloading frontend.zip...\"\nif ! curl -L -f -s -o frontend.zip \"$RELEASE_URL/frontend.zip\"; then\n  echo \"ERROR: Could not download frontend.zip\"\n  echo \"URL: $RELEASE_URL/frontend.zip\"\n  echo \"\"\n  echo \"Make sure:\"\n  echo \"1. The release $VERSION exists\"\n  echo \"2. The release has frontend.zip, api.zip, scheduler.zip, processor.zip assets\"\n  echo \"3. Run the Build Release Assets GitHub Action first\"\n  echo \"\"\n  echo '{\"status\": \"failed\", \"error\": \"Could not download frontend.zip\"}' > $AZ_SCRIPTS_OUTPUT_PATH\n  exit 1\nfi\necho \"    Downloaded frontend.zip\"\n\necho \"[2/4] Downloading api.zip...\"\nif ! curl -L -f -s -o api.zip \"$RELEASE_URL/api.zip\"; then\n  echo \"ERROR: Could not download api.zip\"\n  echo '{\"status\": \"failed\", \"error\": \"Could not download api.zip\"}' > $AZ_SCRIPTS_OUTPUT_PATH\n  exit 1\nfi\necho \"    Downloaded api.zip\"\n\necho \"[3/4] Downloading scheduler.zip...\"\nif ! curl -L -f -s -o scheduler.zip \"$RELEASE_URL/scheduler.zip\"; then\n  echo \"ERROR: Could not download scheduler.zip\"\n  echo '{\"status\": \"failed\", \"error\": \"Could not download scheduler.zip\"}' > $AZ_SCRIPTS_OUTPUT_PATH\n  exit 1\nfi\necho \"    Downloaded scheduler.zip\"\n\necho \"[4/4] Downloading processor.zip...\"\nif ! curl -L -f -s -o processor.zip \"$RELEASE_URL/processor.zip\"; then\n  echo \"ERROR: Could not download processor.zip\"\n  echo '{\"status\": \"failed\", \"error\": \"Could not download processor.zip\"}' > $AZ_SCRIPTS_OUTPUT_PATH\n  exit 1\nfi\necho \"    Downloaded processor.zip\"\n\necho \"\"\necho \"All assets downloaded successfully:\"\nls -lh *.zip\necho \"\"\n\n# ========================================\n# Install Node.js and SWA CLI for frontend deployment\n# ========================================\necho \"==========================================\"\necho \"Installing Node.js and SWA CLI...\"\necho \"==========================================\"\n\n# Install Node.js (CBL-Mariner uses tdnf)\nif command -v tdnf &> /dev/null; then\n  echo \"Installing Node.js via tdnf...\"\n  tdnf install -y nodejs npm 2>&1 || echo \"Node.js may already be installed\"\nelif command -v dnf &> /dev/null; then\n  echo \"Installing Node.js via dnf...\"\n  dnf install -y nodejs npm 2>&1 || echo \"Node.js may already be installed\"\nelif command -v apt-get &> /dev/null; then\n  echo \"Installing Node.js via apt...\"\n  apt-get update && apt-get install -y nodejs npm 2>&1 || echo \"Node.js may already be installed\"\nelse\n  echo \"WARNING: Could not find package manager to install Node.js\"\n  echo \"Frontend deployment may fail\"\nfi\n\n# Verify Node.js installation\nif command -v node &> /dev/null; then\n  echo \"Node.js version: $(node --version)\"\n  echo \"npm version: $(npm --version)\"\n\n  # Install SWA CLI\n  echo \"Installing Azure Static Web Apps CLI...\"\n  npm install -g @azure/static-web-apps-cli 2>&1 || echo \"SWA CLI installation failed\"\n\n  if command -v swa &> /dev/null; then\n    echo \"SWA CLI installed successfully\"\n    SWA_CLI_AVAILABLE=true\n  else\n    echo \"WARNING: SWA CLI not available\"\n    SWA_CLI_AVAILABLE=false\n  fi\nelse\n  echo \"WARNING: Node.js not available\"\n  SWA_CLI_AVAILABLE=false\nfi\n\necho \"\"\n\n# ========================================\n# Wait for RBAC propagation\n# ========================================\necho \"==========================================\"\necho \"Waiting for RBAC permissions to propagate...\"\necho \"==========================================\"\necho \"(Azure AD role assignments can take up to 5 minutes to propagate)\"\nsleep 60\necho \"Waited 60 seconds. Starting deployment...\"\necho \"\"\n\n# ========================================\n# Deploy Static Web App (Frontend)\n# ========================================\necho \"==========================================\"\necho \"Deploying Static Web App (Frontend)...\"\necho \"==========================================\"\necho \"\"\necho \"Static Web App: $STATIC_WEB_APP_NAME\"\n\nif [ \"$SWA_CLI_AVAILABLE\" = true ]; then\n  # Get deployment token\n  echo \"Getting deployment token...\"\n  DEPLOYMENT_TOKEN=$(az staticwebapp secrets list \\\n    --name $STATIC_WEB_APP_NAME \\\n    --resource-group $RESOURCE_GROUP \\\n    --query \"properties.apiKey\" -o tsv 2>/dev/null || echo \"\")\n\n  if [ -n \"$DEPLOYMENT_TOKEN\" ]; then\n    echo \"Extracting frontend.zip...\"\n    mkdir -p frontend_dist\n    unzip -q frontend.zip -d frontend_dist\n\n    echo \"Deploying frontend...\"\n    if swa deploy ./frontend_dist --deployment-token \"$DEPLOYMENT_TOKEN\" --env production 2>&1; then\n      echo \"    Frontend deployed successfully!\"\n      FRONTEND_DEPLOYED=true\n    else\n      echo \"    WARNING: Frontend deployment failed, but continuing...\"\n      FRONTEND_DEPLOYED=false\n    fi\n  else\n    echo \"    WARNING: Could not get deployment token\"\n    FRONTEND_DEPLOYED=false\n  fi\nelse\n  echo \"    WARNING: SWA CLI not available, skipping frontend deployment\"\n  FRONTEND_DEPLOYED=false\nfi\n\necho \"\"\n\n# ========================================\n# Deploy Function Apps (with retry)\n# ========================================\necho \"==========================================\"\necho \"Deploying Function Apps...\"\necho \"==========================================\"\n\necho \"\"\necho \"[1/3] Deploying API Function App: $API_FUNCTION_APP_NAME\"\nif ! deploy_with_retry $API_FUNCTION_APP_NAME api.zip; then\n  echo '{\"status\": \"failed\", \"error\": \"Failed to deploy API Function App\"}' > $AZ_SCRIPTS_OUTPUT_PATH\n  exit 1\nfi\n\necho \"\"\necho \"[2/3] Deploying Scheduler Function App: $SCHEDULER_FUNCTION_APP_NAME\"\nif ! deploy_with_retry $SCHEDULER_FUNCTION_APP_NAME scheduler.zip; then\n  echo '{\"status\": \"failed\", \"error\": \"Failed to deploy Scheduler Function App\"}' > $AZ_SCRIPTS_OUTPUT_PATH\n  exit 1\nfi\n\necho \"\"\necho \"[3/3] Deploying Processor Function App: $PROCESSOR_FUNCTION_APP_NAME\"\nif ! deploy_with_retry $PROCESSOR_FUNCTION_APP_NAME processor.zip; then\n  echo '{\"status\": \"failed\", \"error\": \"Failed to deploy Processor Function App\"}' > $AZ_SCRIPTS_OUTPUT_PATH\n  exit 1\nfi\n\n# Get URLs for output\nSWA_URL=$(az staticwebapp show \\\n  --name $STATIC_WEB_APP_NAME \\\n  --resource-group $RESOURCE_GROUP \\\n  --query \"defaultHostname\" -o tsv 2>/dev/null || echo \"\")\n\nAPI_URL=$(az functionapp show \\\n  --name $API_FUNCTION_APP_NAME \\\n  --resource-group $RESOURCE_GROUP \\\n  --query \"defaultHostName\" -o tsv 2>/dev/null || echo \"\")\n\necho \"\"\necho \"==========================================\"\necho \"DEPLOYMENT COMPLETE\"\necho \"==========================================\"\necho \"\"\necho \"All components deployed successfully!\"\necho \"\"\necho \"URLs:\"\necho \"  Frontend: https://$SWA_URL\"\necho \"  API:      https://$API_URL\"\necho \"\"\n\nif [ \"$FRONTEND_DEPLOYED\" != true ]; then\n  echo \"NOTE: Frontend deployment requires manual step.\"\n  echo \"Get the deployment token from Azure Portal and run:\"\n  echo \"  swa deploy ./dist --deployment-token <token>\"\n  echo \"\"\nfi\n\n# Output results\ncat > $AZ_SCRIPTS_OUTPUT_PATH << EOF\n{\n  \"status\": \"success\",\n  \"version\": \"$VERSION\",\n  \"frontendDeployed\": $FRONTEND_DEPLOYED,\n  \"functionAppsDeployed\": true,\n  \"apiUrl\": \"https://$API_URL\",\n  \"frontendUrl\": \"https://$SWA_URL\"\n}\nEOF\n    "
              }
            }
          ],
          "outputs": {
            "status": {
              "type": "string",
              "metadata": {
                "description": "Deployment script status"
              },
              "value": "[reference(resourceId('Microsoft.Resources/deploymentScripts', 'deploy-application-code'), '2023-08-01').provisioningState]"
            },
            "deployedVersion": {
              "type": "string",
              "metadata": {
                "description": "Deployed version"
              },
              "value": "[parameters('version')]"
            }
          }
        }
      },
      "dependsOn": [
        "[resourceId('Microsoft.Resources/deployments', 'deployment-identity')]",
        "[resourceId('Microsoft.Resources/deployments', 'functionapp-api-deployment')]",
        "[resourceId('Microsoft.Resources/deployments', 'functionapp-processor-deployment')]",
        "[resourceId('Microsoft.Resources/deployments', 'functionapp-scheduler-deployment')]",
        "[resourceId('Microsoft.Resources/deployments', 'rbac-all-assignments')]",
        "[resourceId('Microsoft.Resources/deployments', 'rbac-deployment-contributor')]",
        "[resourceId('Microsoft.Resources/deployments', 'staticwebapp-deployment')]"
      ]
    }
  ],
  "outputs": {
    "apiUrl": {
      "type": "string",
      "metadata": {
        "description": "URL of the API Function App"
      },
      "value": "[format('https://{0}.azurewebsites.net', variables('functionAppApiName'))]"
    },
    "frontendUrl": {
      "type": "string",
      "metadata": {
        "description": "URL of the Static Web App (Frontend)"
      },
      "value": "[reference(resourceId('Microsoft.Resources/deployments', 'staticwebapp-deployment'), '2025-04-01').outputs.defaultHostname.value]"
    },
    "storageAccountName": {
      "type": "string",
      "metadata": {
        "description": "Storage Account name"
      },
      "value": "[reference(resourceId('Microsoft.Resources/deployments', 'storage-deployment'), '2025-04-01').outputs.storageAccountName.value]"
    },
    "keyVaultName": {
      "type": "string",
      "metadata": {
        "description": "Key Vault name"
      },
      "value": "[reference(resourceId('Microsoft.Resources/deployments', 'keyvault-deployment'), '2025-04-01').outputs.keyVaultName.value]"
    },
    "appInsightsName": {
      "type": "string",
      "metadata": {
        "description": "Application Insights name"
      },
      "value": "[if(parameters('enableAppInsights'), reference(resourceId('Microsoft.Resources/deployments', 'appinsights-deployment'), '2025-04-01').outputs.appInsightsName.value, 'Not deployed')]"
    },
    "installationId": {
      "type": "string",
      "metadata": {
        "description": "Installation ID (unique identifier for this deployment)"
      },
      "value": "[variables('installationId')]"
    },
    "appVersion": {
      "type": "string",
      "metadata": {
        "description": "Application version"
      },
      "value": "[parameters('appVersion')]"
    },
    "adminEmail": {
      "type": "string",
      "metadata": {
        "description": "Admin email configured"
      },
      "value": "[parameters('adminEmail')]"
    },
    "azureAdClientId": {
      "type": "string",
      "metadata": {
        "description": "Azure AD Client ID (empty if manual setup required)"
      },
      "value": "[if(parameters('skipAppRegistration'), '', if(reference(resourceId('Microsoft.Resources/deployments', 'appregistration-deployment'), '2025-04-01').outputs.success.value, reference(resourceId('Microsoft.Resources/deployments', 'appregistration-deployment'), '2025-04-01').outputs.clientId.value, ''))]"
    },
    "azureAdTenantId": {
      "type": "string",
      "metadata": {
        "description": "Azure AD Tenant ID"
      },
      "value": "[variables('tenantId')]"
    },
    "appRegistrationSuccess": {
      "type": "bool",
      "metadata": {
        "description": "App Registration created successfully"
      },
      "value": "[if(parameters('skipAppRegistration'), false(), reference(resourceId('Microsoft.Resources/deployments', 'appregistration-deployment'), '2025-04-01').outputs.success.value)]"
    },
    "nextSteps": {
      "type": "string",
      "metadata": {
        "description": "Next steps message"
      },
      "value": "[if(or(parameters('skipAppRegistration'), not(reference(resourceId('Microsoft.Resources/deployments', 'appregistration-deployment'), '2025-04-01').outputs.success.value)), 'App Registration requires manual setup. Check deployment logs for instructions.', format('Deployment complete! Access the app at https://{0}', reference(resourceId('Microsoft.Resources/deployments', 'staticwebapp-deployment'), '2025-04-01').outputs.defaultHostname.value))]"
    },
    "codeDeploymentStatus": {
      "type": "string",
      "metadata": {
        "description": "Code deployment status"
      },
      "value": "[reference(resourceId('Microsoft.Resources/deployments', 'code-deployment'), '2025-04-01').outputs.status.value]"
    }
  }
}