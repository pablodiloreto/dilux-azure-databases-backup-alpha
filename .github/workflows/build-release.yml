# ============================================================================
# Dilux Database Backup - Build Release Assets
# ============================================================================
# This workflow runs when a version tag is pushed (v*) and:
# 1. Creates a GitHub Release automatically
# 2. Builds the frontend (React) as ZIP for Static Web App
# 3. Builds Function App ZIPs with Python code + database tools
#
# Database tools (mysqldump, pg_dump, sqlcmd) are included in each Function App
# ZIP to enable backups without Docker containers.
#
# Usage:
#   git tag v1.0.39
#   git push --tags
# ============================================================================

name: Build Release Assets

on:
  push:
    tags:
      - 'v*'

# Required permissions
permissions:
  contents: write

env:
  PYTHON_VERSION: '3.11'
  NODE_VERSION: '18'

jobs:
  build-and-release:
    name: Build and Create Release
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Get version from tag
        id: version
        run: |
          VERSION=${GITHUB_REF#refs/tags/}
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Building version: $VERSION"

      # ========================================
      # Setup Python
      # ========================================
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      # ========================================
      # Download Database Tools
      # ========================================
      - name: Download database tools
        run: |
          echo "ðŸ“¦ Downloading database CLI tools..."
          mkdir -p tools/bin

          # ---- MySQL client (mysqldump, mysql) ----
          echo "  â†’ MySQL client..."
          sudo apt-get update -qq
          apt-get download mysql-client-core-8.0
          dpkg -x mysql-client-core-8.0*.deb ./mysql-extract
          cp ./mysql-extract/usr/bin/mysqldump tools/bin/
          cp ./mysql-extract/usr/bin/mysql tools/bin/
          rm -rf mysql-extract mysql-client-core-8.0*.deb

          # ---- PostgreSQL client (pg_dump, psql) ----
          echo "  â†’ PostgreSQL client..."
          # Ubuntu 24.04 (noble) uses PostgreSQL 16
          apt-get download postgresql-client-16 postgresql-client-common postgresql-common
          dpkg -x postgresql-common*.deb ./pg-extract
          dpkg -x postgresql-client-common*.deb ./pg-extract
          dpkg -x postgresql-client-16*.deb ./pg-extract
          cp ./pg-extract/usr/lib/postgresql/16/bin/pg_dump tools/bin/
          cp ./pg-extract/usr/lib/postgresql/16/bin/psql tools/bin/
          rm -rf pg-extract postgresql-*.deb

          # ---- SQL Server client (sqlcmd) ----
          echo "  â†’ SQL Server client..."
          # Ubuntu 22.04 has mssql-tools18 in Microsoft repo (already configured in GitHub runners)
          sudo ACCEPT_EULA=Y apt-get install -y mssql-tools18 > /dev/null 2>&1 || true
          if [ -f /opt/mssql-tools18/bin/sqlcmd ]; then
            cp /opt/mssql-tools18/bin/sqlcmd tools/bin/
            cp /opt/mssql-tools18/bin/bcp tools/bin/
          else
            # Fallback: try mssql-tools (older version)
            sudo ACCEPT_EULA=Y apt-get install -y mssql-tools > /dev/null 2>&1 || true
            if [ -f /opt/mssql-tools/bin/sqlcmd ]; then
              cp /opt/mssql-tools/bin/sqlcmd tools/bin/
              cp /opt/mssql-tools/bin/bcp tools/bin/
            else
              echo "âš ï¸ Warning: sqlcmd not available, SQL Server backups won't work"
            fi
          fi

          # Set execute permissions
          chmod +x tools/bin/*

          # List tools
          echo ""
          echo "âœ… Database tools downloaded:"
          ls -la tools/bin/
          echo ""

          # Verify tools work
          echo "Verifying tools..."
          tools/bin/mysqldump --version || echo "mysqldump check failed"
          tools/bin/pg_dump --version || echo "pg_dump check failed"
          tools/bin/sqlcmd -? 2>&1 | head -1 || echo "sqlcmd check failed"

      # ========================================
      # Build Frontend
      # ========================================
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: src/frontend/package-lock.json

      - name: Build Frontend
        run: |
          cd src/frontend
          npm ci
          npm run build
          cd dist
          zip -r ../../../frontend.zip .
          echo "âœ… Frontend built and zipped"

      # ========================================
      # Build Function App ZIPs
      # ========================================
      - name: Build API Function App ZIP
        run: |
          echo "ðŸ“¦ Building API Function App..."
          mkdir -p build/api

          # Copy function app code
          cp -r src/functions/api/* build/api/

          # Copy shared package
          mkdir -p build/api/shared
          cp -r src/shared/* build/api/shared/

          # Copy database tools
          mkdir -p build/api/tools/bin
          cp tools/bin/* build/api/tools/bin/

          # Install Python dependencies
          pip install -r src/shared/requirements.txt -t build/api/.python_packages/lib/site-packages --quiet

          # Create ZIP
          cd build/api
          zip -r ../../api.zip . -x "*.pyc" -x "__pycache__/*"
          cd ../..

          echo "âœ… API ZIP created: $(du -h api.zip | cut -f1)"

      - name: Build Scheduler Function App ZIP
        run: |
          echo "ðŸ“¦ Building Scheduler Function App..."
          mkdir -p build/scheduler

          # Copy function app code
          cp -r src/functions/scheduler/* build/scheduler/

          # Copy shared package
          mkdir -p build/scheduler/shared
          cp -r src/shared/* build/scheduler/shared/

          # Copy database tools
          mkdir -p build/scheduler/tools/bin
          cp tools/bin/* build/scheduler/tools/bin/

          # Install Python dependencies
          pip install -r src/shared/requirements.txt -t build/scheduler/.python_packages/lib/site-packages --quiet

          # Create ZIP
          cd build/scheduler
          zip -r ../../scheduler.zip . -x "*.pyc" -x "__pycache__/*"
          cd ../..

          echo "âœ… Scheduler ZIP created: $(du -h scheduler.zip | cut -f1)"

      - name: Build Processor Function App ZIP
        run: |
          echo "ðŸ“¦ Building Processor Function App..."
          mkdir -p build/processor

          # Copy function app code
          cp -r src/functions/processor/* build/processor/

          # Copy shared package
          mkdir -p build/processor/shared
          cp -r src/shared/* build/processor/shared/

          # Copy database tools
          mkdir -p build/processor/tools/bin
          cp tools/bin/* build/processor/tools/bin/

          # Install Python dependencies
          pip install -r src/shared/requirements.txt -t build/processor/.python_packages/lib/site-packages --quiet

          # Create ZIP
          cd build/processor
          zip -r ../../processor.zip . -x "*.pyc" -x "__pycache__/*"
          cd ../..

          echo "âœ… Processor ZIP created: $(du -h processor.zip | cut -f1)"

      # ========================================
      # Create Release
      # ========================================
      - name: Create Release with Assets
        uses: softprops/action-gh-release@v1
        with:
          name: Release ${{ steps.version.outputs.version }}
          body: |
            ## Dilux Database Backup ${{ steps.version.outputs.version }}

            ### Deployment Assets

            | Asset | Description |
            |-------|-------------|
            | `frontend.zip` | React frontend for Static Web App |
            | `api.zip` | API Function App (Python + database tools) |
            | `scheduler.zip` | Scheduler Function App (Python + database tools) |
            | `processor.zip` | Processor Function App (Python + database tools) |

            ### Database Tools Included

            Each Function App ZIP includes:
            - `mysqldump` / `mysql` - MySQL backup and connection testing
            - `pg_dump` / `psql` - PostgreSQL backup and connection testing
            - `sqlcmd` / `bcp` - SQL Server backup and connection testing

            ### Supported Plans

            | Plan | Max DB Size | Monthly Cost |
            |------|-------------|--------------|
            | FC1 (Flex Consumption) | < 1 GB | ~$5-20 |
            | EP1 (Premium) | 1-3 GB | ~$150 |
            | EP2 (Premium) | 3-6 GB | ~$300 |
            | EP3 (Premium) | 6-10 GB | ~$600 |

            ### Deploy to Azure

            ```bash
            curl -sL https://raw.githubusercontent.com/${{ github.repository }}/main/scripts/deploy.sh | bash
            ```

            When prompted for version, enter: `${{ steps.version.outputs.version }}`
          files: |
            frontend.zip
            api.zip
            scheduler.zip
            processor.zip
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Summary
        run: |
          echo "=========================================="
          echo "âœ… Release ${{ steps.version.outputs.version }} created!"
          echo "=========================================="
          echo ""
          echo "Assets:"
          echo "  - frontend.zip  ($(du -h frontend.zip | cut -f1))"
          echo "  - api.zip       ($(du -h api.zip | cut -f1))"
          echo "  - scheduler.zip ($(du -h scheduler.zip | cut -f1))"
          echo "  - processor.zip ($(du -h processor.zip | cut -f1))"
          echo ""
          echo "Database tools included in each ZIP:"
          ls -la tools/bin/
          echo ""
          echo "=========================================="
